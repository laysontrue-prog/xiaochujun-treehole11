# 树洞系统免审核模式及后台增强改造计划

本计划旨在移除树洞发布审核流程，同时增强后台管理能力，确保内容安全和可追溯性。

## 1. 后端改造 (Backend)

### 1.1 数据模型 (Models)
*   **新建 `models/OperationLog.js`**:
    *   用于记录敏感操作（如删除帖子）。
    *   字段：`operatorId` (操作人ID), `operatorName` (操作人昵称), `targetId` (目标ID), `targetType` (类型，如'Post'), `action` (动作，如'delete'), `reason` (原因), `details` (保留原内容备份), `createdAt` (时间)。
*   **新建 `utils/sensitiveFilter.js`**:
    *   实现简单的敏感词检测逻辑。
    *   包含基础敏感词库。
    *   提供 `check(text)` 方法，返回是否包含敏感词。

### 1.2 路由逻辑 (`routes/posts.js`)
*   **修改发布接口 (`POST /`)**:
    *   引入敏感词检测工具。
    *   若包含敏感词，设置 `hasSensitive: true`，但 `status` 仍默认为 `approved`（已发布）。
    *   移除所有"转入审核"的逻辑，实现即发即显。
*   **增强管理员列表接口 (`GET /admin/list`)**:
    *   增加筛选功能：支持 `keyword` (内容搜索), `author` (作者搜索), `startDate` & `endDate` (时间范围)。
    *   返回数据中包含 `hasSensitive` 标记。
*   **新增管理员删除接口 (`DELETE /:id/admin`)**:
    *   **权限验证**: 确保仅管理员/老师可调用。
    *   **日志记录**: 在执行删除前，将操作信息和原帖子内容写入 `OperationLog`。
    *   **状态变更**: 将帖子状态更新为 `deleted` (或直接物理删除，建议使用软删除 `deleted` 以便保留数据)。

### 1.3 数据迁移
*   **新增迁移接口 (`POST /api/posts/migrate-pending`)**:
    *   将数据库中所有 `status: 'pending'` 的旧帖子批量更新为 `status: 'approved'`。

## 2. 前端改造 (Frontend)

### 2.1 用户端 (`public/index.html`)
*   **移除提示**: 删除所有关于"等待审核"的弹窗提示和文案。
*   **样式优化**: 确保新发布的帖子（即使含敏感词）也能正常展示。

### 2.2 管理后台 (`public/admin.html`)
*   **重构界面布局**:
    *   **顶部筛选栏**: 添加关键词、作者、时间范围输入框及"查询"按钮。
    *   **列表展示**: 渲染所有已发布帖子。
    *   **敏感词高亮**: 对 `hasSensitive: true` 的帖子添加明显标识（如红色边框或"敏感"标签）。
*   **删除交互升级**:
    *   点击"删除"按钮 -> 弹出模态框 (Modal)。
    *   要求输入**删除原因** (必填)。
    *   **二次确认**: 再次确认是否执行。
    *   调用后端删除接口并刷新列表。

## 3. 执行步骤

1.  **创建基础设施**: 建立 `OperationLog` 模型和 `sensitiveFilter` 工具。
2.  **后端逻辑更新**: 修改发布、列表、删除接口，实现核心业务逻辑。
3.  **前端界面重构**: 更新管理后台 HTML/CSS/JS，对接新接口。
4.  **数据迁移**: 运行迁移脚本处理旧数据。
5.  **验证测试**: 测试发布直显、敏感词标记、筛选查询、删除日志记录等功能。
