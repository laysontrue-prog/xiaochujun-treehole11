<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯é¢˜è®¨è®º</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .title { text-align: center; font-size: 24px; color: #333; margin: 20px 0; }
    .subtitle { text-align: center; color: #666; margin-bottom: 30px; }

    .topic-card { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .topic-card .left { display: flex; align-items: center; }
    .topic-card .icon { width: 50px; height: 50px; border-radius: 50%; background: #e0f2f1; display: flex; justify-content: center; align-items: center; font-size: 24px; margin-right: 15px; color: #00695c; }
    .topic-card .info h3 { margin: 0; font-size: 18px; color: #333; }
    .topic-card .info p { margin: 5px 0 0; color: #666; font-size: 14px; }
    .topic-card .enter { color: #80cbc4; font-size: 14px; }

    .create-btn { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; cursor: pointer; font-size: 18px; color: #00695c; margin: 30px 0; }

    .bottom-nav {
      background: white;
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      position: fixed;
      bottom: 0;
      width: 100%;
      height: 56px;
      z-index: 100;
    }
    
    .nav-item {
      text-align: center;
      color: #9e9e9e;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      min-width: 56px;
      transition: color 300ms;
      border-radius: 8px;
      text-decoration: none;
    }
    
    .nav-item:hover {
      background: rgba(128, 203, 196, 0.1);
    }
    
    .nav-item.active {
      color: #80cbc4;
    }
    
    .nav-item img {
      width: 24px;
      height: 24px;
      margin-bottom: 4px;
      transition: transform 300ms;
    }
    
    .nav-item.active img {
      transform: scale(1.1);
    }

    /* åˆ†é¡µæŒ‰é’®æ ·å¼ */
    #pagination button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
      color: #666;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    #pagination button:hover:not(:disabled) {
      background: #f5f5f5;
      border-color: #80cbc4;
    }
    
    #pagination button.active {
      background: #80cbc4;
      color: white;
      border-color: #80cbc4;
    }
    
    #pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="top">
<div class="top-left">
  <button style="background:none;border:none;font-size:28px;cursor:pointer;margin-right:10px;" onclick="history.back()">â†</button>
  <span>è¯é¢˜è®¨è®º</span>
</div>
    <div class="top-right">
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
      <button class="switch-btn" onclick="logout()">åˆ‡æ¢è´¦æˆ·</button>
    </div>
  </div>

  <div class="content">
    <h1 class="title">è¯é¢˜è®¨è®º</h1>
    <p class="subtitle">å¯»æ‰¾ä½ çš„åŒé¢‘å…±æŒ¯</p>

    <!-- åŠ¨æ€åŠ è½½æ‰€æœ‰è¯é¢˜ï¼ˆåŒ…æ‹¬å›ºå®š4ä¸ªï¼‰ -->
    <div id="topic-list"></div>

    <!-- åˆ†é¡µæ§ä»¶å®¹å™¨ -->
    <div id="pagination" style="display:flex;justify-content:center;gap:10px;padding:20px 0;">
      <!-- åˆ†é¡µæ§ä»¶å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <!-- åˆ›å»ºæ–°è¯é¢˜æŒ‰é’® -->
    <div class="create-btn" onclick="createTopic()">+ åˆ›å»ºæ–°è¯é¢˜</div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item" onclick="location.href='/'">
      <img src="https://img.icons8.com/color/48/null/leaf.png" alt="å¹¿åœº">
      <div>æ ‘æ´å¹¿åœº</div>
    </div>
    <div class="nav-item active" onclick="location.href='/topic.html'">
      <img src="https://img.icons8.com/color/48/null/speech-bubble.png" alt="è¯é¢˜">
      <div>è¯é¢˜è®¨è®º</div>
    </div>
    <div class="nav-item" onclick="location.href='/tools.html'">
      <img src="https://img.icons8.com/color/48/null/wrench.png" alt="å·¥å…·">
      <div>å®ç”¨å·¥å…·</div>
    </div>
    <div class="nav-item" onclick="location.href='/capsule.html'">
      <img src="https://img.icons8.com/color/48/null/hourglass.png" alt="èƒ¶å›Š">
      <div>æ—¶é—´èƒ¶å›Š</div>
    </div>
    <div class="nav-item" onclick="location.href='/profile.html'">
      <img src="https://img.icons8.com/color/48/null/user.png" alt="æˆ‘çš„">
      <div>æˆ‘çš„</div>
    </div>
  </div>

  <script>
    if (!localStorage.getItem('token')) {
      window.location.href = '/login.html';
    }

    const nickname = localStorage.getItem('nickname') || 'è®¿å®¢';
    if (document.getElementById('nickname')) {
      document.getElementById('nickname').textContent = nickname;
    }

    // åˆå§‹åŒ–å¤´åƒæ˜¾ç¤º
    function initAvatar() {
      const avatarImg = document.getElementById('navAvatar');
      if (!avatarImg) return;
      
      const savedAvatar = localStorage.getItem('avatar');
      if (savedAvatar) {
        avatarImg.src = savedAvatar;
        avatarImg.style.display = 'block';
      } else {
        avatarImg.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${nickname}`;
        avatarImg.style.display = 'block';
      }

      fetch('/api/auth/me', {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      })
      .then(res => res.json())
      .then(data => {
        if (data.avatar) {
          avatarImg.src = data.avatar;
          localStorage.setItem('avatar', data.avatar);
        }
        if (data.nickname) {
          localStorage.setItem('nickname', data.nickname);
          document.getElementById('nickname').textContent = data.nickname;
        }
      })
      .catch(err => console.error('Failed to fetch user info', err));
    }
    
    initAvatar();

    function logout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºæˆ–åˆ‡æ¢è´¦æˆ·å—ï¼Ÿ')) {
        localStorage.removeItem('token');
        localStorage.removeItem('nickname');
        window.location.href = '/login.html';
      }
    }

    // åˆ†é¡µç›¸å…³å˜é‡
    let currentPage = 1;
    let topicsPerPage = 10;
    let totalTopics = 0;
    let allTopics = [];

    // åŠ è½½æ‰€æœ‰è¯é¢˜
    async function loadTopics(page = 1) {
      const list = document.getElementById('topic-list');
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      list.innerHTML = '<p style="text-align:center;color:#80cbc4;">æ­£åœ¨åŠ è½½è¯é¢˜...</p>';
      
      try {
        // å¦‚æœè¿˜æ²¡æœ‰åŠ è½½è¿‡è¯é¢˜ï¼Œå…ˆè·å–æ‰€æœ‰è¯é¢˜
        if (allTopics.length === 0) {
          const res = await fetch('/api/topics');
          if (!res.ok) {
            throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
          }
          const responseData = await res.json();
          
          // å®‰å…¨åœ°å¤„ç†å“åº”æ•°æ®
          if (!responseData) {
            throw new Error('æ— æ•ˆçš„å“åº”æ•°æ®');
          }
          
          allTopics = responseData.topics || [];
          totalTopics = allTopics.length;
        }

        // è®¡ç®—åˆ†é¡µ
        currentPage = page;
        const startIndex = (currentPage - 1) * topicsPerPage;
        const endIndex = startIndex + topicsPerPage;
        const paginatedTopics = allTopics.slice(startIndex, endIndex);

        if (paginatedTopics.length === 0) {
          list.innerHTML = '<p style="text-align:center;color:#999;">æš‚æ— è¯é¢˜ï¼Œæ•¬è¯·æœŸå¾…...</p>';
        } else {
          list.innerHTML = paginatedTopics.map(t => `
            <div class="topic-card" onclick="location.href='/topic-detail.html?id=${t._id}'">
              <div class="left">
                <div class="icon">${t.icon || 'ğŸ’¬'}</div>
                <div class="info">
                  <h3>${t.title} <span class="topic-count">(${t.replies ? t.replies.length : 0}äººè®¨è®º)</span></h3>
                  <p>${t.description || 'æš‚æ— æè¿°'}</p>
                </div>
              </div>
              <div class="enter">è¿›å…¥è®¨è®º â†’</div>
            </div>
          `).join('');
        }

        // ç”Ÿæˆåˆ†é¡µæ§ä»¶
        generatePagination();
      } catch (err) {
        console.log('åŠ è½½è¯é¢˜å¤±è´¥', err);
        list.innerHTML = `<p style="text-align:center;color:#ff8a80;">åŠ è½½è¯é¢˜å¤±è´¥ï¼š${err.message}ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>`;
      }
    }

    // ç”Ÿæˆåˆ†é¡µæ§ä»¶
    function generatePagination() {
      const totalPages = Math.ceil(totalTopics / topicsPerPage);
      const paginationContainer = document.getElementById('pagination');
      
      // æ¸…ç©ºç°æœ‰åˆ†é¡µæ§ä»¶
      paginationContainer.innerHTML = '';
      
      // é¦–é¡µæŒ‰é’®
      const firstPageBtn = document.createElement('button');
      firstPageBtn.textContent = 'é¦–é¡µ';
      firstPageBtn.disabled = currentPage === 1;
      firstPageBtn.onclick = () => loadTopics(1);
      paginationContainer.appendChild(firstPageBtn);
      
      // ä¸Šä¸€é¡µæŒ‰é’®
      const prevPageBtn = document.createElement('button');
      prevPageBtn.textContent = 'ä¸Šä¸€é¡µ';
      prevPageBtn.disabled = currentPage === 1;
      prevPageBtn.onclick = () => loadTopics(currentPage - 1);
      paginationContainer.appendChild(prevPageBtn);
      
      // é¡µç æŒ‰é’®
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);
      
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className = i === currentPage ? 'active' : '';
        pageBtn.onclick = () => loadTopics(i);
        paginationContainer.appendChild(pageBtn);
      }
      
      // ä¸‹ä¸€é¡µæŒ‰é’®
      const nextPageBtn = document.createElement('button');
      nextPageBtn.textContent = 'ä¸‹ä¸€é¡µ';
      nextPageBtn.disabled = currentPage === totalPages;
      nextPageBtn.onclick = () => loadTopics(currentPage + 1);
      paginationContainer.appendChild(nextPageBtn);
      
      // æœ«é¡µæŒ‰é’®
      const lastPageBtn = document.createElement('button');
      lastPageBtn.textContent = 'æœ«é¡µ';
      lastPageBtn.disabled = currentPage === totalPages;
      lastPageBtn.onclick = () => loadTopics(totalPages);
      paginationContainer.appendChild(lastPageBtn);
    }

    // åˆ›å»ºæ–°è¯é¢˜
    async function createTopic() {
      const title = prompt('æ–°è¯é¢˜æ ‡é¢˜ï¼š');
      if (!title) return;
      const description = prompt('è¯é¢˜æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š');
      const icon = prompt('å°å›¾æ ‡ï¼ˆemojiï¼Œæ¯”å¦‚ğŸ’¬ï¼‰ï¼š', 'ğŸ’¬');

      try {
        await fetch('/api/topics', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ title, description, icon })
        });
        alert('åˆ›å»ºæˆåŠŸï¼');
        loadTopics();
      } catch (err) {
        alert('åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    loadTopics();
  </script>
</body>
</html>