<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€šçŸ¥ä¸­å¿ƒ</title>
  <style>
    body { margin: 0; padding: 0; background: #f7fafc; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; min-height: 100vh; display: flex; flex-direction: column; color: #2d3748; }
    .top { padding: 15px 20px; background: #fff; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
    .top-left { display: flex; align-items: center; }
    .top-left button { background:none; border:none; font-size:24px; cursor:pointer; margin-right:10px; color: #4a5568; }
    .top-center { font-weight: bold; font-size: 18px; }
    .top-right button { background: none; border: none; color: #80cbc4; font-size: 14px; cursor: pointer; }

    .tabs { display: flex; background: #fff; padding: 0 10px; border-bottom: 1px solid #edf2f7; position: sticky; top: 60px; z-index: 99; }
    .tab { flex: 1; text-align: center; padding: 15px 0; cursor: pointer; font-size: 14px; color: #718096; position: relative; }
    .tab.active { color: #80cbc4; font-weight: 600; }
    .tab.active::after { content: ''; position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background: #80cbc4; border-radius: 3px 3px 0 0; }

    .content { flex: 1; padding: 0; overflow-y: auto; }
    
    .notification-list { list-style: none; padding: 0; margin: 0; }
    .notification-item { padding: 20px; background: #fff; border-bottom: 1px solid #edf2f7; display: flex; gap: 15px; cursor: pointer; transition: background 0.2s; }
    .notification-item:hover { background: #f7fafc; }
    .notification-item.unread { background: #f0fff4; }
    
    .icon-box { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
    .icon-post { background: #e6fffa; color: #38b2ac; }
    .icon-reply { background: #ebf8ff; color: #4299e1; }
    .icon-like { background: #fff5f5; color: #f56565; }
    .icon-mention { background: #faf5ff; color: #9f7aea; }
    .icon-system { background: #edf2f7; color: #718096; }

    .info { flex: 1; }
    .info-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .sender { font-weight: 600; font-size: 15px; color: #2d3748; }
    .time { font-size: 12px; color: #a0aec0; }
    .text { font-size: 14px; color: #4a5568; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .quote { margin-top: 8px; padding: 8px 12px; background: #f7fafc; border-radius: 8px; font-size: 13px; color: #718096; border-left: 3px solid #cbd5e0; }

    .loading, .empty { text-align: center; padding: 30px; color: #a0aec0; font-size: 14px; }
    .load-more { text-align: center; padding: 15px; color: #80cbc4; cursor: pointer; font-size: 14px; }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 480px) {
      .notification-item { padding: 15px; }
      .icon-box { width: 36px; height: 36px; font-size: 18px; }
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="top-left">
      <button onclick="history.back()">â†</button>
    </div>
    <div class="top-center">é€šçŸ¥ä¸­å¿ƒ</div>
    <div class="top-right">
      <button onclick="markAllRead()">å…¨éƒ¨å·²è¯»</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('all')">å…¨éƒ¨</div>
    <div class="tab" onclick="switchTab('unread')">æœªè¯»</div>
    <div class="tab" onclick="switchTab('reply')">å›å¤</div>
    <div class="tab" onclick="switchTab('mention')">@æˆ‘</div>
    <div class="tab" onclick="switchTab('system')">ç³»ç»Ÿ</div>
  </div>

  <div class="content" id="scrollContainer">
    <div id="list" class="notification-list"></div>
    <div id="loading" class="loading" style="display: none;">åŠ è½½ä¸­...</div>
    <div id="loadMore" class="load-more" style="display: none;" onclick="loadMore()">ç‚¹å‡»åŠ è½½æ›´å¤š</div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let currentPage = 1;
    let currentFilter = 'all';
    let isLoading = false;
    let hasMore = true;
    let socket;

    // åˆå§‹åŒ– Socket.IO
    function initSocket() {
      const token = localStorage.getItem('token');
      if (!token) return;

      // è§£æ token è·å– userId (ç®€å•è§£æï¼Œå®é™…åº”ä½¿ç”¨åº“)
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        const payload = JSON.parse(jsonPayload);
        const userId = payload.userId;

        socket = io();
        socket.on('connect', () => {
          console.log('Socket connected');
          socket.emit('register', userId);
        });

        socket.on('notification', (notification) => {
          console.log('New notification:', notification);
          // å¦‚æœåœ¨"å…¨éƒ¨"æˆ–å¯¹åº”ç±»å‹çš„æ ‡ç­¾ä¸‹ï¼Œç›´æ¥æ’å…¥é¡¶éƒ¨
          if (currentFilter === 'all' || currentFilter === 'unread' || currentFilter === notification.type) {
            prependNotification(notification);
          }
          // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¨å±€çº¢ç‚¹æç¤ºé€»è¾‘
        });
        
        // ç›‘å¬å¹¿æ’­é€šçŸ¥ï¼ˆæ–°å¸–å­ç­‰ï¼‰
        socket.on('notification_broadcast', (data) => {
          // æ’é™¤è‡ªå·±
          if (data.excludeUserId === userId) return;
          
          console.log('Broadcast notification:', data);
          // æ„é€ æˆ notification å¯¹è±¡
          const notification = {
            ...data,
            read: false,
            createdAt: new Date()
          };
          
          if (currentFilter === 'all' || currentFilter === 'unread' || currentFilter === data.type) {
            prependNotification(notification);
          }
        });

      } catch (e) {
        console.error('Socket init error:', e);
      }
    }

    // åˆ‡æ¢æ ‡ç­¾
    function switchTab(type) {
      if (currentFilter === type) return;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      currentFilter = type;
      currentPage = 1;
      hasMore = true;
      document.getElementById('list').innerHTML = '';
      loadNotifications();
    }

    // åŠ è½½é€šçŸ¥
    async function loadNotifications() {
      if (isLoading || !hasMore) return;
      isLoading = true;
      document.getElementById('loading').style.display = 'block';
      document.getElementById('loadMore').style.display = 'none';

      try {
        const token = localStorage.getItem('token');
        let url = `/api/notifications?page=${currentPage}&limit=10`;
        if (currentFilter !== 'all') {
          url += `&type=${currentFilter}`;
        }

        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();

        if (data.notifications.length === 0) {
          hasMore = false;
          if (currentPage === 1) {
            document.getElementById('list').innerHTML = '<div class="empty">æš‚æ— é€šçŸ¥</div>';
          }
        } else {
          renderNotifications(data.notifications);
          if (currentPage >= data.totalPages) {
            hasMore = false;
          } else {
            document.getElementById('loadMore').style.display = 'block';
          }
        }
      } catch (err) {
        console.error(err);
        document.getElementById('list').innerHTML = '<div class="empty">åŠ è½½å¤±è´¥</div>';
      } finally {
        isLoading = false;
        document.getElementById('loading').style.display = 'none';
      }
    }

    // æ¸²æŸ“åˆ—è¡¨
    function renderNotifications(list) {
      const container = document.getElementById('list');
      list.forEach(n => {
        container.appendChild(createNotificationElement(n));
      });
    }

    // æ’å…¥æ–°é€šçŸ¥åˆ°é¡¶éƒ¨
    function prependNotification(n) {
      const container = document.getElementById('list');
      // å¦‚æœæ˜¾ç¤º"æš‚æ— é€šçŸ¥"ï¼Œå…ˆæ¸…ç©º
      if (container.querySelector('.empty')) {
        container.innerHTML = '';
      }
      container.insertBefore(createNotificationElement(n), container.firstChild);
    }

    // åˆ›å»ºé€šçŸ¥DOM
    function createNotificationElement(n) {
      const div = document.createElement('div');
      div.className = `notification-item ${n.read ? '' : 'unread'}`;
      div.onclick = () => handleClick(n);

      let iconClass = 'icon-system';
      let iconText = 'ğŸ””';
      let detailText = '';

      switch (n.type) {
        case 'post': iconClass = 'icon-post'; iconText = 'ğŸ“'; break;
        case 'reply': iconClass = 'icon-reply'; iconText = 'ğŸ’¬'; break;
        case 'like': iconClass = 'icon-like'; iconText = 'â¤ï¸'; break;
        case 'mention': iconClass = 'icon-mention'; iconText = '@'; break;
        case 'capsule': iconClass = 'icon-system'; iconText = 'ğŸ’Š'; break;
      }

      if (n.detail) {
        if (n.detail.postContent) detailText = n.detail.postContent;
        else if (n.detail.replyContent) detailText = n.detail.replyContent;
        else if (n.detail.mentionedIn) detailText = n.detail.mentionedIn;
        else if (n.detail.capsuleContent) detailText = n.detail.capsuleContent;
      }

      const timeStr = formatTime(n.createdAt);

      div.innerHTML = `
        <div class="icon-box ${iconClass}">${iconText}</div>
        <div class="info">
          <div class="info-header">
            <span class="sender">${n.senderName || 'ç³»ç»Ÿé€šçŸ¥'}</span>
            <span class="time">${timeStr}</span>
          </div>
          <div class="text">${n.content}</div>
          ${detailText ? `<div class="quote">${detailText}</div>` : ''}
        </div>
      `;
      return div;
    }

    // å¤„ç†ç‚¹å‡»
    async function handleClick(n) {
      // 1. æ ‡è®°å·²è¯»
      if (!n.read) {
        try {
          const token = localStorage.getItem('token');
          await fetch(`/api/notifications/${n._id}/read`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          // æ›´æ–°UI
          // é‡æ–°åŠ è½½æˆ–è€…ç›´æ¥ä¿®æ”¹æ ·å¼
          // è¿™é‡Œä¸ºäº†ç®€å•ç›´æ¥è·³è½¬ï¼Œä½†æœ€å¥½æ›´æ–°æ ·å¼
        } catch (e) {
          console.error(e);
        }
      }

      // 2. è·³è½¬
      if (n.relatedId) {
        // æ ¹æ®ç±»å‹è·³è½¬ä¸åŒé¡µé¢
        // è¿™é‡Œå‡è®¾éƒ½æ˜¯è·³è½¬åˆ°é¦–é¡µå¹¶å±•å¼€ï¼Œæˆ–è€…æœ‰è¯¦æƒ…é¡µ
        // ç›®å‰é¡¹ç›®ç»“æ„ä¸»è¦æ˜¯å•é¡µåº”ç”¨æ¨¡å¼ï¼Œæˆ–è€…è·³è½¬åˆ° topic-detail.html
        // ç®€å•å¤„ç†ï¼šè·³è½¬åˆ°é¦–é¡µå¹¶å¸¦ä¸Š highlight å‚æ•°
        // å¦‚æœæœ‰ topic.html, capsule.html ç­‰ï¼Œéœ€è¦åŒºåˆ†
        if (n.type === 'capsule') {
          window.location.href = '/capsule.html';
        } else {
          // å¸–å­ç›¸å…³
          // ç†æƒ³æƒ…å†µï¼š/post-detail.html?id=xxx
          // ç°çŠ¶ï¼šé¦–é¡µ index.html æ˜¯åˆ—è¡¨
          // æˆ‘ä»¬è·³è½¬åˆ° index.html å¹¶å°è¯•å®šä½ï¼ˆéœ€è¦ index.html æ”¯æŒï¼‰
          // æˆ–è€…ç®€å•çš„ alert æç¤º "è¯·åœ¨é¦–é¡µæŸ¥çœ‹"
          // ä¸ºäº†æ›´å¥½çš„ä½“éªŒï¼Œæˆ‘ä»¬å‡è®¾å¯ä»¥è·³è½¬åˆ°é¦–é¡µ
          window.location.href = `/?highlight=${n.relatedId}`;
        }
      }
    }

    // å…¨éƒ¨å·²è¯»
    async function markAllRead() {
      if (!confirm('ç¡®å®šå°†æ‰€æœ‰é€šçŸ¥æ ‡è®°ä¸ºå·²è¯»ï¼Ÿ')) return;
      try {
        const token = localStorage.getItem('token');
        await fetch('/api/notifications/read-all', {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        // åˆ·æ–°åˆ—è¡¨
        currentPage = 1;
        document.getElementById('list').innerHTML = '';
        loadNotifications();
      } catch (e) {
        alert('æ“ä½œå¤±è´¥');
      }
    }

    function loadMore() {
      currentPage++;
      loadNotifications();
    }

    // æ—¶é—´æ ¼å¼åŒ–
    function formatTime(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = (now - date) / 1000; // seconds

      if (diff < 60) return 'åˆšåˆš';
      if (diff < 3600) return Math.floor(diff / 60) + 'åˆ†é’Ÿå‰';
      if (diff < 86400) return Math.floor(diff / 3600) + 'å°æ—¶å‰';
      if (diff < 2592000) return Math.floor(diff / 86400) + 'å¤©å‰';
      return date.toLocaleDateString();
    }

    // å¯åŠ¨
    initSocket();
    loadNotifications();

    // æ»šåŠ¨åŠ è½½
    document.getElementById('scrollContainer').addEventListener('scroll', (e) => {
      const { scrollTop, scrollHeight, clientHeight } = e.target;
      if (scrollTop + clientHeight >= scrollHeight - 50) {
        loadNotifications();
      }
    });
  </script>
</body>
</html>
