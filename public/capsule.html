<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—¶é—´èƒ¶å›Š</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* ä¿æŒä½ è§‰å¾—å¥½çœ‹çš„æ ·å¼ï¼ŒåŸå°ä¸åŠ¨ */
    :root { --primary-color: #00695c; --accent-color: #80cbc4; }
    
    .title { text-align: center; font-size: 24px; margin: 20px 0 5px; color: var(--primary-color); }
    .subtitle { text-align: center; color: #888; font-size: 14px; margin-bottom: 25px; }
    
    .capsule-box { background: #fff; padding: 25px; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.04); margin-bottom: 30px; border: 1px solid #f0f0f0; }
    .time-options { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .time-btn { padding: 10px 18px; border-radius: 20px; border: 1px solid #eee; background: #fff; cursor: pointer; font-size: 14px; color: #666; transition: 0.3s; }
    .time-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); font-weight: bold; }
    
    .custom-date { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 12px; font-size: 14px; margin-bottom: 15px; box-sizing: border-box; text-align: center; display: none; }
    .capsule-textarea { width: 100%; height: 180px; padding: 18px; border: 1px solid #eee; border-radius: 18px; font-size: 15px; resize: none; box-sizing: border-box; background: #fafafa; line-height: 1.6; outline: none; }
    .capsule-button { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 12px rgba(0,105,92,0.2); }
    
    .my-capsules h3 { text-align: center; font-size: 18px; color: #444; margin-bottom: 20px; }
    .capsule-card { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 15px; border: 1px solid #f0f0f0; position: relative; }
    .card-status { font-size: 12px; padding: 4px 10px; border-radius: 10px; display: inline-block; margin-bottom: 12px; }
    .status-locked { background: #f5f5f5; color: #999; }
    .status-open { background: #e0f2f1; color: var(--primary-color); }
    .card-content { font-size: 15px; line-height: 1.6; color: #444; margin: 0 0 12px; }
    .card-time { font-size: 11px; color: #bbb; display: flex; justify-content: space-between; }
    
    .bottom-nav {
      background: white;
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      position: fixed;
      bottom: 0;
      width: 100%;
      height: 56px;
      z-index: 100;
    }
    
    .nav-item {
      text-align: center;
      color: #9e9e9e;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      min-width: 56px;
      transition: color 300ms;
      border-radius: 8px;
      text-decoration: none;
    }
    
    .nav-item:hover {
      background: rgba(128, 203, 196, 0.1);
    }
    
    .nav-item.active {
      color: #80cbc4;
    }
    
    .nav-item img {
      width: 24px;
      height: 24px;
      margin-bottom: 4px;
      transition: transform 300ms;
    }
    
    .nav-item.active img {
      transform: scale(1.1);
    }

    /* åˆ†é¡µæŒ‰é’®æ ·å¼ */
    #pagination button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
      color: #666;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    #pagination button:hover:not(:disabled) {
      background: #f5f5f5;
      border-color: var(--accent-color);
    }
    
    #pagination button.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }
    
    #pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="top-left">
      <span>æ—¶é—´èƒ¶å›Š</span>
    </div>
    <div class="top-right">
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
      <button class="switch-btn" onclick="logout()">åˆ‡æ¢è´¦æˆ·</button>
    </div>
  </div>

  <div class="content">
    <h1 class="title">æ—¶é—´èƒ¶å›Š</h1>
    <p class="subtitle">ç»™æœªæ¥çš„è‡ªå·±å†™å°ä¿¡</p>
    <div class="capsule-box">
      <div class="time-options">
        <button class="time-btn active" data-months="6">åŠå¹´å</button>
        <button class="time-btn" data-months="12">ä¸€å¹´å</button>
        <button class="time-btn" data-months="48">å››å¹´å</button>
        <button class="time-btn" data-custom="true">è‡ªå®šä¹‰æ—¥æœŸ</button>
      </div>
      <input type="date" id="custom-unlock-date" class="custom-date">
      <textarea class="capsule-textarea" id="capsule-content" placeholder="äº²çˆ±çš„æœªæ¥è‡ªå·±..."></textarea>
      <button class="capsule-button" onclick="buryCapsule()">å¯†å°å¹¶åŸ‹ä¸‹</button>
    </div>
    <div class="my-capsules"><h3>æˆ‘çš„æ—¶é—´èƒ¶å›Š</h3><div id="my-capsules-list"></div></div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item" onclick="location.href='/'">
      <img src="https://img.icons8.com/color/48/null/leaf.png" alt="å¹¿åœº">
      <div>æ ‘æ´å¹¿åœº</div>
    </div>
    <div class="nav-item" onclick="location.href='/topic.html'">
      <img src="https://img.icons8.com/color/48/null/speech-bubble.png" alt="è¯é¢˜">
      <div>è¯é¢˜è®¨è®º</div>
    </div>
    <div class="nav-item" onclick="location.href='/tools.html'">
      <img src="https://img.icons8.com/color/48/null/wrench.png" alt="å·¥å…·">
      <div>å®ç”¨å·¥å…·</div>
    </div>
    <div class="nav-item active" onclick="location.href='/capsule.html'">
      <img src="https://img.icons8.com/color/48/null/hourglass.png" alt="èƒ¶å›Š">
      <div>æ—¶é—´èƒ¶å›Š</div>
    </div>
    <div class="nav-item" onclick="location.href='/profile.html'">
      <img src="https://img.icons8.com/color/48/null/user.png" alt="æˆ‘çš„">
      <div>æˆ‘çš„</div>
    </div>
  </div>

  <script>
    // åŠ¨æ€è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
    function getUserInfo() {
      return {
        token: localStorage.getItem('token'),
        nickname: localStorage.getItem('nickname') || ''
      };
    }
    
    // æ˜¾ç¤ºåå­—
    const { nickname: initialNickname } = getUserInfo();
    if (document.getElementById('nickname')) {
      document.getElementById('nickname').textContent = initialNickname || 'è®¿å®¢';
    }

    // 2. æ ¸å¿ƒï¼šåˆ¤æ–­æ˜¯å¦ä¸ºè®¿å®¢çš„å‡½æ•°
    function checkIsVisitor() {
        const { token, nickname } = getUserInfo();
        if (!token || !nickname || nickname.indexOf('è®¿å®¢') !== -1) {
            return true;
        }
        return false;
    }

    // ... é€€å‡ºç™»å½•é€»è¾‘ä¿æŒä¸å˜ ...

    // 3. åŸ‹ä¸‹èƒ¶å›Š
    async function buryCapsule() {
        const { token, nickname } = getUserInfo();
        if (checkIsVisitor()) {
            alert('âŒ æ— æ³•å‘å¸ƒ\n\nè®¿å®¢æ¨¡å¼ä¸èƒ½åŸ‹ä¸‹æ—¶é—´èƒ¶å›Šã€‚');
            return;
        }

        const content = document.getElementById('capsule-content').value.trim();
        if (!content) return alert('è¯·å†™ç‚¹å†…å®¹å†åŸ‹å“¦ï½');

        const activeBtn = document.querySelector('.time-btn.active');
        let unlockDate = new Date();
        
        if (activeBtn.dataset.custom === "true") {
            const val = document.getElementById('custom-unlock-date').value;
            if (!val) return alert('è¯·é€‰æ‹©æ—¥æœŸ');
            unlockDate = new Date(val);
        } else {
            unlockDate.setMonth(unlockDate.getMonth() + parseInt(activeBtn.dataset.months));
        }

        try {
            const res = await fetch('/api/capsules', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ content, unlockDate })
            });
            
            if (res.ok) {
                alert('âœ¨ èƒ¶å›Šå·²åŸ‹ä¸‹ï¼');
                document.getElementById('capsule-content').value = '';
                loadMyCapsules(1); // å¼ºåˆ¶åˆ·æ–°ç¬¬ä¸€é¡µ
            } else {
                alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } catch (e) {
            alert('ç½‘ç»œé”™è¯¯');
        }
    }

    // åˆ†é¡µç›¸å…³å˜é‡
    let currentPage = 1;
    let capsulesPerPage = 5;
    let totalCapsules = 0;
    let allCapsules = [];

    // 4. åŠ è½½åˆ—è¡¨
    async function loadMyCapsules(page = 1) {
        const { token } = getUserInfo();
        const listDiv = document.getElementById('my-capsules-list');
        
        if (checkIsVisitor()) {
            listDiv.innerHTML = '<p style="text-align:center;color:#999;font-size:14px;padding:20px;">ç™»å½•åå¯æŸ¥çœ‹æ‚¨çš„ä¸“å±èƒ¶å›Š</p>';
            return;
        }

        try {
            if (page === 1) listDiv.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">æ­£åœ¨ç©¿è¶Šæ—¶ç©ºåŠ è½½èƒ¶å›Š...</p>';

            const res = await fetch('/api/capsules/my', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (res.status === 401) {
                listDiv.innerHTML = '<p style="text-align:center;color:#e57373;padding:20px;">èº«ä»½ä¿¡æ¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•</p>';
                setTimeout(() => window.location.href = '/login.html', 2000);
                return;
            }

            if (!res.ok) {
                const errData = await res.json();
                throw new Error(errData.message || 'æœåŠ¡å™¨å“åº”é”™è¯¯');
            }
            
            allCapsules = await res.json();
            totalCapsules = allCapsules.length;
            currentPage = page;

            if (totalCapsules === 0) {
                listDiv.innerHTML = '<p style="text-align:center;color:#999;font-size:14px;padding:20px;">è¿˜æ²¡æœ‰åŸ‹ä¸‹è¿‡èƒ¶å›Šå“¦...</p>';
                if (document.getElementById('pagination')) document.getElementById('pagination').innerHTML = '';
                return;
            }

            const startIndex = (currentPage - 1) * capsulesPerPage;
            const paginatedCapsules = allCapsules.slice(startIndex, startIndex + capsulesPerPage);
            
            const now = new Date();
            listDiv.innerHTML = paginatedCapsules.map(c => {
                const unlockTime = new Date(c.unlockDate);
                const isUnlocked = c.isUnlocked || unlockTime <= now;
                return `
                <div class="capsule-card">
                    <span class="card-status ${isUnlocked ? 'status-open' : 'status-locked'}">
                        ${isUnlocked ? 'âœ… å·²å¼€å¯' : 'ğŸ”’ å°å­˜ä¸­'}
                    </span>
                    <p class="card-content">${isUnlocked ? c.content : 'ğŸ”’ è¿™æ˜¯ä¸€ä¸ªå¯†å°çš„æœªæ¥ä¿¡æ¯...'}</p>
                    <div class="card-time">
                        <span>åˆ›å»º: ${new Date(c.createdAt).toLocaleDateString()}</span>
                        <span>è§£å°: ${unlockTime.toLocaleDateString()}</span>
                    </div>
                </div>`;
            }).join('');

            generatePagination();
        } catch (e) {
            console.error('[Frontend Capsule Load Error]:', e);
            listDiv.innerHTML = `
                <div style="text-align:center;padding:20px;">
                    <p style="color:#e57373;margin-bottom:10px;">ğŸ›¸ åŠ è½½å¤±è´¥: ${e.message}</p>
                    <button onclick="loadMyCapsules(1)" style="padding:8px 16px;background:var(--primary-color);color:white;border:none;border-radius:20px;cursor:pointer;">ç‚¹æ­¤é‡è¯•</button>
                </div>
            `;
        }
    }

    // ç”Ÿæˆåˆ†é¡µæ§ä»¶
    function generatePagination() {
        const totalPages = Math.ceil(totalCapsules / capsulesPerPage);
        let paginationContainer = document.getElementById('pagination');
        
        // å…³é”®ä¿®å¤ï¼šå¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºå¹¶æ­£ç¡®èµ‹å€¼ç»™å˜é‡
        if (!paginationContainer) {
            const myCapsulesDiv = document.querySelector('.my-capsules');
            if (!myCapsulesDiv) return; // å®‰å…¨æ£€æŸ¥
            
            paginationContainer = document.createElement('div');
            paginationContainer.id = 'pagination';
            paginationContainer.style.cssText = 'display:flex;justify-content:center;gap:10px;padding:20px 0;';
            myCapsulesDiv.appendChild(paginationContainer);
        }
        
        // ç°åœ¨ paginationContainer ç»å¯¹ä¸æ˜¯ null
        paginationContainer.innerHTML = '';
        
        // é¦–é¡µæŒ‰é’®
        const firstPageBtn = document.createElement('button');
        firstPageBtn.textContent = 'é¦–é¡µ';
        firstPageBtn.disabled = currentPage === 1;
        firstPageBtn.onclick = () => loadMyCapsules(1);
        paginationContainer.appendChild(firstPageBtn);
        
        // ä¸Šä¸€é¡µæŒ‰é’®
        const prevPageBtn = document.createElement('button');
        prevPageBtn.textContent = 'ä¸Šä¸€é¡µ';
        prevPageBtn.disabled = currentPage === 1;
        prevPageBtn.onclick = () => loadMyCapsules(currentPage - 1);
        paginationContainer.appendChild(prevPageBtn);
        
        // é¡µç æŒ‰é’®
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = i;
            pageBtn.className = i === currentPage ? 'active' : '';
            pageBtn.onclick = () => loadMyCapsules(i);
            paginationContainer.appendChild(pageBtn);
        }
        
        // ä¸‹ä¸€é¡µæŒ‰é’®
        const nextPageBtn = document.createElement('button');
        nextPageBtn.textContent = 'ä¸‹ä¸€é¡µ';
        nextPageBtn.disabled = currentPage === totalPages;
        nextPageBtn.onclick = () => loadMyCapsules(currentPage + 1);
        paginationContainer.appendChild(nextPageBtn);
        
        // æœ«é¡µæŒ‰é’®
        const lastPageBtn = document.createElement('button');
        lastPageBtn.textContent = 'æœ«é¡µ';
        lastPageBtn.disabled = currentPage === totalPages;
        lastPageBtn.onclick = () => loadMyCapsules(totalPages);
        paginationContainer.appendChild(lastPageBtn);
    }

    // 5. æŒ‰é’®åˆ‡æ¢é€»è¾‘
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('custom-unlock-date').style.display = (btn.dataset.custom === "true") ? 'block' : 'none';
        };
    });

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡
    window.addEventListener('DOMContentLoaded', () => {
        loadMyCapsules();
    });
  </script>
</body>
</html>