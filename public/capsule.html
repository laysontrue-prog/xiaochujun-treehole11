<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°æ¥šå›çš„æ ‘æ´ - æ—¶é—´èƒ¶å›Š</title>
  <style>
    /* ä¿æŒä½ è§‰å¾—å¥½çœ‹çš„æ ·å¼ï¼ŒåŸå°ä¸åŠ¨ */
    :root { --primary-color: #00695c; --accent-color: #80cbc4; }
    body { margin: 0; padding: 0; background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; min-height: 100vh; display: flex; flex-direction: column; color: #2d3748; }
    
    .top { padding: 15px 20px; background: #fff; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .top-left { display: flex; align-items: center; font-weight: bold; }
    .top-left img { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; }
    .top-right { color: #888; font-size: 13px; display: flex; align-items: center; gap: 8px; }
    .btn-small { padding: 6px 12px; border: none; border-radius: 15px; cursor: pointer; font-size: 11px; transition: 0.3s; }
    .logout-btn { background: #ffebee; color: #ff8a80; }
    
    .content { flex: 1; padding: 20px; max-width: 600px; margin: 0 auto; width: 100%; box-sizing: border-box; padding-bottom: 100px; }
    .title { text-align: center; font-size: 24px; margin: 20px 0 5px; color: var(--primary-color); }
    .subtitle { text-align: center; color: #888; font-size: 14px; margin-bottom: 25px; }
    
    .capsule-box { background: #fff; padding: 25px; border-radius: 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.04); margin-bottom: 30px; border: 1px solid #f0f0f0; }
    .time-options { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .time-btn { padding: 10px 18px; border-radius: 20px; border: 1px solid #eee; background: #fff; cursor: pointer; font-size: 14px; color: #666; transition: 0.3s; }
    .time-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); font-weight: bold; }
    
    .custom-date { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 12px; font-size: 14px; margin-bottom: 15px; box-sizing: border-box; text-align: center; display: none; }
    .capsule-textarea { width: 100%; height: 180px; padding: 18px; border: 1px solid #eee; border-radius: 18px; font-size: 15px; resize: none; box-sizing: border-box; background: #fafafa; line-height: 1.6; outline: none; }
    .capsule-button { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 12px rgba(0,105,92,0.2); }
    
    .my-capsules h3 { text-align: center; font-size: 18px; color: #444; margin-bottom: 20px; }
    .capsule-card { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 15px; border: 1px solid #f0f0f0; position: relative; }
    .card-status { font-size: 12px; padding: 4px 10px; border-radius: 10px; display: inline-block; margin-bottom: 12px; }
    .status-locked { background: #f5f5f5; color: #999; }
    .status-open { background: #e0f2f1; color: var(--primary-color); }
    .card-content { font-size: 15px; line-height: 1.6; color: #444; margin: 0 0 12px; }
    .card-time { font-size: 11px; color: #bbb; display: flex; justify-content: space-between; }
    
    .bottom-nav { background: #fff; display: flex; justify-content: space-around; padding: 10px 0 25px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); position: fixed; bottom: 0; width: 100%; }
    .nav-item { text-align: center; color: #bbb; font-size: 11px; cursor: pointer; text-decoration: none; }
    .nav-item.active { color: var(--accent-color); }
    .nav-icon { font-size: 22px; display: block; margin-bottom: 2px; }

    /* åˆ†é¡µæŒ‰é’®æ ·å¼ */
    #pagination button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
      color: #666;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    #pagination button:hover:not(:disabled) {
      background: #f5f5f5;
      border-color: var(--accent-color);
    }
    
    #pagination button.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }
    
    #pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="top-left"><img src="logo.png" alt="Logo"><span>å°æ¥šå›çš„æ ‘æ´</span></div>
    <div class="top-right"><span id="nickname">...</span><button class="btn-small logout-btn" onclick="logout()">é€€å‡º</button></div>
  </div>

  <div class="content">
    <h1 class="title">æ—¶é—´èƒ¶å›Š</h1>
    <p class="subtitle">ç»™æœªæ¥çš„è‡ªå·±å†™å°ä¿¡</p>
    <div class="capsule-box">
      <div class="time-options">
        <button class="time-btn active" data-months="6">åŠå¹´å</button>
        <button class="time-btn" data-months="12">ä¸€å¹´å</button>
        <button class="time-btn" data-months="48">å››å¹´å</button>
        <button class="time-btn" data-custom="true">è‡ªå®šä¹‰æ—¥æœŸ</button>
      </div>
      <input type="date" id="custom-unlock-date" class="custom-date">
      <textarea class="capsule-textarea" id="capsule-content" placeholder="äº²çˆ±çš„æœªæ¥è‡ªå·±..."></textarea>
      <button class="capsule-button" onclick="buryCapsule()">å¯†å°å¹¶åŸ‹ä¸‹</button>
    </div>
    <div class="my-capsules"><h3>æˆ‘çš„æ—¶é—´èƒ¶å›Š</h3><div id="my-capsules-list"></div></div>
  </div>

  <nav class="bottom-nav">
    <a href="/" class="nav-item"><span class="nav-icon">ğŸƒ</span>æ ‘æ´å¹¿åœº</a>
    <a href="/topic.html" class="nav-item"><span class="nav-icon">ğŸ’¬</span>è¯é¢˜è®¨è®º</a>
    <a href="/capsule.html" class="nav-item active"><span class="nav-icon">â³</span>æ—¶é—´èƒ¶å›Š</a>
    <a href="/profile.html" class="nav-item"><span class="nav-icon">ğŸ‘¤</span>æˆ‘çš„</a>
  </nav>

  <script>
    // 1. è·å–ç”¨æˆ·ä¿¡æ¯
    const token = localStorage.getItem('token');
    // å¦‚æœæ²¡æœ‰åå­—ï¼Œå°±é»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œé˜²æ­¢æŠ¥é”™
    const nickname = localStorage.getItem('nickname') || ''; 
    
    // æ˜¾ç¤ºåå­—ï¼Œå¦‚æœæ˜¯ç©ºå°±æ˜¾ç¤ºâ€œè®¿å®¢â€
    document.getElementById('nickname').textContent = nickname || 'è®¿å®¢';

    // 2. æ ¸å¿ƒï¼šåˆ¤æ–­æ˜¯å¦ä¸ºè®¿å®¢çš„å‡½æ•°
    function checkIsVisitor() {
        // æ¡ä»¶ï¼šæ²¡æœ‰tokenï¼Œæˆ–è€… åå­—ä¸ºç©ºï¼Œæˆ–è€… åå­—é‡ŒåŒ…å«â€œè®¿å®¢â€è¿™ä¸¤ä¸ªå­—ï¼ˆè§£å†³äº†è®¿å®¢8806çš„é—®é¢˜ï¼‰
        if (!token || !nickname || nickname.indexOf('è®¿å®¢') !== -1) {
            return true; // æ˜¯è®¿å®¢
        }
        return false; // æ˜¯æ­£å¼ç”¨æˆ·
    }

    // é€€å‡ºç™»å½•
    function logout() {
        if(confirm('ç¡®å®šé€€å‡ºå—ï¼Ÿ')) {
            localStorage.clear();
            window.location.href = '/login.html';
        }
    }

    // 3. åŸ‹ä¸‹èƒ¶å›Šï¼ˆç‚¹å‡»æŒ‰é’®è§¦å‘è¿™é‡Œï¼‰
    async function buryCapsule() {
        // --- æ‹¦æˆªé€»è¾‘ ---
        if (checkIsVisitor()) {
            alert('âŒ æ— æ³•å‘å¸ƒ\n\nè®¿å®¢æ¨¡å¼ï¼ˆ' + (nickname || 'æœªç™»å½•') + 'ï¼‰ä¸èƒ½åŸ‹ä¸‹æ—¶é—´èƒ¶å›Šã€‚\nè¯·æ³¨å†Œæˆ–ç™»å½•æ­£å¼è´¦å·ã€‚');
            document.getElementById('capsule-content').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            return; // ã€å…³é”®ã€‘ç›´æ¥åœæ­¢ï¼Œä¸å¾€ä¸‹æ‰§è¡Œï¼
        }

        // --- æ­£å¸¸å‘å¸ƒé€»è¾‘ ---
        const content = document.getElementById('capsule-content').value.trim();
        if (!content) return alert('è¯·å†™ç‚¹å†…å®¹å†åŸ‹å“¦ï½');

        const activeBtn = document.querySelector('.time-btn.active');
        let unlockDate = new Date();
        
        if (activeBtn.dataset.custom === "true") {
            const val = document.getElementById('custom-unlock-date').value;
            if (!val) return alert('è¯·é€‰æ‹©æ—¥æœŸ');
            unlockDate = new Date(val);
        } else {
            unlockDate.setMonth(unlockDate.getMonth() + parseInt(activeBtn.dataset.months));
        }

        try {
            const res = await fetch('/api/capsules', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ author: nickname, content, unlockDate })
            });
            
            if (res.ok) {
                alert('âœ¨ èƒ¶å›Šå·²åŸ‹ä¸‹ï¼');
                document.getElementById('capsule-content').value = '';
                loadMyCapsules();
            } else {
                alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } catch (e) {
            alert('ç½‘ç»œé”™è¯¯');
        }
    }

    // åˆ†é¡µç›¸å…³å˜é‡
    let currentPage = 1;
    let capsulesPerPage = 5;
    let totalCapsules = 0;
    let allCapsules = [];

    // 4. åŠ è½½åˆ—è¡¨
    async function loadMyCapsules(page = 1) {
        const listDiv = document.getElementById('my-capsules-list');
        
        // å¦‚æœæ˜¯è®¿å®¢ï¼Œç›´æ¥æ˜¾ç¤ºæç¤ºï¼Œä¸è¯·æ±‚åå°
        if (checkIsVisitor()) {
            listDiv.innerHTML = '<p style="text-align:center;color:#999;font-size:14px;padding:20px;">ç™»å½•åå¯æŸ¥çœ‹æ‚¨çš„ä¸“å±èƒ¶å›Š</p>';
            return;
        }

        try {
            // å¦‚æœè¿˜æ²¡æœ‰åŠ è½½è¿‡èƒ¶å›Šï¼Œå…ˆè·å–æ‰€æœ‰èƒ¶å›Š
            if (allCapsules.length === 0) {
                const res = await fetch(`/api/capsules/my?author=${encodeURIComponent(nickname)}`);
                allCapsules = await res.json();
                totalCapsules = allCapsules.length;
            }

            // è®¡ç®—åˆ†é¡µ
            currentPage = page;
            const startIndex = (currentPage - 1) * capsulesPerPage;
            const endIndex = startIndex + capsulesPerPage;
            const paginatedCapsules = allCapsules.slice(startIndex, endIndex);
            
            if (!paginatedCapsules || paginatedCapsules.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center;color:#999;font-size:14px;padding:20px;">è¿˜æ²¡æœ‰åŸ‹ä¸‹è¿‡èƒ¶å›Šå“¦...</p>';
                return;
            }

            const now = new Date();
            listDiv.innerHTML = paginatedCapsules.map(c => {
                const unlockTime = new Date(c.unlockDate);
                const isUnlocked = unlockTime <= now;
                return `
                <div class="capsule-card">
                    <span class="card-status ${isUnlocked ? 'status-open' : 'status-locked'}">
                        ${isUnlocked ? 'âœ… å·²å¼€å¯' : 'ğŸ”’ å°å­˜ä¸­'}
                    </span>
                    <p class="card-content">${isUnlocked ? c.content : 'ğŸ”’ è¿™æ˜¯ä¸€ä¸ªå¯†å°çš„æœªæ¥ä¿¡æ¯...'}</p>
                    <div class="card-time">
                        <span>åˆ›å»º: ${new Date(c.createdAt).toLocaleDateString()}</span>
                        <span>è§£å°: ${unlockTime.toLocaleDateString()}</span>
                    </div>
                </div>`;
            }).join('');

            // ç”Ÿæˆåˆ†é¡µæ§ä»¶
            generatePagination();
        } catch (e) {
            listDiv.innerHTML = '<p style="text-align:center;color:#999;">åŠ è½½å¤±è´¥</p>';
        }
    }

    // ç”Ÿæˆåˆ†é¡µæ§ä»¶
    function generatePagination() {
        const totalPages = Math.ceil(totalCapsules / capsulesPerPage);
        const paginationContainer = document.getElementById('pagination');
        
        // å¦‚æœæ²¡æœ‰åˆ†é¡µæ§ä»¶å®¹å™¨ï¼Œåˆ›å»ºä¸€ä¸ª
        if (!paginationContainer) {
            const myCapsulesDiv = document.querySelector('.my-capsules');
            const container = document.createElement('div');
            container.id = 'pagination';
            container.style.cssText = 'display:flex;justify-content:center;gap:10px;padding:20px 0;';
            myCapsulesDiv.appendChild(container);
        }
        
        // æ¸…ç©ºç°æœ‰åˆ†é¡µæ§ä»¶
        paginationContainer.innerHTML = '';
        
        // é¦–é¡µæŒ‰é’®
        const firstPageBtn = document.createElement('button');
        firstPageBtn.textContent = 'é¦–é¡µ';
        firstPageBtn.disabled = currentPage === 1;
        firstPageBtn.onclick = () => loadMyCapsules(1);
        paginationContainer.appendChild(firstPageBtn);
        
        // ä¸Šä¸€é¡µæŒ‰é’®
        const prevPageBtn = document.createElement('button');
        prevPageBtn.textContent = 'ä¸Šä¸€é¡µ';
        prevPageBtn.disabled = currentPage === 1;
        prevPageBtn.onclick = () => loadMyCapsules(currentPage - 1);
        paginationContainer.appendChild(prevPageBtn);
        
        // é¡µç æŒ‰é’®
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = i;
            pageBtn.className = i === currentPage ? 'active' : '';
            pageBtn.onclick = () => loadMyCapsules(i);
            paginationContainer.appendChild(pageBtn);
        }
        
        // ä¸‹ä¸€é¡µæŒ‰é’®
        const nextPageBtn = document.createElement('button');
        nextPageBtn.textContent = 'ä¸‹ä¸€é¡µ';
        nextPageBtn.disabled = currentPage === totalPages;
        nextPageBtn.onclick = () => loadMyCapsules(currentPage + 1);
        paginationContainer.appendChild(nextPageBtn);
        
        // æœ«é¡µæŒ‰é’®
        const lastPageBtn = document.createElement('button');
        lastPageBtn.textContent = 'æœ«é¡µ';
        lastPageBtn.disabled = currentPage === totalPages;
        lastPageBtn.onclick = () => loadMyCapsules(totalPages);
        paginationContainer.appendChild(lastPageBtn);
    }

    // 5. æŒ‰é’®åˆ‡æ¢é€»è¾‘
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('custom-unlock-date').style.display = (btn.dataset.custom === "true") ? 'block' : 'none';
        };
    });

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡
    loadMyCapsules();
  </script>
</body>
</html>