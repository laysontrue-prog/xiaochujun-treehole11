<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®ç”¨å·¥å…·</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* æ ‡é¢˜æ ·å¼ */
    .title {
      text-align: center;
      font-size: 32px;
      color: #2d3748;
      margin: 25px 0 10px;
      font-weight: 700;
      letter-spacing: -1px;
    }
    
    .subtitle {
      text-align: center;
      color: #718096;
      margin-bottom: 40px;
      font-size: 16px;
      font-weight: 500;
    }
    
    /* å·¥å…·åˆ—è¡¨åŒºåŸŸ */
    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 60px;
    }
    
    /* å·¥å…·å¡ç‰‡ */
    .tool-card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .tool-card:hover {
      background: rgba(255, 255, 255, 0.95);
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }
    
    .tool-card-content {
      cursor: pointer;
    }
    
    .delete-tool-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      opacity: 0.8;
    }
    
    .delete-tool-btn:hover {
      background: rgba(239, 68, 68, 1);
      opacity: 1;
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }
    
    .tool-card .tool-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .tool-card .tool-name {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 5px;
    }
    
    .tool-card .tool-desc {
      font-size: 13px;
      color: #718096;
    }
    
    /* æ·»åŠ å·¥å…·æŒ‰é’® */
    .add-tool-btn {
      position: fixed;
      bottom: 120px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
      color: white;
      font-size: 32px;
      border: none;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(0, 176, 155, 0.3);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .add-tool-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 35px rgba(0, 176, 155, 0.4);
    }
    
    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    
    .modal-content {
      background: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0fff4;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 30px;
      color: #718096;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .close-btn:hover {
      background: #f0fff4;
      color: #00b09b;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2d3748;
      font-size: 14px;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #00b09b;
      box-shadow: 0 0 0 3px rgba(0, 176, 155, 0.1);
    }
    
    .form-group textarea {
      width: 100%;
      height: 200px;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 14px;
      font-family: monospace;
      resize: vertical;
      transition: all 0.3s ease;
    }
    
    .form-group textarea:focus {
      outline: none;
      border-color: #00b09b;
      box-shadow: 0 0 0 3px rgba(0, 176, 155, 0.1);
    }
    
    .form-actions {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #f0fff4;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn.cancel {
      background: #e2e8f0;
      color: #718096;
    }
    
    .btn.cancel:hover {
      background: #cbd5e0;
    }
    
    .btn.save {
      background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
      color: white;
    }
    
    .btn.save:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 176, 155, 0.3);
    }
    
    .btn.delete {
      background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
      color: white;
    }
    
    .btn.delete:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
    }
    
    /* åº•éƒ¨å¯¼èˆª */
    .bottom-nav {
      background: white;
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      position: fixed;
      bottom: 0;
      width: 100%;
      height: 56px;
      z-index: 100;
    }
    
    .nav-item {
      text-align: center;
      color: #9e9e9e;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      min-width: 56px;
      transition: color 300ms;
      border-radius: 8px;
      text-decoration: none;
    }
    
    .nav-item:hover {
      background: rgba(128, 203, 196, 0.1);
    }
    
    .nav-item.active {
      color: #80cbc4;
    }
    
    .nav-item img {
      width: 24px;
      height: 24px;
      margin-bottom: 4px;
      transition: transform 300ms;
    }
    
    .nav-item.active img {
      transform: scale(1.1);
    }
    
    /* å·¥å…·å±•ç¤ºé¡µé¢ */
    .tool-container {
      width: 100%;
      height: 100vh;
      border: none;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .tools-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
      }
      
      .tool-card {
        padding: 20px 15px;
      }
      
      .add-tool-btn {
        bottom: 110px;
        right: 20px;
        width: 50px;
        height: 50px;
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="top-left">
      <span>å®ç”¨å·¥å…·</span>
    </div>
    <div class="top-right">
    </div>
  </div>

  <div class="content">
    <h1 class="title">å®ç”¨å·¥å…·</h1>
    <p class="subtitle">æ¢ç´¢å„ç§å®ç”¨çš„å°å·¥å…·ï¼Œä¸ä½œè€…ä¸€èµ·å¼€å‘ï¼Œæ™®æƒ å¤§å®¶</p>
    
    <div class="tools-grid" id="tools-grid">
      <!-- å·¥å…·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>

  <!-- æ·»åŠ å·¥å…·æŒ‰é’® -->
  <button class="add-tool-btn" onclick="openAddToolModal()">+</button>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <div class="bottom-nav">
    <div class="nav-item" onclick="location.href='/'">
      <img src="https://img.icons8.com/color/48/null/leaf.png" alt="å¹¿åœº">
      <div>æ ‘æ´å¹¿åœº</div>
    </div>
    <div class="nav-item" onclick="location.href='/topic.html'">
      <img src="https://img.icons8.com/color/48/null/speech-bubble.png" alt="è¯é¢˜">
      <div>è¯é¢˜è®¨è®º</div>
    </div>
    <div class="nav-item active" onclick="location.href='/tools.html'">
      <img src="https://img.icons8.com/color/48/null/wrench.png" alt="å·¥å…·">
      <div>å®ç”¨å·¥å…·</div>
    </div>
    <div class="nav-item" onclick="location.href='/capsule.html'">
      <img src="https://img.icons8.com/color/48/null/hourglass.png" alt="èƒ¶å›Š">
      <div>æ—¶é—´èƒ¶å›Š</div>
    </div>
    <div class="nav-item" onclick="location.href='/profile.html'">
      <img src="https://img.icons8.com/color/48/null/user.png" alt="æˆ‘çš„">
      <div>æˆ‘çš„</div>
    </div>
  </div>

  <!-- æ·»åŠ å·¥å…·æ¨¡æ€æ¡† -->
  <div class="modal" id="add-tool-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">æ·»åŠ æ–°å·¥å…·</h2>
        <button class="close-btn" onclick="closeAddToolModal()">&times;</button>
      </div>
      <form id="add-tool-form">
        <div class="form-group">
          <label for="tool-name">å·¥å…·åç§°</label>
          <input type="text" id="tool-name" placeholder="è¯·è¾“å…¥å·¥å…·åç§°" required>
        </div>
        <div class="form-group">
          <label for="tool-html">HTMLä»£ç </label>
          <textarea id="tool-html" placeholder="è¯·ç²˜è´´HTMLä»£ç " rows="10" required></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn cancel" onclick="closeAddToolModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn save">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
  <div class="modal" id="delete-confirm-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ç¡®è®¤åˆ é™¤</h2>
        <button class="close-btn" onclick="closeDeleteConfirmModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 20px 0;">
        <p style="color: #718096; font-size: 16px; line-height: 1.6;">
          ç¡®å®šè¦åˆ é™¤å·¥å…· <strong id="delete-tool-name"></strong> å—ï¼Ÿ
          <br>
          <span style="color: #e53e3e; font-weight: 600; margin-top: 10px; display: block;">
            æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œåˆ é™¤åå·¥å…·å°†æ°¸ä¹…ä¸¢å¤±ï¼
          </span>
        </p>
      </div>
      <div class="form-actions">
        <button type="button" class="btn cancel" onclick="closeDeleteConfirmModal()">å–æ¶ˆ</button>
        <button type="button" class="btn delete" onclick="confirmDelete()">åˆ é™¤</button>
      </div>
    </div>
  </div>

  <script>
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (!localStorage.getItem('token')) {
      window.location.href = '/login.html';
    }

    function logout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºæˆ–åˆ‡æ¢è´¦æˆ·å—ï¼Ÿ')) {
        localStorage.removeItem('token');
        localStorage.removeItem('nickname');
        localStorage.removeItem('avatar');
        window.location.href = '/login.html';
      }
    }
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    let nickname = localStorage.getItem('nickname') || 'åŒ¿åç”¨æˆ·';
    let role = localStorage.getItem('role') || 'user';
    if (document.getElementById('nickname')) {
      document.getElementById('nickname').textContent = nickname;
    }
    
    // ä»APIè·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
    async function fetchUserInfo() {
      try {
        const response = await fetch('/api/auth/me', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          nickname = data.nickname || nickname;
          role = data.role || role;
          localStorage.setItem('nickname', nickname);
          localStorage.setItem('role', role);
          if (document.getElementById('nickname')) {
            document.getElementById('nickname').textContent = nickname;
          }
        }
      } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯é”™è¯¯:', error.message);
      }
    }
    
    // å·¥å…·æ•°æ®
    let tools = [];
    
    // æ¸²æŸ“å·¥å…·åˆ—è¡¨
    function renderTools() {
      const toolsGrid = document.getElementById('tools-grid');
      
      if (tools.length === 0) {
        toolsGrid.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #718096;">
            <div style="font-size: 64px; margin-bottom: 20px;">ğŸ”§</div>
            <h3 style="font-size: 20px; margin-bottom: 10px;">æš‚æ— å·¥å…·</h3>
            <p>ç‚¹å‡»å³ä¸‹è§’çš„ "+" æŒ‰é’®æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªå®ç”¨å·¥å…·</p>
          </div>
        `;
        return;
      }
      
      toolsGrid.innerHTML = tools.map((tool, index) => `
        <div class="tool-card">
          <div class="tool-card-content" onclick="openTool(${index})">
            <div class="tool-icon">${getToolIcon(tool.name)}</div>
            <div class="tool-name">${tool.name}</div>
            <div class="tool-desc">ç‚¹å‡»ä½¿ç”¨</div>
          </div>
          ${(role === 'moderator' || role === 'admin') ? `
            <button class="delete-tool-btn" onclick="event.stopPropagation(); showDeleteConfirm(${index})" title="åˆ é™¤å·¥å…·">
              âœ•
            </button>
          ` : ''}
        </div>
      `).join('');
    }
    
    // è·å–å·¥å…·å›¾æ ‡
    function getToolIcon(name) {
      const icons = ['ğŸ”¢', 'ğŸ“', 'ğŸ“Š', 'ğŸ¨', 'ğŸ”¤', 'â°', 'ğŸ§®', 'ğŸ“ˆ', 'ğŸ¯', 'ğŸ”'];
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      return icons[Math.abs(hash) % icons.length];
    }
    
    // æ‰“å¼€å·¥å…·
    function openTool(index) {
      const tool = tools[index];
      const toolWindow = window.open('', '_blank');
      toolWindow.document.write(`
        <!DOCTYPE html>
        <html lang="zh">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>${tool.name}</title>
          <style>
            body { margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
          </style>
        </head>
        <body>
          ${tool.html}
        </body>
        </html>
      `);
      toolWindow.document.close();
    }
    
    // æ‰“å¼€æ·»åŠ å·¥å…·æ¨¡æ€æ¡†
    function openAddToolModal() {
      document.getElementById('add-tool-modal').style.display = 'block';
      document.getElementById('tool-name').focus();
    }
    
    // å…³é—­æ·»åŠ å·¥å…·æ¨¡æ€æ¡†
    function closeAddToolModal() {
      document.getElementById('add-tool-modal').style.display = 'none';
      document.getElementById('add-tool-form').reset();
    }
    
    // æ·»åŠ å·¥å…·è¡¨å•æäº¤
    document.getElementById('add-tool-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const name = document.getElementById('tool-name').value.trim();
      const html = document.getElementById('tool-html').value.trim();
      
      if (!name || !html) return;
      
      try {
        // è°ƒç”¨APIæ·»åŠ å·¥å…·
        const response = await fetch('/api/tools', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ name, html })
        });
        
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'æ·»åŠ å·¥å…·å¤±è´¥');
        }
        
        const { tool } = await response.json();
        
        // æ·»åŠ åˆ°æœ¬åœ°å·¥å…·åˆ—è¡¨
        tools.push(tool);
        
        // é‡æ–°æ¸²æŸ“å·¥å…·åˆ—è¡¨
        renderTools();
        
        // å…³é—­æ¨¡æ€æ¡†
        closeAddToolModal();
        
        alert('å·¥å…·å·²æ·»åŠ æˆåŠŸï¼');
      } catch (error) {
        console.error('æ·»åŠ å·¥å…·é”™è¯¯:', error.message);
        alert(error.message || 'æ·»åŠ å·¥å…·å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    });
    
    // å…¨å±€å˜é‡ï¼šå½“å‰è¦åˆ é™¤çš„å·¥å…·ç´¢å¼•
    let currentDeleteIndex = -1;
    
    // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
    function showDeleteConfirm(index) {
      currentDeleteIndex = index;
      const toolName = tools[index].name;
      document.getElementById('delete-tool-name').textContent = toolName;
      document.getElementById('delete-confirm-modal').style.display = 'block';
    }
    
    // å…³é—­åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
    function closeDeleteConfirmModal() {
      currentDeleteIndex = -1;
      document.getElementById('delete-confirm-modal').style.display = 'none';
    }
    
    // ç¡®è®¤åˆ é™¤æ“ä½œ
    async function confirmDelete() {
      if (currentDeleteIndex === -1) return;
      
      // è·å–è¦åˆ é™¤çš„å·¥å…·
      const tool = tools[currentDeleteIndex];
      const deletedToolName = tool.name;
      
      // è°ƒç”¨APIåˆ é™¤å·¥å…·
      const success = await deleteToolFromAPI(tool._id);
      
      if (success) {
        // ä»æœ¬åœ°å·¥å…·åˆ—è¡¨ä¸­åˆ é™¤
        tools.splice(currentDeleteIndex, 1);
        
        // é‡æ–°æ¸²æŸ“å·¥å…·åˆ—è¡¨
        renderTools();
        
        // å…³é—­æ¨¡æ€æ¡†
        closeDeleteConfirmModal();
        
        alert('å·¥å…·å·²æˆåŠŸåˆ é™¤ï¼');
        
        // è®°å½•åˆ é™¤æ—¥å¿—ï¼ˆåœ¨æ§åˆ¶å°ï¼‰
        console.log(`ç”¨æˆ· ${nickname} (è§’è‰²: ${role}) åˆ é™¤äº†å·¥å…·: ${deletedToolName}`);
      }
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
      const addModal = document.getElementById('add-tool-modal');
      const deleteModal = document.getElementById('delete-confirm-modal');
      
      if (event.target === addModal) {
        closeAddToolModal();
      } else if (event.target === deleteModal) {
        closeDeleteConfirmModal();
      }
    }
    
    // ä»åç«¯APIè·å–å·¥å…·åˆ—è¡¨
    async function fetchTools() {
      try {
        const response = await fetch('/api/tools', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          tools = data;
          renderTools();
        } else {
          console.error('è·å–å·¥å…·åˆ—è¡¨å¤±è´¥:', response.statusText);
          // é™çº§ä½¿ç”¨localStorageæ•°æ®
          tools = JSON.parse(localStorage.getItem('userTools')) || [];
          renderTools();
        }
      } catch (error) {
        console.error('è·å–å·¥å…·åˆ—è¡¨é”™è¯¯:', error.message);
        // é™çº§ä½¿ç”¨localStorageæ•°æ®
        tools = JSON.parse(localStorage.getItem('userTools')) || [];
        renderTools();
      }
    }
    
    // ä»åç«¯APIåˆ é™¤å·¥å…·
    async function deleteToolFromAPI(toolId) {
      try {
        const response = await fetch(`/api/tools/${toolId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.message || 'åˆ é™¤å·¥å…·å¤±è´¥');
        }
        
        return true;
      } catch (error) {
        console.error('åˆ é™¤å·¥å…·é”™è¯¯:', error.message);
        alert(error.message);
        return false;
      }
    }
    
    // åˆå§‹æ¸²æŸ“å·¥å…·åˆ—è¡¨
    async function init() {
      await fetchUserInfo();
      await fetchTools();
    }
    
    init();
  </script>
</body>
</html>