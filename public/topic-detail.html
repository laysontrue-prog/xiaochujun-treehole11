<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°æ¥šå›çš„æ ‘æ´ - è¯é¢˜è¯¦æƒ…</title>
  <style>
    body { margin: 0; padding: 0; background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); font-family: Arial, sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
    .top { padding: 15px 20px; background: #fff; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .top-left { display: flex; align-items: center; }
    .top-left img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
    .top-left span { font-weight: bold; color: #333; }
    .top-right { color: #999; font-size: 14px; display: flex; align-items: center; gap: 10px; }
    .top-right button { padding: 8px 15px; border: none; border-radius: 20px; cursor: pointer; font-size: 12px; }
    .logout-btn { background: #ff8a80; color: white; }
    .switch-btn { background: #fff3e0; color: #ff8a80; border: 1px solid #ff8a80; }

.content {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  padding-bottom: 80px; /* å…³é”®è¿™è¡Œï¼ç•™å‡ºåº•éƒ¨å¯¼èˆªç©ºé—´ */
}
    .bottom-nav { background: #fff; display: flex; justify-content: space-around; padding: 15px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); position: fixed; bottom: 0; width: 100%; }
    .nav-item { text-align: center; color: #999; font-size: 12px; cursor: pointer; }
    .nav-item.active { color: #80cbc4; }
    .nav-item img { width: 24px; height: 24px; margin-bottom: 5px; }
    .topic-header { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); padding: 30px; border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); margin-bottom: 30px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.3); }
    .topic-header .icon { font-size: 50px; margin-bottom: 15px; }
    .topic-header h1 { margin: 0 0 10px; font-size: 24px; color: #333; }
    .topic-header p { color: #666; font-size: 16px; }

    .post-box {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      padding: 25px;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 35px;
      display: flex;
      align-items: center;
      gap: 15px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }
    
    .post-box:hover {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }
    
    .post-box .id {
      color: #718096;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .post-box textarea {
      flex: 1;
      border: none;
      outline: none;
      font-size: 16px;
      resize: none;
      height: 70px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 16px;
      color: #2d3748;
      font-family: inherit;
      transition: all 0.3s ease;
    }
    
    .post-box textarea:focus {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 0 3px rgba(0, 176, 155, 0.1);
    }
    
    .post-box button {
      background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 28px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 176, 155, 0.3);
    }
    
    .post-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 176, 155, 0.4);
      background: linear-gradient(135deg, #009c87 0%, #85b535 100%);
    }

    .reply-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.12);
      margin-bottom: 25px;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .reply-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #00b09b, #96c93d);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s ease;
    }
    
    .reply-card:hover {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 15px 50px rgba(0,0,0,0.15);
      transform: translateY(-3px);
    }
    
    .reply-card:hover::before {
      transform: scaleX(1);
    }
    
    .reply-card p {
      margin: 0 0 15px;
      color: #4a5568;
      font-size: 16px;
      line-height: 1.7;
      word-wrap: break-word;
    }
    
    .reply-card .author {
      color: #718096;
      font-size: 14px;
      font-weight: 500;
    }
    
    .reply-card .time {
      float: right;
      color: #a0aec0;
      font-size: 12px;
      font-weight: 500;
    }
    
    /* å¾®ä¿¡é£æ ¼çš„ç‚¹èµè¯„è®ºæ ·å¼ */
    .reply-card .actions {
      margin-top: 18px;
      padding-top: 15px;
      border-top: 2px solid #f7fafc;
      display: flex;
      justify-content: flex-end;
      gap: 25px;
      font-size: 16px;
      color: #718096;
    }
    
    .reply-card .action-btn {
      cursor: pointer;
      padding: 10px 16px;
      border-radius: 20px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }
    
    .reply-card .action-btn:hover {
      background: #f7fafc;
      color: #4a5568;
      transform: translateY(-1px);
    }
    
    .reply-card .like.liked {
      color: #e53e3e;
    }
    
    /* ç‚¹èµåŠ¨ç”»æ•ˆæœ */
    @keyframes likeAnimation {
      0% { transform: scale(1); }
      50% { transform: scale(1.5); }
      100% { transform: scale(1); }
    }
    
    .reply-card .action-btn.like.liked .like-icon {
      animation: likeAnimation 0.5s ease;
    }

    /* è¯„è®ºåŒºæ ·å¼ */
    .reply-card .comments {
      margin-top: 20px;
      padding: 15px;
      border-top: 2px solid #f7fafc;
      display: none;
      background: rgba(247, 250, 252, 0.8);
      border-radius: 15px;
    }
    
    .reply-card .comments.show {
      display: block;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* è¯„è®ºè¾“å…¥æ ·å¼ */
    .reply-card .comment-input {
      display: flex;
      margin-top: 15px;
      gap: 12px;
    }
    
    .reply-card .comment-input textarea {
      flex: 1;
      border: 2px solid #e2e8f0;
      border-radius: 25px;
      padding: 12px 16px;
      resize: none;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.8);
    }
    
    .reply-card .comment-input textarea:focus {
      outline: none;
      border-color: #00b09b;
      box-shadow: 0 0 0 3px rgba(0, 176, 155, 0.1);
      background: white;
    }
    
    .reply-card .comment-input button {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    .reply-card .comment-input button:hover {
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
    }
    
    /* è¯„è®ºé¡¹æ ·å¼ */
    .reply-card .comment-item {
      padding: 12px 0;
      border-bottom: 1px solid #edf2f7;
      font-size: 14px;
      color: #4a5568;
      line-height: 1.6;
    }
    
    .reply-card .comment-item:last-child {
      border-bottom: none;
    }
    
    .reply-card .comment-item strong {
      color: #2d3748;
      font-weight: 600;
      margin-right: 8px;
    }
    
    /* è¡¨æƒ…é€‰æ‹©å™¨æ ·å¼ */
    .emoji-picker {
      position: absolute;
      bottom: 100%;
      left: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 12px;
      display: none;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      max-width: 240px;
    }
    
    .emoji-picker.show {
      display: grid;
    }
    
    .emoji-item {
      font-size: 24px;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .emoji-item:hover {
      background: rgba(72, 187, 120, 0.1);
      transform: scale(1.2);
    }
    
    /* ç§»åŠ¨ç«¯é€‚é…ä¼˜åŒ– */
    @media (max-width: 768px) {
      /* è°ƒæ•´å…¨å±€é—´è· */
      body {
        font-size: 14px;
      }
      
      /* é¡¶éƒ¨å¯¼èˆªé€‚é… */
      .top {
        padding: 12px 15px;
      }
      
      .top-left img {
        width: 38px;
        height: 38px;
        margin-right: 10px;
      }
      
      .top-left span {
        font-size: 16px;
      }
      
      .top-right {
        gap: 10px;
      }
      
      .top-right button {
        padding: 8px 14px;
        font-size: 12px;
      }
      
      /* å†…å®¹åŒºåŸŸé€‚é… */
      .content {
        padding: 15px;
        padding-bottom: 80px;
      }
      
      /* è¯é¢˜å¤´éƒ¨é€‚é… */
      .topic-header {
        padding: 25px;
        margin-bottom: 25px;
      }
      
      .topic-header .icon {
        font-size: 40px;
      }
      
      .topic-header h1 {
        font-size: 22px;
      }
      
      .topic-header p {
        font-size: 14px;
      }
      
      /* å‘å¸ƒæ¡†é€‚é… */
      .post-box {
        padding: 20px;
        margin-bottom: 25px;
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      .post-box .id {
        align-self: flex-start;
      }
      
      .post-box textarea {
        height: 60px;
        font-size: 15px;
        padding: 10px 14px;
      }
      
      .post-box button {
        padding: 12px 24px;
        font-size: 15px;
      }
      
      /* å›å¤å¡ç‰‡é€‚é… */
      .reply-card {
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .reply-card p {
        font-size: 15px;
        line-height: 1.6;
      }
      
      /* æ“ä½œæŒ‰é’®é€‚é… */
      .reply-card .actions {
        gap: 15px;
        font-size: 13px;
      }
      
      .reply-card .action-btn {
        padding: 8px 12px;
        gap: 6px;
      }
      
      /* è¯„è®ºåŒºé€‚é… */
      .reply-card .comments {
        padding: 12px;
      }
      
      .reply-card .comment-input {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      
      .reply-card .comment-input textarea {
        font-size: 14px;
        padding: 10px 14px;
      }
      
      .reply-card .comment-input button {
        padding: 10px 20px;
        font-size: 14px;
      }
    }
    
    /* å°å±å¹•æ‰‹æœºé€‚é… */
    @media (max-width: 480px) {
      /* è¿›ä¸€æ­¥è°ƒæ•´é—´è· */
      .content {
        padding: 12px;
      }
      
      .topic-header {
        padding: 20px;
      }
      
      .topic-header h1 {
        font-size: 20px;
      }
      
      .post-box,
      .reply-card {
        padding: 18px;
      }
      
      /* è°ƒæ•´æ“ä½œæŒ‰é’®å¸ƒå±€ */
      .reply-card .actions {
        gap: 12px;
      }
      
      .reply-card .action-btn {
        padding: 6px 10px;
        font-size: 12px;
      }
    }

    .bottom-nav { background: #fff; display: flex; justify-content: space-around; padding: 15px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); position: fixed; bottom: 0; width: 100%; }
    .nav-item { text-align: center; color: #999; font-size: 12px; cursor: pointer; }
    .nav-item.active { color: #80cbc4; }
    .nav-item img { width: 24px; height: 24px; margin-bottom: 5px; }
  </style>
</head>
<body>
  <div class="top">
  <div class="top-left">
  <button style="background:none;border:none;font-size:28px;cursor:pointer;margin-right:10px;" onclick="history.back()">â†</button>
  <img src="logo.png" alt="Logo">
  <span>å°æ¥šå›çš„æ ‘æ´</span>
</div>
    <div class="top-right">
      æ¬¢è¿ï¼Œ<span id="nickname">åŠ è½½ä¸­...</span>
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
      <button class="switch-btn" onclick="logout()">åˆ‡æ¢è´¦æˆ·</button>
    </div>
  </div>

  <div class="content">
    <div class="topic-header">
      <div class="icon" id="topicIcon">ğŸ’¬</div>
      <h1 id="topicTitle">åŠ è½½ä¸­...</h1>
      <p id="topicDesc"></p>
    </div>

    <div class="post-box">
      <span class="id">å½“å‰èº«ä»½ï¼š<span id="currentId">åŠ è½½ä¸­...</span></span>
      <textarea id="content" placeholder="è¯´è¯´ä½ çš„çœ‹æ³•..."></textarea>
      <button onclick="sendReply()">å‘é€</button>
    </div>

    <div id="replies-list"></div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item" onclick="location.href='/'">
      <img src="https://img.icons8.com/color/48/null/leaf.png" alt="å¹¿åœº">
      <div>æ ‘æ´å¹¿åœº</div>
    </div>
    <div class="nav-item active" onclick="location.href='/topic.html'">
      <img src="https://img.icons8.com/color/48/null/speech-bubble.png" alt="è¯é¢˜">
      <div>è¯é¢˜è®¨è®º</div>
    </div>
    <div class="nav-item" onclick="location.href='/capsule.html'">
      <img src="https://img.icons8.com/color/48/null/hourglass.png" alt="èƒ¶å›Š">
      <div>æ—¶é—´èƒ¶å›Š</div>
    </div>
    <div class="nav-item" onclick="location.href='/profile.html'">
      <img src="https://img.icons8.com/color/48/null/user.png" alt="æˆ‘çš„">
      <div>æˆ‘çš„</div>
    </div>
  </div>

  <script>
    if (!localStorage.getItem('token')) {
      window.location.href = '/login.html';
    }

    const nickname = localStorage.getItem('nickname') || 'è®¿å®¢';
    document.getElementById('nickname').textContent = nickname;
    document.getElementById('currentId').textContent = nickname;

    function logout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºæˆ–åˆ‡æ¢è´¦æˆ·å—ï¼Ÿ')) {
        localStorage.removeItem('token');
        localStorage.removeItem('nickname');
        window.location.href = '/login.html';
      }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const topicId = urlParams.get('id');

    async function loadTopic() {
      try {
        const res = await fetch(`/api/topics/${topicId}`);
        const topic = await res.json();

        document.getElementById('topicIcon').textContent = topic.icon || 'ğŸ’¬';
        document.getElementById('topicTitle').textContent = topic.title;
        document.getElementById('topicDesc').textContent = topic.description || '';

        const list = document.getElementById('replies-list');
        list.innerHTML = topic.replies.map(r => `
          <div class="reply-card" onclick="toggleComments('${r._id}')">
            <p>${r.content.replace(/\n/g,'<br>')}</p>
            <div>
              <span class="author">â€” ${r.author}</span>
              <span class="time">${new Date(r.createdAt).toLocaleString()}</span>
            </div>
            <div class="actions">
              <span class="action-btn like" id="like-btn-${r._id}" onclick="event.stopPropagation(); toggleLike('${r._id}')">
                <span class="like-icon" id="like-icon-${r._id}">ğŸ¤</span> ç‚¹èµ (<span class="like-count" id="like-${r._id}">0</span>)
              </span>
              <span class="action-btn comment" onclick="event.stopPropagation(); toggleComments('${r._id}')">
                ğŸ’¬ è¯„è®º (<span class="comment-count" id="comment-${r._id}">0</span>)
              </span>
            </div>
            <div class="comments" id="comments-${r._id}">
              <div class="comment-input">
                <textarea id="comment-input-${r._id}" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." onclick="event.stopPropagation();" onfocus="event.stopPropagation();"></textarea>
                <div style="position: relative;">
                  <button onclick="event.stopPropagation(); toggleEmojiPicker('${r._id}')">ğŸ˜Š</button>
                  <div class="emoji-picker" id="emoji-picker-${r._id}">
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'â¤ï¸')">â¤ï¸</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ¤')">ğŸ¤</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ‰')">ğŸ‰</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ˜¢')">ğŸ˜¢</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ˜†')">ğŸ˜†</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ˜˜')">ğŸ˜˜</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ˜')">ğŸ˜</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ˜‰')">ğŸ˜‰</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ˜')">ğŸ˜</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ˜´')">ğŸ˜´</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ˜­')">ğŸ˜­</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ¤£')">ğŸ¤£</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ˜ƒ')">ğŸ˜ƒ</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ¤”')">ğŸ¤”</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ‘')">ğŸ‘</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ‘')">ğŸ‘</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ‘')">ğŸ‘</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ™')">ğŸ™</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ”¥')">ğŸ”¥</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'âœ¨')">âœ¨</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸŒŸ')">ğŸŒŸ</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸš€')">ğŸš€</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ’ª')">ğŸ’ª</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ˜‰')">ğŸ˜‰</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ˜œ')">ğŸ˜œ</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ¥º')">ğŸ¥º</div>
                    <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${r._id}', 'ğŸ¤—')">ğŸ¤—</div>
                  </div>
                </div>
                <button onclick="event.stopPropagation(); sendReplyComment('${r._id}')">å‘é€</button>
              </div>
              <div id="comment-list-${r._id}">åŠ è½½ä¸­...</div>
            </div>
          </div>
        `).join('') || '<p style="text-align:center;color:#999;">æš‚æ— è®¨è®ºï¼Œæ¥æ‰“ç ´æ²‰é»˜å§ï½</p>';

        // åŠ è½½æ¯æ¡å›å¤çš„ç‚¹èµæ•°å’Œè¯„è®ºæ•°
        topic.replies.forEach(r => loadLikeAndCommentCount(r._id));
      } catch (err) {
        console.log('åŠ è½½è¯é¢˜å¤±è´¥', err);
      }
    }

    // åŠ è½½ç‚¹èµæ•°å’Œè¯„è®ºæ•°
    async function loadLikeAndCommentCount(replyId) {
      try {
        const likeRes = await fetch(`/api/likes/topic-reply/${replyId}`);
        const likeData = await likeRes.json();
        const commentRes = await fetch(`/api/comments/topic-reply/${replyId}`);
        const comments = await commentRes.json();

        document.getElementById('like-' + replyId).textContent = likeData.count || 0;
        document.getElementById('comment-' + replyId).textContent = comments.length;

        // æ£€æŸ¥å½“å‰ç”¨æˆ·çš„ç‚¹èµçŠ¶æ€
        const checkRes = await fetch(`/api/likes/check?topicReplyId=${replyId}&userNickname=${nickname}`);
        const checkData = await checkRes.json();
        const likeBtn = document.getElementById('like-btn-' + replyId);
        const likeIcon = document.getElementById('like-icon-' + replyId);
        
        if (checkData.isLiked) {
          likeBtn.classList.add('liked');
          likeIcon.textContent = 'â¤ï¸';
        } else {
          likeBtn.classList.remove('liked');
          likeIcon.textContent = 'ğŸ¤';
        }

        const list = document.getElementById('comment-list-' + replyId);
        if (comments.length === 0) {
          list.innerHTML = '<p style="color:#999;padding:10px;">æš‚æ— è¯„è®ºï¼Œæ¥æŠ¢æ²™å‘ï½</p>';
        } else {
          list.innerHTML = comments.map(c => `
            <div class="comment-item">
              <strong>${c.author}</strong>: ${c.content}
              <small style="color:#ccc;float:right;">${new Date(c.createdAt).toLocaleString()}</small>
            </div>
          `).join('');
        }
      } catch (err) {
        console.log('åŠ è½½æ•°é‡å¤±è´¥', err);
      }
    }

    // ç‚¹èµ/å–æ¶ˆç‚¹èµåˆ‡æ¢
    async function toggleLike(replyId) {
      const btn = document.getElementById('like-btn-' + replyId);
      const icon = document.getElementById('like-icon-' + replyId);
      
      try {
        // æ£€æŸ¥å½“å‰ç‚¹èµçŠ¶æ€
        const checkRes = await fetch(`/api/likes/check?topicReplyId=${replyId}&userNickname=${nickname}`);
        const checkData = await checkRes.json();
        
        if (checkData.isLiked) {
          // å–æ¶ˆç‚¹èµ
          await fetch('/api/likes', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ topicReplyId: replyId, userNickname: nickname })
          });
          btn.classList.remove('liked');
          icon.textContent = 'ğŸ¤';
        } else {
          // æ·»åŠ ç‚¹èµ
          await fetch('/api/likes', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ topicReplyId: replyId, userNickname: nickname })
          });
          btn.classList.add('liked');
          icon.textContent = 'â¤ï¸';
        }
        
        // æ›´æ–°ç‚¹èµæ•°
        loadLikeAndCommentCount(replyId);
      } catch (err) {
        console.log('ç‚¹èµæ“ä½œå¤±è´¥', err);
      }
    }

    // å‘é€è¯„è®º
    async function sendReplyComment(replyId) {
      const input = document.getElementById('comment-input-' + replyId);
      const content = input.value.trim();
      if (!content) return alert('å†™ç‚¹è¯„è®ºå†å‘å“¦ï½');

      await fetch('/api/comments/topic-reply', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ topicReplyId: replyId, content, author: nickname })
      });

      input.value = '';
      loadLikeAndCommentCount(replyId);
    }

    function toggleComments(replyId) {
      const comments = document.getElementById('comments-' + replyId);
      comments.classList.toggle('show');
    }

    async function sendReply() {
      const content = document.getElementById('content').value.trim();
      if (!content) return alert('å†™ç‚¹ä¸œè¥¿å†å‘å“¦ï½');

      await fetch(`/api/topics/${topicId}/reply`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ content, author: nickname, isAnonymous: false })
      });

      document.getElementById('content').value = '';
      alert('å›å¤æˆåŠŸ');
      loadTopic();
    }

    // åˆå§‹åŠ è½½
    loadTopic();
    
    // ç›‘å¬æ–°å›å¤ï¼Œä½†ä¸è‡ªåŠ¨åˆ·æ–°æ•´ä¸ªé¡µé¢
    let lastReplyCount = 0;
    async function checkForNewReplies() {
      try {
        const res = await fetch(`/api/topics/${topicId}`);
        const topic = await res.json();
        const totalReplies = topic.replies.length;
        
        // è®¡ç®—æ‰€æœ‰è¯„è®ºçš„æ€»æ•°
        let totalComments = 0;
        topic.replies.forEach(reply => {
          totalComments += reply.comments ? reply.comments.length : 0;
        });
        
        const totalMessages = totalReplies + totalComments;
        
        if (totalMessages > lastReplyCount && lastReplyCount !== 0) {
          // åªåœ¨æœ‰æ–°æ¶ˆæ¯æ—¶é€šçŸ¥ç”¨æˆ·ï¼Œè€Œä¸æ˜¯è‡ªåŠ¨åˆ·æ–°
          const newMessages = totalMessages - lastReplyCount;
          const notice = document.createElement('div');
          notice.style.cssText = 'position:fixed;top:20px;right:20px;background:#80cbc4;color:white;padding:15px;border-radius:10px;cursor:pointer;z-index:1000;';
          notice.innerHTML = `æœ‰ ${newMessages} æ¡æ–°æ¶ˆæ¯ï¼Œ<span style="text-decoration:underline;">ç‚¹å‡»åˆ·æ–°</span>`;
          notice.onclick = () => {
            loadTopic();
            document.body.removeChild(notice);
          };
          document.body.appendChild(notice);
          // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
          setTimeout(() => {
            if (document.body.contains(notice)) {
              document.body.removeChild(notice);
            }
          }, 3000);
        }
        lastReplyCount = totalMessages;
      } catch (err) {
        console.log('æ£€æŸ¥æ–°å›å¤å¤±è´¥', err);
      }
    }
    
    // è¡¨æƒ…é€‰æ‹©å™¨åŠŸèƒ½
    function toggleEmojiPicker(replyId) {
      const picker = document.getElementById('emoji-picker-' + replyId);
      picker.classList.toggle('show');
      
      // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­è¡¨æƒ…é€‰æ‹©å™¨
      setTimeout(() => {
        document.addEventListener('click', function closePicker(event) {
          if (!picker.contains(event.target) && event.target.id !== 'emoji-btn-' + replyId) {
            picker.classList.remove('show');
            document.removeEventListener('click', closePicker);
          }
        });
      }, 0);
    }
    
    function insertEmoji(replyId, emoji) {
      const input = document.getElementById('comment-input-' + replyId);
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const value = input.value;
      
      // åœ¨å…‰æ ‡ä½ç½®æ’å…¥è¡¨æƒ…
      input.value = value.substring(0, start) + emoji + value.substring(end);
      
      // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°è¡¨æƒ…åé¢
      const newPosition = start + emoji.length;
      input.focus();
      input.setSelectionRange(newPosition, newPosition);
    }
    
    // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ–°å›å¤
    setInterval(checkForNewReplies, 30000);
  </script>

  <div class="bottom-nav">
    <div class="nav-item" onclick="location.href='/'">
      <img src="https://img.icons8.com/color/48/null/leaf.png" alt="å¹¿åœº">
      <div>æ ‘æ´å¹¿åœº</div>
    </div>
    <div class="nav-item active" onclick="location.href='/topic.html'">
      <img src="https://img.icons8.com/color/48/null/speech-bubble.png" alt="è¯é¢˜">
      <div>è¯é¢˜è®¨è®º</div>
    </div>
    <div class="nav-item" onclick="location.href='/capsule.html'">
      <img src="https://img.icons8.com/color/48/null/hourglass.png" alt="èƒ¶å›Š">
      <div>æ—¶é—´èƒ¶å›Š</div>
    </div>
    <div class="nav-item" onclick="location.href='/profile.html'">
      <img src="https://img.icons8.com/color/48/null/user.png" alt="æˆ‘çš„">
      <div>æˆ‘çš„</div>
    </div>
  </div>
</body>
</html>