<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯é¢˜è¯¦æƒ…</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* å¼•ç”¨ index.html çš„æ ¸å¿ƒæ ·å¼ */
    
    /* æ ‡é¢˜æ ·å¼ */
    .title {
      text-align: center;
      font-size: 32px;
      color: #2d3748;
      margin: 25px 0 10px;
      font-weight: 700;
      letter-spacing: -1px;
    }
    
    .subtitle {
      text-align: center;
      color: #718096;
      margin-bottom: 35px;
      font-size: 16px;
      font-weight: 500;
    }

    /* å‘å¸ƒæ¡†æ ·å¼ - Windows 7/è‹¹æœOS26é£æ ¼åŠé€æ˜æ•ˆæœ */
    .post-box {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      padding: 25px;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 35px;
      display: flex;
      align-items: center;
      gap: 15px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      /* ç¡®ä¿ç›¸å¯¹å®šä½ä»¥ä¾¿æ”¾ç½®è¡¨æƒ…æ¡† */
      position: relative; 
      flex-direction: column; /* ä¿æŒä¸ºåˆ—å¸ƒå±€ä»¥é€‚åº”ç»“æ„ */
      align-items: stretch;
    }
    
    .post-box:hover {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }
    
    .post-box .id {
      color: #718096;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      margin-bottom: 10px;
    }
    
    .post-box textarea {
      flex: 1;
      border: none;
      outline: none;
      font-size: 16px;
      resize: none;
      height: 70px; /* ä¿®æ­£ä¸ºä¸index.htmlä¸€è‡´ */
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 16px;
      color: #2d3748;
      font-family: inherit;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .post-box textarea:focus {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 0 3px rgba(0, 176, 155, 0.1);
    }
    
    .post-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      border-top: 1px solid rgba(0,0,0,0.05);
      padding-top: 10px;
      width: 100%;
    }
    
    .post-tools {
      display: flex;
      gap: 15px;
      position: relative;
    }
    
    .tool-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      color: #999;
      padding: 5px;
      border-radius: 5px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .tool-btn:hover {
      background: #f5f5f5;
      color: #00b09b;
    }
    
    .send-btn {
      background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 28px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 176, 155, 0.3);
    }
    
    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 176, 155, 0.4);
      background: linear-gradient(135deg, #009c87 0%, #85b535 100%);
    }

    /* å¸–å­å¡ç‰‡æ ·å¼ (Reply Card) */
    .post-card { 
      background: rgba(255, 255, 255, 0.7); 
      backdrop-filter: blur(15px); 
      -webkit-backdrop-filter: blur(15px); 
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.12); 
      margin-bottom: 25px;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      position: relative;
    }
    
    .post-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #00b09b, #96c93d);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s ease;
    }
    
    .post-card:hover {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 15px 50px rgba(0,0,0,0.15);
      transform: translateY(-3px);
    }
    
    .post-card:hover::before {
      transform: scaleX(1);
    }
    
    .post-card p {
      margin: 0 0 15px;
      color: #4a5568;
      font-size: 16px;
      line-height: 1.7;
      word-wrap: break-word;
    }
    
    .post-card .author {
      color: #718096;
      font-size: 14px;
      font-weight: 500;
    }
    
    .post-card .time {
      float: right;
      color: #a0aec0;
      font-size: 12px;
      font-weight: 500;
    }
    
    /* æ“ä½œæ æ ·å¼ */
    .post-card .actions {
      margin-top: 18px;
      padding-top: 15px;
      border-top: 2px solid #f7fafc;
      display: flex;
      justify-content: flex-start;
      gap: 25px;
      font-size: 14px;
      color: #718096;
    }
    
    .post-card .action-btn {
      cursor: pointer;
      padding: 10px 16px;
      border-radius: 20px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }
    
    .post-card .action-btn:hover {
      background: #f7fafc;
      color: #4a5568;
      transform: translateY(-1px);
    }
    
    .post-card .like.liked {
      color: #e53e3e;
    }
    
    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes likeAnimation {
      0% { transform: scale(1); }
      50% { transform: scale(1.5); }
      100% { transform: scale(1); }
    }
    
    .post-card .action-btn.like.liked [id^="like-icon"] {
      animation: likeAnimation 0.5s ease;
    }
    
    /* è¯„è®ºåŒºæ ·å¼ */
    .post-card .comments {
      margin-top: 20px;
      padding: 15px;
      border-top: 2px solid #f7fafc;
      display: none;
      background: rgba(247, 250, 252, 0.8);
      border-radius: 15px;
    }
    
    .post-card .comments.show {
      display: block;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* è¯„è®ºæ¡†æ ·å¼ (å•†ä¸šåŒ–ä¼˜åŒ–) */
    .comment-box {
      background: #f7f8fa;
      padding: 12px;
      border-radius: 16px;
      margin-bottom: 15px;
      border: 1px solid #eee;
    }
    
    .comment-box .id {
      font-size: 12px;
      color: #999;
      margin-bottom: 8px;
      display: block;
    }

    .comment-input-area {
      position: relative;
      background: white;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }

    .comment-input-area:focus-within {
      border-color: #00b09b;
      box-shadow: 0 0 0 3px rgba(128, 203, 196, 0.1);
    }

    .comment-textarea {
      width: 100%;
      border: none;
      resize: none;
      min-height: 60px;
      padding: 12px;
      font-size: 14px;
      background: transparent;
      outline: none;
      font-family: inherit;
      box-sizing: border-box;
      display: block;
    }

    .comment-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 4px;
    }

    .comment-tools {
      display: flex;
      gap: 10px;
      position: relative;
    }

    .comment-tool-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      color: #999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .comment-tool-btn:hover {
      background: #f0f2f5;
      color: #00b09b;
    }
    
    .post-card .comment-send-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white !important;
      border: none;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      height: 34px;
    }

    .post-card .comment-send-btn:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
    }

    .post-card .comment-send-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }

    /* è¯„è®ºåˆ—è¡¨é¡¹ */
    .comment-item {
      padding: 12px 0;
      border-bottom: 1px solid #edf2f7;
      font-size: 14px;
      color: #4a5568;
      line-height: 1.6;
    }
    
    .comment-item:last-child {
      border-bottom: none;
    }
    
    .comment-item strong {
      color: #2d3748;
      font-weight: 600;
      margin-right: 8px;
    }

    /* å›¾ç‰‡é¢„è§ˆé€šç”¨æ ·å¼ */
    .preview-list, .comment-preview-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 0 12px 12px;
    }
    
    .preview-item, .comment-preview-item {
      position: relative;
      width: 60px;
      height: 60px;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #eee;
    }
    
    .preview-item img, .comment-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .preview-item .remove-btn, .comment-preview-item .remove-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    /* å›¾ç‰‡å±•ç¤ºç½‘æ ¼ */
    .post-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .post-image {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid #eee;
    }

    /* è¯é¢˜é¡µç‹¬æœ‰æ ·å¼ */
    .topic-header {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .topic-header .icon { font-size: 50px; margin-bottom: 15px; }
    .topic-header h1 { margin: 0 0 10px; font-size: 24px; color: #333; }
    .topic-header p { color: #666; font-size: 16px; }

    /* Level Tag Styles */
    .level-tag {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
      color: white;
      margin-left: 8px; /* é—´è· 8px */
      vertical-align: middle;
      line-height: 1.4;
    }
    .lv-1, .lv-2, .lv-3 { background: #999; }
    .lv-4, .lv-5, .lv-6 { background: #ff4d4f; }
    .lv-7, .lv-8, .lv-9 { background: #1890ff; }
    .lv-10 { background: linear-gradient(135deg, #faad14 0%, #d48806 100%); box-shadow: 0 0 5px rgba(250, 173, 20, 0.5); }

    /* è¾“å…¥æ¡†åŒºåŸŸç­‰çº§å¾½ç« æ ·å¼ */
    .input-level-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      color: white;
      margin-left: 8px;
      cursor: pointer;
      transition: all 0.2s;
      height: 20px;
      line-height: 1;
      vertical-align: middle;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .input-level-badge:hover {
      transform: scale(1.1);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* è¡¨æƒ…é€‰æ‹©å™¨ä¼˜åŒ– - ä¿®å¤è¢«é®æŒ¡é—®é¢˜ */
    .emoji-picker, .emoji-picker-popover {
      position: absolute;
      /* åŠ¨æ€è®¡ç®—ä½ç½®ï¼Œé»˜è®¤ä¸ºä¸Šæ–¹å¼¹å‡º */
      bottom: 100%; 
      left: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0;
      display: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2); /* åŠ æ·±é˜´å½± */
      z-index: 99999 !important; /* ç¡®ä¿æœ€é«˜å±‚çº§ */
      width: 320px;
      height: 280px;
      flex-direction: column;
      overflow: hidden;
      margin-bottom: 10px; /* ä¸è§¦å‘æŒ‰é’®çš„é—´è· */
    }

    .emoji-picker.show, .emoji-picker-popover.show {
      display: flex;
    }

    /* ç§»åŠ¨ç«¯é€‚é…ï¼šå¦‚æœå±å¹•å¤ªå°ï¼Œå°è¯•å±…ä¸­æ˜¾ç¤º */
    @media (max-width: 480px) {
      .emoji-picker, .emoji-picker-popover {
        width: 300px; /* ç¨å¾®ç¼©å°å®½åº¦ */
        left: 50%;
        transform: translateX(-50%);
      }
    }

    .emoji-nav {
      display: flex;
      overflow-x: auto;
      background: #f8f9fa;
      padding: 8px 8px 0;
      border-bottom: 1px solid #eee;
      flex-shrink: 0;
      scrollbar-width: none;
    }
    .emoji-nav::-webkit-scrollbar { display: none; }

    .emoji-nav-item {
      padding: 6px 12px;
      margin-right: 4px;
      border-radius: 6px 6px 0 0;
      font-size: 13px;
      color: #666;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      border: 1px solid transparent;
      border-bottom: none;
    }

    .emoji-nav-item:hover { background: #e9ecef; }

    .emoji-nav-item.active {
      background: white;
      color: #00b09b;
      font-weight: 600;
      border-color: #eee;
      position: relative;
      top: 1px;
    }

    .emoji-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      background: white;
    }

    .emoji-category-group { display: none; }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
    }
    
    .emoji-item {
      cursor: pointer;
      font-size: 22px;
      padding: 6px;
      text-align: center;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .emoji-item:hover {
      background-color: #f0f2f5;
      transform: scale(1.2);
    }
    
    @keyframes popIn {
      from { opacity: 0; transform: scale(0.95) translateY(10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      .topic-header { padding: 25px; margin-bottom: 25px; }
      .topic-header .icon { font-size: 40px; }
      .topic-header h1 { font-size: 22px; }
      .topic-header p { font-size: 14px; }
      
      .post-box { padding: 20px; }
      .post-card { padding: 20px; }
      .post-card .actions { gap: 15px; }
      .post-card .action-btn { padding: 8px 12px; font-size: 13px; }
    }
    
    @media (max-width: 480px) {
      .content { padding: 12px; }
      .topic-header { padding: 20px; }
      .post-box, .post-card { padding: 18px; }
      .post-card .actions { gap: 12px; }
      .post-card .action-btn { padding: 6px 10px; font-size: 12px; }
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="top-left">
      <button style="background:none;border:none;font-size:28px;cursor:pointer;margin-right:10px;" onclick="history.back()">â†</button>
      <span>è¯é¢˜è¯¦æƒ…</span>
    </div>
    <div class="top-right">
      <div style="display: flex; align-items: center; gap: 8px; margin-right: 15px;">
        <img id="navAvatar" src="" alt="Avatar" class="user-avatar" style="display: none;">
        <span>æ¬¢è¿ï¼Œ<span id="nickname">åŠ è½½ä¸­...</span></span>
      </div>
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
      <button class="switch-btn" onclick="logout()">åˆ‡æ¢è´¦æˆ·</button>
    </div>
  </div>

  <div class="content">
    <div class="topic-header">
      <div class="icon" id="topicIcon">ğŸ’¬</div>
      <h1 id="topicTitle">åŠ è½½ä¸­...</h1>
      <p id="topicDesc"></p>
    </div>

    <!-- ç»Ÿä¸€çš„å‘å¸ƒæ¡† (å›å¤è¯é¢˜) -->
    <div class="post-box">
      <span class="id">å½“å‰èº«ä»½ï¼š<span id="currentId">åŠ è½½ä¸­...</span><span id="currentLevel" style="display:none"></span></span>
      <textarea id="content" placeholder="è¯´è¯´ä½ çš„çœ‹æ³•..."></textarea>
      
      <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
      <div class="preview-list" id="previewList"></div>
      
      <div class="post-footer">
        <div class="post-tools">
          <input type="file" id="imageInput" accept="image/*" multiple onchange="handleImageSelect(event, 'main')" style="display:none">
          
          <button class="tool-btn" onclick="document.getElementById('imageInput').click()" title="æ·»åŠ å›¾ç‰‡">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
          </button>

          <div style="position: relative;">
            <button class="tool-btn" onclick="togglePostEmoji(event)" title="æ·»åŠ è¡¨æƒ…">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
            </button>
            <div id="post-emoji-picker" class="emoji-picker-popover" style="top: 40px; left: 0;"></div>
          </div>
        </div>

        <button class="send-btn" onclick="sendReply()">å‘é€</button>
      </div>
      <div class="upload-tip" style="font-size: 12px; color: #ccc; margin-top: 5px; text-align: right;">æœ€å¤š4å¼ ï¼Œæ”¯æŒè‡ªåŠ¨å‹ç¼©</div>
    </div>

    <!-- æ’åºå·¥å…·æ  -->
    <div class="sort-bar" style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; gap: 12px;">
      <span style="color: #666; font-size: 14px;">æ’åºæ–¹å¼:</span>
      <select id="sortSelect" onchange="changeSort()" style="padding: 6px 12px; border-radius: 8px; border: 1px solid #ddd; outline: none; background: white; color: #555; cursor: pointer;">
        <option value="time">æŒ‰æ—¶é—´</option>
        <option value="heat">æŒ‰çƒ­åº¦</option>
      </select>
      <select id="orderSelect" onchange="changeSort()" style="padding: 6px 12px; border-radius: 8px; border: 1px solid #ddd; outline: none; background: white; color: #555; cursor: pointer;">
        <option value="desc">å€’åº (æœ€æ–°/æœ€çƒ­)</option>
        <option value="asc">æ­£åº (æœ€æ—©/æœ€å†·)</option>
      </select>
    </div>

    <div id="replies-list"></div>
    
    <!-- åº•éƒ¨å ä½ç¬¦ -->
    <div style="height: 50px; width: 100%;"></div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item" onclick="location.href='/'">
      <img src="https://img.icons8.com/color/48/null/leaf.png" alt="å¹¿åœº">
      <div>æ ‘æ´å¹¿åœº</div>
    </div>
    <div class="nav-item active" onclick="location.href='/topic.html'">
      <img src="https://img.icons8.com/color/48/null/speech-bubble.png" alt="è¯é¢˜">
      <div>è¯é¢˜è®¨è®º</div>
    </div>
    <div class="nav-item" onclick="location.href='/tools.html'">
      <img src="https://img.icons8.com/color/48/null/wrench.png" alt="å·¥å…·">
      <div>å®ç”¨å·¥å…·</div>
    </div>
    <div class="nav-item" onclick="location.href='/capsule.html'">
      <img src="https://img.icons8.com/color/48/null/hourglass.png" alt="èƒ¶å›Š">
      <div>æ—¶é—´èƒ¶å›Š</div>
    </div>
    <div class="nav-item" onclick="location.href='/profile.html'">
      <img src="https://img.icons8.com/color/48/null/user.png" alt="æˆ‘çš„">
      <div>æˆ‘çš„</div>
    </div>
  </div>

  <script>
    if (!localStorage.getItem('token')) {
      window.location.href = '/login.html';
    }

    const nickname = localStorage.getItem('nickname') || 'è®¿å®¢';
    if (document.getElementById('nickname')) document.getElementById('nickname').textContent = nickname;
    if (document.getElementById('currentId')) document.getElementById('currentId').textContent = nickname;

    // ä»æœ¬åœ°ç¼“å­˜åŠ è½½ç­‰çº§
    const savedLevel = localStorage.getItem('level');
    if (savedLevel) {
      updateLevelDisplay(savedLevel);
    }

    // åˆå§‹åŒ–å¤´åƒæ˜¾ç¤º
    function initAvatar() {
      const avatarImg = document.getElementById('navAvatar');
      if (!avatarImg) return;
      
      const savedAvatar = localStorage.getItem('avatar');
      if (savedAvatar) {
        avatarImg.src = savedAvatar;
        avatarImg.style.display = 'block';
      } else {
        // é»˜è®¤å¤´åƒ
        avatarImg.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${nickname}`;
        avatarImg.style.display = 'block';
      }

      // è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
      fetch('/api/auth/me', {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      })
      .then(res => res.json())
      .then(data => {
        if (data.avatar) {
          avatarImg.src = data.avatar;
          localStorage.setItem('avatar', data.avatar);
        }
        if (data.nickname) {
          localStorage.setItem('nickname', data.nickname);
          document.getElementById('nickname').textContent = data.nickname;
          if (document.getElementById('currentId')) {
            document.getElementById('currentId').textContent = data.nickname;
          }
        }
        // æ›´æ–°ç­‰çº§
        if (data.level) {
          localStorage.setItem('level', data.level);
          updateLevelDisplay(data.level);
        }
      })
      .catch(err => console.error('Failed to fetch user info', err));
    }

    // æ›´æ–°ç­‰çº§æ˜¾ç¤º
    function updateLevelDisplay(level) {
      const levelEl = document.getElementById('currentLevel');
      if (levelEl) {
        levelEl.className = `level-tag ${getLevelClass(level)}`;
        levelEl.innerHTML = `Lv.${level}`;
        levelEl.style.display = 'inline-flex';
        levelEl.title = 'ç‚¹å‡»æŸ¥çœ‹ç­‰çº§è¯¦æƒ…';
        levelEl.onclick = () => showLevelDetails(level);
      }
    }

    function showLevelDetails(level) {
      alert(`ã€æˆ‘çš„ç­‰çº§ã€‘\nå½“å‰ç­‰çº§ï¼šLv.${level}\n\nå¤šå‘å¸–ã€å¤šäº’åŠ¨ã€æ¯æ—¥ç­¾åˆ°å¯ä»¥è·å–ç»éªŒå€¼å‡çº§å“¦ï¼`);
    }
    
    initAvatar();

    function logout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºæˆ–åˆ‡æ¢è´¦æˆ·å—ï¼Ÿ')) {
        localStorage.removeItem('token');
        localStorage.removeItem('nickname');
        localStorage.removeItem('avatar');
        window.location.href = '/login.html';
      }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const topicId = urlParams.get('id');

    // è·å–ç­‰çº§æ ·å¼ç±» (ç¡®ä¿é€»è¾‘è¦†ç›–å…¨é¢)
    function getLevelClass(level) {
      if (!level || level < 1) return 'lv-1';
      if (level >= 10) return 'lv-10';
      if (level >= 7) return 'lv-7';
      if (level >= 4) return 'lv-4';
      return 'lv-1';
    }

    // ç»Ÿä¸€çš„è¡¨æƒ…åˆ—è¡¨ (ä¸ index.html ä¿æŒä¸€è‡´)
    const emojiList = {
      'é»˜è®¤': ['ğŸ˜Š','ğŸ˜‚','ğŸ˜','ğŸ¤”','ğŸ‘','â¤ï¸','ğŸ‰','ğŸ˜¢','ğŸ˜†','ğŸ˜˜','ğŸ˜','ğŸ˜‰','ğŸ˜','ğŸ˜´','ğŸ˜­','ğŸ¤£','ğŸ˜…','ğŸ˜‡','ğŸ™‚','ğŸ™ƒ','ğŸ˜‹','ğŸ˜›','ğŸ¤‘','ğŸ¤—','ğŸ¤”','ğŸ¤','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤§','ğŸ˜µ','ğŸ¤ ','ğŸ˜','ğŸ¤“','ğŸ˜•','ğŸ˜Ÿ','â˜¹ï¸','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ‘¾','ğŸ¤–','ğŸ˜º','ğŸ˜¸','ğŸ˜¹','ğŸ˜»','ğŸ˜¼','ğŸ˜½','ğŸ™€','ğŸ˜¿','ğŸ˜¾'],
      'åŠ¨ç‰©': ['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ½','ğŸ¸','ğŸµ','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ’','ğŸ”','ğŸ§','ğŸ¦','ğŸ¤','ğŸ£','ğŸ¥','ğŸ¦†','ğŸ¦…','ğŸ¦‰','ğŸ¦‡','ğŸº','ğŸ—','ğŸ´','ğŸ¦„','ğŸ','ğŸ›','ğŸ¦‹','ğŸŒ','ğŸš','ğŸ','ğŸœ','ğŸ•·','ğŸ•¸','ğŸ¢','ğŸ','ğŸ¦','ğŸ¦‚','ğŸ¦€','ğŸ¦‘','ğŸ™','ğŸ¦','ğŸ ','ğŸŸ','ğŸ¡','ğŸ¬','ğŸ¦ˆ','ğŸ³','ğŸ‹','ğŸŠ','ğŸ†','ğŸ…','ğŸƒ','ğŸ‚','cow','ğŸ¦Œ','dromedary_camel','camel','elephant','rhinoceros','gorilla','horse','pig','goat','ram','sheep','dog','poodle','cat','rooster','turkey','dove','rabbit','mouse','rat','chipmunk','paws','dragon','dragon_face','cactus','christmas_tree','evergreen_tree','deciduous_tree','palm_tree','seedling','herb','shamrock','four_leaf_clover','bamboo','tanabata_tree','leaves','fallen_leaf','maple_leaf','mushroom','ğŸŒ¾','ğŸ’','ğŸŒ·','ğŸŒ¹','ğŸ¥€','ğŸŒ»','ğŸŒ¼','ğŸŒ¸','ğŸŒº','ğŸŒ','ğŸŒ','ğŸŒ','ğŸŒ•','ğŸŒ–','ğŸŒ—','ğŸŒ˜','ğŸŒ‘','ğŸŒ’','ğŸŒ“','ğŸŒ”','ğŸŒš','ğŸŒ','ğŸŒ','ğŸŒ›','ğŸŒœ','ğŸŒ™','ğŸ’«','â­ï¸','ğŸŒŸ','âœ¨','âš¡ï¸','ğŸ”¥','ğŸ’¥','â˜„ï¸','â˜€ï¸','ğŸŒ¤','â›…ï¸','ğŸŒ¥','â˜ï¸','ğŸŒ¦','ğŸŒ§','â›ˆ','ğŸŒ©','ğŸŒ¨','â„ï¸','â˜ƒï¸','â›„ï¸','ğŸŒ¬','ğŸ’¨','ğŸŒª','ğŸŒ«','ğŸŒŠ','ğŸ’§','ğŸ’¦','â˜”ï¸'],
      'ç‰©å“': ['ğŸ','ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸˆ','ğŸ’','ğŸ‘','ğŸ','ğŸ¥','ğŸ¥‘','ğŸ…','ğŸ†','ğŸ¥’','ğŸ¥•','ğŸŒ½','ğŸŒ¶','ğŸ¥”','ğŸ ','ğŸŒ°','ğŸ¥œ','ğŸ¯','ğŸ¥','ğŸ','ğŸ¥–','ğŸ§€','ğŸ¥š','ğŸ³','ğŸ¥“','ğŸ¥','ğŸ¤','ğŸ—','ğŸ–','ğŸ•','ğŸŒ­','ğŸ”','ğŸŸ','ğŸ¥™','ğŸŒ®','ğŸŒ¯','ğŸ¥—','ğŸ¥˜','ğŸ','ğŸœ','ğŸ²','ğŸ¥','ğŸ£','ğŸ±','ğŸ›','ğŸš','ğŸ™','ğŸ˜','ğŸ¢','ğŸ¡','ğŸ§','ğŸ¨','ğŸ¦','ğŸ°','ğŸ‚','ğŸ®','ğŸ­','ğŸ¬','ğŸ«','ğŸ¿','ğŸ©','ğŸª','ğŸ¥›','ğŸ¼','â˜•ï¸','ğŸµ','ğŸ¶','ğŸº','ğŸ»','ğŸ¥‚','ğŸ·','ğŸ¥ƒ','ğŸ¸','ğŸ¹','ğŸ¾','ğŸ¥„','ğŸ´','ğŸ½','âš½ï¸','ğŸ€','ğŸˆ','âš¾ï¸','ğŸ¾','ğŸ','ğŸ‰','ğŸ±','ğŸ“','ğŸ¸','ğŸ¥…','ğŸ’','ğŸ‘','ğŸ','â›³ï¸','ğŸ¹','ğŸ£','ğŸ¥Š','ğŸ¥‹','â›¸','ğŸ¿','â›·','ğŸ‚','ğŸ‹ï¸','ğŸ¤º','ğŸ¤¼','ğŸ¤¸','â›¹ï¸','ğŸ¤¾','ğŸŒï¸','ğŸ„','ğŸŠ','ğŸ¤½','ğŸš£','ğŸ‡','ğŸš´','ğŸšµ','ğŸ','ğŸ','ğŸ¤¸','ğŸ¤¹','ğŸª','ğŸ­','ğŸ¨','ğŸ°','ğŸš‚','ğŸšƒ','ğŸš„','ğŸš…','ğŸš†','ğŸš‡','ğŸšˆ','ğŸš‰','ğŸšŠ','ğŸš','ğŸš','ğŸš‹','ğŸšŒ','ğŸš','ğŸš','ğŸš','ğŸš‘','ğŸš’','ğŸš“','ğŸš”','ğŸš•','ğŸš–','ğŸš—','ğŸš˜','ğŸš™','ğŸšš','ğŸš›','ğŸšœ','ğŸš²','ğŸ›´','ğŸ›µ','ğŸš','ğŸ›£','ğŸ›¤','â›½ï¸','ğŸš¨','ğŸš¥','ğŸš¦','ğŸš§','ğŸ›‘','âš“ï¸','â›µï¸','ğŸ›¶','ğŸš¤','ğŸ›³','â›´','ğŸ›¥','ğŸš¢','âœˆï¸','ğŸ›©','ğŸ›«','ğŸ›¬','ğŸ’º','ğŸš','ğŸšŸ','ğŸš ','ğŸš¡','ğŸš€','ğŸ›°','ğŸ›','ğŸšª','ğŸ›Œ','ğŸ›','ğŸ›‹','ğŸš½','ğŸš¿','ğŸ›','âŒ›ï¸','â³','âŒšï¸','â°','â±','â²','ğŸ•°','ğŸ•›','ğŸ•§','ğŸ•','ğŸ•œ','ğŸ•‘','ğŸ•','ğŸ•’','ğŸ•','ğŸ•“','ğŸ•Ÿ','ğŸ•”','ğŸ• ','ğŸ••','ğŸ•¡','ğŸ•–','ğŸ•¢','ğŸ•—','ğŸ•£','ğŸ•˜','ğŸ•¤','ğŸ•™','ğŸ•¥','ğŸ•š','ğŸ•¦','ğŸŒ‘','ğŸŒ’','ğŸŒ“','ğŸŒ”','ğŸŒ•','ğŸŒ–','ğŸŒ—','ğŸŒ˜','ğŸŒ™','ğŸŒš','ğŸŒ›','ğŸŒœ','ğŸŒ¡','â˜€ï¸','ğŸŒ','ğŸŒ','â­','ğŸŒŸ','ğŸŒ ','â˜ï¸','â›…','â›ˆ','ğŸŒ¤','ğŸŒ¥','ğŸŒ¦','ğŸŒ§','ğŸŒ¨','ğŸŒ©','ğŸŒª','ğŸŒ«','ğŸŒ¬','ğŸŒ€','ğŸŒˆ','ğŸŒ‚','â˜”','âš¡','â„ï¸','â˜ƒï¸','â›„','â˜„ï¸','ğŸ”¥','ğŸ’§','ğŸŒŠ']
    };

    // åˆ‡æ¢è¡¨æƒ…åˆ†ç±»
    function switchEmojiCategory(pickerId, categoryName) {
      const picker = document.getElementById(pickerId);
      if (!picker) return;

      picker.querySelectorAll('.emoji-nav-item').forEach(item => {
        if (item.dataset.category === categoryName) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });

      picker.querySelectorAll('.emoji-category-group').forEach(group => {
        if (group.dataset.category === categoryName) {
          group.style.display = 'block';
        } else {
          group.style.display = 'none';
        }
      });
    }

    // æ¸²æŸ“è¡¨æƒ…é€‰æ‹©å™¨HTML
    function renderEmojiPicker(elementId, replyId = null) {
      const picker = document.getElementById(elementId);
      if (!picker || picker.innerHTML !== '') return;

      let navHtml = '<div class="emoji-nav">';
      let contentHtml = '<div class="emoji-content">';
      
      Object.keys(emojiList).forEach((category, index) => {
        const isActive = index === 0;
        const activeClass = isActive ? 'active' : '';
        const displayStyle = isActive ? 'block' : 'none';
        
        navHtml += `<div class="emoji-nav-item ${activeClass}" data-category="${category}" onclick="event.stopPropagation(); switchEmojiCategory('${elementId}', '${category}')">${category}</div>`;
        
        contentHtml += `<div class="emoji-category-group" data-category="${category}" style="display: ${displayStyle}">`;
        contentHtml += '<div class="emoji-grid">';
        emojiList[category].forEach(emoji => {
           const onclick = replyId 
              ? `insertEmoji('${replyId}', '${emoji}')`
              : `insertPostEmoji('${emoji}')`;
           contentHtml += `<div class="emoji-item" onclick="event.stopPropagation(); ${onclick}">${emoji}</div>`;
        });
        contentHtml += '</div></div>';
      });
      
      navHtml += '</div>';
      contentHtml += '</div>';
      
      picker.innerHTML = navHtml + contentHtml;
    }

    // åˆ‡æ¢å‘å¸ƒæ¡†è¡¨æƒ…é€‰æ‹©å™¨
    function togglePostEmoji(e) {
      e.stopPropagation();
      const pickerId = 'post-emoji-picker';
      const picker = document.getElementById(pickerId);
      
      // å…³é—­å…¶ä»–
      document.querySelectorAll('.emoji-picker-popover, .emoji-picker').forEach(el => {
        if (el !== picker) el.classList.remove('show');
      });
      
      renderEmojiPicker(pickerId);
      picker.classList.toggle('show');
      
      // ä¿®å¤å‘å¸–æ¡†è¢«é®æŒ¡ï¼šæå‡ post-box å±‚çº§
      const postBox = picker.closest('.post-box');
      if (postBox) {
         if (picker.classList.contains('show')) {
           postBox.style.zIndex = '10000';
           postBox.style.position = 'relative';
         } else {
           setTimeout(() => {
             if (!picker.classList.contains('show')) {
               postBox.style.zIndex = '';
             }
           }, 300);
         }
      }
    }

    // æ’å…¥è¡¨æƒ…åˆ°å‘å¸ƒæ¡†
    function insertPostEmoji(emoji) {
      const input = document.getElementById('content');
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;
      input.value = text.substring(0, start) + emoji + text.substring(end);
      input.focus();
      input.setSelectionRange(start + emoji.length, start + emoji.length);
    }

    // æ’å…¥è¡¨æƒ…åˆ°è¯„è®ºæ¡†
    function insertEmoji(replyId, emoji) {
      const input = document.getElementById('comment-input-' + replyId);
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;
      input.value = text.substring(0, start) + emoji + text.substring(end);
      input.focus();
      input.setSelectionRange(start + emoji.length, start + emoji.length);
      // toggleEmojiPicker(replyId); // ä¿æŒæ‰“å¼€æ–¹ä¾¿è¿ç»­è¾“å…¥
    }

    // åˆ‡æ¢è¯„è®ºè¡¨æƒ…é€‰æ‹©å™¨
    function toggleEmojiPicker(replyId) {
      const pickerId = 'emoji-picker-' + replyId;
      const picker = document.getElementById(pickerId);
      const postCard = picker.closest('.post-card');
      
      document.querySelectorAll('.emoji-picker-popover, .emoji-picker').forEach(el => {
        if (el !== picker) {
          el.classList.remove('show');
          const card = el.closest('.post-card');
          if (card) card.style.zIndex = '';
        }
      });

      renderEmojiPicker(pickerId, replyId);
      picker.classList.toggle('show');
      
      // å…³é”®ä¿®å¤ï¼šå½“è¡¨æƒ…æ¡†æ˜¾ç¤ºæ—¶ï¼Œå¼ºåˆ¶æå‡å½“å‰å¸–å­å¡ç‰‡çš„å±‚çº§ï¼Œé˜²æ­¢è¢«ä¸‹æ–¹å¸–å­é®æŒ¡
      if (postCard) {
        if (picker.classList.contains('show')) {
          postCard.style.zIndex = '10000';
          postCard.style.position = 'relative'; // ç¡®ä¿z-indexç”Ÿæ•ˆ
        } else {
          // å»¶è¿Ÿæ¢å¤ z-indexï¼Œé¿å…åŠ¨ç”»è¿‡ç¨‹ä¸­çš„é—ªçƒ
          setTimeout(() => {
            if (!picker.classList.contains('show')) {
              postCard.style.zIndex = '';
            }
          }, 300);
        }
      }
    }

    // ç”Ÿæˆè¡¨æƒ…é€‰æ‹©å™¨å®¹å™¨HTML
    function generateEmojiPickerHTML(replyId) {
      return `<div class="emoji-picker" id="emoji-picker-${replyId}" onclick="event.stopPropagation()"></div>`; 
    }

    // å…¨å±€ç‚¹å‡»å…³é—­
    document.addEventListener('click', function(e) {
      document.querySelectorAll('.emoji-picker-popover, .emoji-picker').forEach(el => {
        if (e.target.closest('.tool-btn') || e.target.closest('.emoji-btn') || e.target.closest('.comment-action-btn') || e.target.closest('.comment-tool-btn')) return;
        el.classList.remove('show');
        const card = el.closest('.post-card');
        if (card) card.style.zIndex = '';
        const postBox = el.closest('.post-box');
        if (postBox) postBox.style.zIndex = '';
      });
    });

    // å›¾ç‰‡å¤„ç†
    const pendingImages = new Map();

    async function handleImageSelect(event, replyId = 'main') {
      const files = event.target.files;
      if (!files.length) return;

      let currentImages = pendingImages.get(replyId) || [];
      if (currentImages.length + files.length > 4) {
        alert('æœ€å¤šåªèƒ½ä¸Šä¼  4 å¼ å›¾ç‰‡');
        event.target.value = '';
        return;
      }

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (!file.type.startsWith('image/')) continue;
        try {
          const compressedBase64 = await compressImage(file);
          currentImages.push(compressedBase64);
        } catch (err) {
          console.error('å›¾ç‰‡å‹ç¼©å¤±è´¥:', err);
        }
      }
      
      pendingImages.set(replyId, currentImages);
      updatePreview(replyId);
      event.target.value = '';
    }

    function updatePreview(replyId) {
      const listId = replyId === 'main' ? 'previewList' : 'comment-preview-' + replyId;
      const list = document.getElementById(listId);
      if (!list) return;

      const images = pendingImages.get(replyId) || [];
      
      if (images.length === 0) {
        list.style.display = 'none';
        list.innerHTML = '';
        return;
      }
      
      list.style.display = 'flex';
      list.innerHTML = images.map((img, index) => `
        <div class="${replyId === 'main' ? 'preview-item' : 'comment-preview-item'}">
          <img src="${img}" class="preview-image">
          <button class="remove-btn" onclick="removeImage('${replyId}', ${index})">Ã—</button>
        </div>
      `).join('');
    }

    function removeImage(replyId, index) {
      let images = pendingImages.get(replyId) || [];
      images.splice(index, 1);
      pendingImages.set(replyId, images);
      updatePreview(replyId);
    }

    function compressImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const maxWidth = 1024;
            const maxHeight = 1024;
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > maxWidth) {
                height = Math.round((height * maxWidth) / width);
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = Math.round((width * maxHeight) / height);
                height = maxHeight;
              }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', 0.7));
          };
          img.onerror = reject;
        };
        reader.onerror = reject;
      });
    }

    // ä¸šåŠ¡é€»è¾‘
    let currentSort = 'time';
    let currentOrder = 'desc';

    function changeSort() {
      currentSort = document.getElementById('sortSelect').value;
      currentOrder = document.getElementById('orderSelect').value;
      loadTopic();
    }

    async function loadTopic() {
      try {
        // è·å–è¯é¢˜è¯¦æƒ…ï¼Œè®¾ç½®è¾ƒå¤§çš„limitä»¥æ˜¾ç¤ºæ‰€æœ‰å›å¤ï¼ŒåŠ æ—¶é—´æˆ³é˜²ç¼“å­˜
        const res = await fetch(`/api/topics/${topicId}?limit=1000&_t=${new Date().getTime()}&sort=${currentSort}&order=${currentOrder}`);
        const topic = await res.json();

        document.getElementById('topicIcon').textContent = topic.icon || 'ğŸ’¬';
        document.getElementById('topicTitle').textContent = topic.title;
        document.getElementById('topicDesc').textContent = topic.description || '';

        const list = document.getElementById('replies-list');
        list.innerHTML = topic.replies.map(r => {
           let levelTag = '';
           if (r.authorLevel) {
             levelTag = `<span class="level-tag ${getLevelClass(r.authorLevel)}" onclick="event.stopPropagation(); showLevelDetails(${r.authorLevel})" title="ç‚¹å‡»æŸ¥çœ‹ç­‰çº§è¯¦æƒ…">Lv.${r.authorLevel}</span>`;
           }

           let imagesHtml = '';
           if (r.images && r.images.length > 0) {
             imagesHtml = `
               <div class="post-images" style="margin-top:8px;" onclick="event.stopPropagation()">
                 ${r.images.map(img => `<img src="${img}" class="post-image" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/400x400?text=Image+Error';">`).join('')}
               </div>
             `;
           }
           
           return `
          <div class="post-card" onclick="toggleComments('${r._id}')">
            <p>${r.content.replace(/\n/g,'<br>')}</p>
            ${imagesHtml}
            <div class="post-author-row">
              <div class="author-info">
                <img class="user-avatar" src="${r.isAnonymous ? 'https://api.dicebear.com/7.x/avataaars/svg?seed=Anonymous' : (r.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${r.author}`)}" alt="${r.author}" onerror="this.src='https://placehold.co/100x100?text=Avatar'" style="width:24px;height:24px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-right:8px;">
                <span class="author">${r.author}</span>
                ${levelTag}
              </div>
              <span class="time">${new Date(r.createdAt).toLocaleString()}</span>
            </div>
            <div class="actions">
              <span class="action-btn like" id="like-btn-${r._id}" onclick="event.stopPropagation(); toggleLike('${r._id}')">
                <span id="like-icon-${r._id}">ğŸ¤</span> ç‚¹èµ (<span class="like-count" id="like-${r._id}">${r.likeCount || 0}</span>)
              </span>
              <span class="action-btn comment" onclick="event.stopPropagation(); toggleComments('${r._id}')">
                ğŸ’¬ è¯„è®º (<span class="comment-count" id="comment-${r._id}">${r.commentCount || 0}</span>)
              </span>
            </div>
            <div class="comments" id="comments-${r._id}"></div>
          </div>
        `}).join('') || '<div class="empty" style="text-align:center;padding:40px;color:#999;"><p>æš‚æ— è®¨è®ºï¼Œæ¥æ‰“ç ´æ²‰é»˜å§ï½</p></div>';

        // ä»…æ£€æŸ¥ç‚¹èµçŠ¶æ€ï¼Œä¸å†é‡æ–°åŠ è½½æ•°é‡
        topic.replies.forEach(r => checkLikeStatus(r._id));
      } catch (err) {
        console.log('åŠ è½½è¯é¢˜å¤±è´¥', err);
      }
    }

    // æ£€æŸ¥ç‚¹èµçŠ¶æ€
    async function checkLikeStatus(replyId) {
      try {
        const checkRes = await fetch(`/api/likes/check?topicReplyId=${replyId}&userNickname=${nickname}`);
        const checkData = await checkRes.json();
        const likeBtn = document.getElementById('like-btn-' + replyId);
        const likeIcon = document.getElementById('like-icon-' + replyId);
        
        if (checkData.isLiked) {
          likeBtn.classList.add('liked');
          likeIcon.textContent = 'â¤ï¸';
        }
      } catch (err) {
        console.log('æ£€æŸ¥ç‚¹èµçŠ¶æ€å¤±è´¥', err);
      }
    }

    // å›å¤è¯é¢˜
    async function sendReply() {
      const content = document.getElementById('content').value.trim();
      const images = pendingImages.get('main') || [];
      
      if (!content && images.length === 0) return alert('å†™ç‚¹ä¸œè¥¿æˆ–å‘å¼ å›¾å†å‘å“¦ï½');

      const sendBtn = document.querySelector('.post-box .send-btn');
      const originalText = 'å‘é€';
      
      try {
        sendBtn.disabled = true;
        sendBtn.innerHTML = 'â³ å‘é€ä¸­...';

        const res = await fetch(`/api/topics/${topicId}/reply`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ 
            content: content || 'åˆ†äº«äº†ä¸€å¼ å›¾ç‰‡', 
            author: nickname, 
            isAnonymous: false,
            images: images
          })
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.message || 'å›å¤å¤±è´¥');
        }

        document.getElementById('content').value = '';
        pendingImages.set('main', []);
        updatePreview('main');
        
        sendBtn.innerHTML = 'âœ… å›å¤æˆåŠŸ';
        
        // ç«‹å³åˆ·æ–°
        loadTopic();
        
        setTimeout(() => {
          sendBtn.disabled = false;
          sendBtn.innerHTML = originalText;
        }, 1500);

      } catch (err) {
        alert('å›å¤å‘é€å¤±è´¥: ' + err.message);
        console.error(err);
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
      }
    }

    // å±•å¼€/æŠ˜å è¯„è®ºåŒº (åŠ¨æ€æ¸²æŸ“)
    function toggleComments(replyId) {
      const comments = document.getElementById('comments-' + replyId);
      comments.classList.toggle('show');
      
      if (comments.classList.contains('show')) {
        if (comments.innerHTML.trim() === '') {
          comments.innerHTML = `
            <div class="comment-box">
              <span class="id">è¯„è®ºå›å¤</span>
              <div class="comment-input-area">
                <textarea class="comment-textarea" id="comment-input-${replyId}" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." onclick="event.stopPropagation();" onfocus="event.stopPropagation();"></textarea>
                <div class="comment-preview-list" id="comment-preview-${replyId}"></div>
              </div>
              
              <div class="comment-footer">
                <div class="comment-tools">
                  <input type="file" id="comment-image-${replyId}" accept="image/*" multiple onchange="handleImageSelect(event, '${replyId}')" style="display:none">
                  
                  <button class="comment-tool-btn" onclick="document.getElementById('comment-image-${replyId}').click()" title="æ·»åŠ å›¾ç‰‡">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                  </button>
                  
                  <button class="comment-tool-btn" onclick="event.stopPropagation(); toggleEmojiPicker('${replyId}')" title="è¡¨æƒ…">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                  </button>
                  
                  ${generateEmojiPickerHTML(replyId)}
                </div>
                
                <button class="comment-send-btn" onclick="event.stopPropagation(); sendReplyComment('${replyId}')">å‘é€</button>
              </div>
            </div>
            <div id="comment-list-${replyId}">åŠ è½½ä¸­...</div>
          `;
        }
        loadComments(replyId);
      }
    }

    // åŠ è½½è¯„è®ºåˆ—è¡¨
    async function loadComments(replyId) {
      try {
        const commentRes = await fetch(`/api/comments/topic-reply/${replyId}`);
        const comments = await commentRes.json();
        
        // æ›´æ–°è¯„è®ºæ•°æ˜¾ç¤º
        const commentCountEl = document.getElementById('comment-' + replyId);
        if (commentCountEl) commentCountEl.textContent = comments.length;

        const list = document.getElementById('comment-list-' + replyId);
        if (comments.length === 0) {
          list.innerHTML = '<p style="color:#999;padding:10px;">æš‚æ— è¯„è®ºï¼Œæ¥æŠ¢æ²™å‘ï½</p>';
        } else {
          list.innerHTML = comments.map(c => {
             let levelTag = '';
             if (c.authorLevel) {
               levelTag = `<span class="level-tag ${getLevelClass(c.authorLevel)}" onclick="event.stopPropagation(); showLevelDetails(${c.authorLevel})" title="ç‚¹å‡»æŸ¥çœ‹ç­‰çº§è¯¦æƒ…">Lv.${c.authorLevel}</span>`;
             }
             let imagesHtml = '';
             if (c.images && c.images.length > 0) {
               imagesHtml = `
                 <div class="post-images" style="margin-top:8px;">
                   ${c.images.map(img => `<img src="${img}" class="post-image" onclick="window.open('${img}', '_blank')" style="width:80px;height:80px;" onerror="this.onerror=null;this.src='https://placehold.co/200x200?text=Error';">`).join('')}
                 </div>
               `;
             }
             return `
            <div class="comment-item">
              <div class="author-area">
                <img class="user-avatar" src="${c.authorAvatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${c.author}`}" alt="avatar" style="width:20px;height:20px;margin-right:5px;">
                <span style="font-weight: 500; color: #2d3748;">${c.author}</span>
                ${levelTag}
              </div>
              <div>${c.content}</div>
              ${imagesHtml}
              <small style="color:#ccc;float:right;">${new Date(c.createdAt).toLocaleString()}</small>
            </div>
          `}).join('');
        }
      } catch (err) {
        console.log('åŠ è½½è¯„è®ºå¤±è´¥', err);
      }
    }

    // å‘é€è¯„è®º (å›å¤)
    async function sendReplyComment(replyId) {
      const input = document.getElementById('comment-input-' + replyId);
      const content = input.value.trim();
      const images = pendingImages.get(replyId) || [];
      
      if (!content && images.length === 0) return alert('å†™ç‚¹è¯„è®ºæˆ–å‘å¼ å›¾å†å‘å“¦ï½');

      try {
        const res = await fetch('/api/comments/topic-reply', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ topicReplyId: replyId, content: content || 'åˆ†äº«äº†ä¸€å¼ å›¾ç‰‡', author: nickname, images })
        });
        
        if (!res.ok) throw new Error('å‘é€å¤±è´¥');

        input.value = '';
        pendingImages.set(replyId, []);
        updatePreview(replyId);
        loadComments(replyId); // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°è¯„è®º
      } catch (err) {
        alert('å‘é€å¤±è´¥: ' + err.message);
        console.error(err);
      }
    }

    // åŠ è½½ç‚¹èµæ•°å’Œè¯„è®ºæ•°
    async function loadLikeAndCommentCount(replyId) {
      try {
        const likeRes = await fetch(`/api/likes/topic-reply/${replyId}`);
        const likeData = await likeRes.json();
        const commentRes = await fetch(`/api/comments/topic-reply/${replyId}`);
        const comments = await commentRes.json();

        const likeEl = document.getElementById('like-' + replyId);
        if (likeEl) likeEl.textContent = likeData.count || 0;
        
        const commentEl = document.getElementById('comment-' + replyId);
        if (commentEl) commentEl.textContent = comments.length;

        // æ£€æŸ¥å½“å‰ç”¨æˆ·çš„ç‚¹èµçŠ¶æ€
        const checkRes = await fetch(`/api/likes/check?topicReplyId=${replyId}&userNickname=${nickname}`);
        const checkData = await checkRes.json();
        const likeBtn = document.getElementById('like-btn-' + replyId);
        const likeIcon = document.getElementById('like-icon-' + replyId);
        
        if (checkData.isLiked) {
          likeBtn.classList.add('liked');
          likeIcon.textContent = 'â¤ï¸';
        } else {
          likeBtn.classList.remove('liked');
          likeIcon.textContent = 'ğŸ¤';
        }
      } catch (err) {
        console.log('åŠ è½½æ•°é‡å¤±è´¥', err);
      }
    }

    // ç‚¹èµ/å–æ¶ˆç‚¹èµåˆ‡æ¢
    async function toggleLike(replyId) {
      const btn = document.getElementById('like-btn-' + replyId);
      const icon = document.getElementById('like-icon-' + replyId);
      const likeCountEl = document.getElementById('like-' + replyId);
      
      try {
        const isLiked = btn.classList.contains('liked');
        let currentCount = parseInt(likeCountEl.textContent || '0');

        if (isLiked) {
          // å–æ¶ˆç‚¹èµ
          await fetch('/api/likes', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ topicReplyId: replyId, userNickname: nickname })
          });
          btn.classList.remove('liked');
          icon.textContent = 'ğŸ¤';
          currentCount = Math.max(0, currentCount - 1);
        } else {
          // æ·»åŠ ç‚¹èµ
          await fetch('/api/likes', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ topicReplyId: replyId, userNickname: nickname })
          });
          btn.classList.add('liked');
          icon.textContent = 'â¤ï¸';
          currentCount++;
        }
        
        likeCountEl.textContent = currentCount;
      } catch (err) {
        console.log('ç‚¹èµæ“ä½œå¤±è´¥', err);
        loadLikeAndCommentCount(replyId); // å¤±è´¥å›é€€
      }
    }

    // ç›‘å¬æ–°å›å¤
    let lastReplyCount = 0;
    async function checkForNewReplies() {
      try {
        const res = await fetch(`/api/topics/${topicId}?limit=1000`);
        const topic = await res.json();
        // ä½¿ç”¨ totalReplies å­—æ®µè·å–å‡†ç¡®çš„å›å¤æ€»æ•°ï¼Œæˆ–è€…ç›´æ¥ç”¨è¿”å›çš„ replies é•¿åº¦ï¼ˆå› ä¸ºæˆ‘ä»¬è®¾ç½®äº† limit=1000ï¼‰
        const totalReplies = topic.replies.length;
        
        let totalComments = 0;
        topic.replies.forEach(reply => {
          totalComments += reply.comments ? reply.comments.length : 0;
        });
        
        const totalMessages = totalReplies + totalComments;
        
        if (totalMessages > lastReplyCount && lastReplyCount !== 0) {
          const newMessages = totalMessages - lastReplyCount;
          const notice = document.createElement('div');
          notice.style.cssText = 'position:fixed;top:20px;right:20px;background:#80cbc4;color:white;padding:15px;border-radius:10px;cursor:pointer;z-index:1000;';
          notice.innerHTML = `æœ‰ ${newMessages} æ¡æ–°æ¶ˆæ¯ï¼Œ<span style="text-decoration:underline;">ç‚¹å‡»åˆ·æ–°</span>`;
          notice.onclick = () => {
            loadTopic();
            document.body.removeChild(notice);
          };
          document.body.appendChild(notice);
          setTimeout(() => {
            if (document.body.contains(notice)) document.body.removeChild(notice);
          }, 3000);
        }
        lastReplyCount = totalMessages;
      } catch (err) {
        console.log('æ£€æŸ¥æ–°å›å¤å¤±è´¥', err);
      }
    }
    
    setInterval(checkForNewReplies, 30000);
    loadTopic();
  </script>
  <script src="image-viewer.js"></script>
</body>
</html>
