<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°æ¥šå›çš„æ ‘æ´ - å¹¿åœº</title>
  <style>
    /* ä¿æŒåŸé£æ ¼ */
    body { margin: 0; padding: 0; background: #f9f9f5; font-family: Arial, sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
    .top { padding: 15px 20px; background: #fff; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .top-left { display: flex; align-items: center; }
    .top-left img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
    .top-left span { font-weight: bold; color: #333; }
    .top-right { color: #999; font-size: 14px; display: flex; align-items: center; gap: 10px; }
    .top-right button { padding: 8px 15px; border: none; border-radius: 20px; cursor: pointer; font-size: 12px; }
    .logout-btn { background: #ff8a80; color: white; }
    .switch-btn { background: #fff3e0; color: #ff8a80; border: 1px solid #ff8a80; }

.content { 
  flex: 1; 
  padding: 20px; 
  overflow-y: auto; 
  padding-bottom: 80px; /* å…³é”®è¿™è¡Œï¼ç•™å‡ºåº•éƒ¨å¯¼èˆªç©ºé—´ */
}
    .title { text-align: center; font-size: 24px; color: #333; margin: 20px 0; }
    .subtitle { text-align: center; color: #666; margin-bottom: 30px; }

    .post-box { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; display: flex; align-items: center; }
    .post-box .id { color: #999; font-size: 12px; margin-right: 10px; }
    .post-box textarea { flex: 1; border: none; outline: none; font-size: 16px; resize: none; height: 60px; padding: 10px; }
    .post-box button { background: #80cbc4; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-size: 16px; }

    .post-card { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; cursor: pointer; }
    .post-card p { margin: 0 0 10px; }
    .post-card .author { color: #999; font-size: 14px; }
    .post-card .time { float: right; color: #ccc; font-size: 12px; }
    .post-card .actions { margin-top: 10px; display: flex; justify-content: flex-end; gap: 30px; font-size: 16px; color: #666; }
    .post-card .like { cursor: pointer; }
    .post-card .comment { cursor: pointer; }

    .post-card .comments { margin-top: 15px; background: #f0f0f0; padding: 10px; border-radius: 15px; display: none; }
    .post-card .comments.show { display: block; }
    .post-card .comment-input { display: flex; margin-top: 10px; }
    .post-card .comment-input textarea { flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 10px; resize: none; font-size: 14px; }
    .post-card .comment-input button { background: #80cbc4; color: white; border: none; padding: 10px 20px; border-radius: 20px; margin-left: 10px; cursor: pointer; }
    .post-card .comment-item { padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; }
    .post-card .comment-item:last-child { border-bottom: none; }

    .empty { text-align: center; color: #999; margin: 50px 0; }
    .empty img { width: 80px; margin-bottom: 20px; }

    .bottom-nav { background: #fff; display: flex; justify-content: space-around; padding: 15px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); position: fixed; bottom: 0; width: 100%; }
    .nav-item { text-align: center; color: #999; font-size: 12px; cursor: pointer; }
    .nav-item.active { color: #80cbc4; }
    .nav-item img { width: 24px; height: 24px; margin-bottom: 5px; }
  </style>
</head>
<body>
  <div class="top">
   <div class="top-left">
  <button style="background:none;border:none;font-size:28px;cursor:pointer;margin-right:10px;" onclick="history.back()">â†</button>
  <img src="logo.png" alt="Logo">
  <span>å°æ¥šå›çš„æ ‘æ´</span>
</div>
    <div class="top-right">
      æ¬¢è¿ï¼Œ<span id="nickname">åŠ è½½ä¸­...</span>
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
      <button class="switch-btn" onclick="logout()">åˆ‡æ¢è´¦æˆ·</button>
    </div>
  </div>

  <div class="content">
    <h1 class="title">æ ‘æ´å¹¿åœº</h1>
    <p class="subtitle">åœ¨å¤§æ ‘ä¸‹ï¼Œè‡ªç”±åœ°å‘¼å¸ï¼Œè‡ªç”±åœ°è¡¨è¾¾ã€‚</p>

    <div class="post-box">
      <span class="id">å½“å‰èº«ä»½ï¼š<span id="currentId">åŠ è½½ä¸­...</span></span>
      <textarea id="content" placeholder="ä»Šå¤©æœ‰ä»€ä¹ˆæƒ³å¯¹æ ‘æ´è¯´çš„å—ï¼Ÿ..."></textarea>
      <button onclick="send()">å‘é€</button>
    </div>

    <div id="posts-list"></div>

    <div class="empty" id="empty-state">
      <img src="https://img.icons8.com/color/96/null/leaf.png" alt="ç©º">
      <p>é£å¹è¿‡æ ‘æ¢¢ï¼Œå¹¿åœºä¸Šé™æ‚„æ‚„çš„...</p>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="location.href='/'">
      <img src="https://img.icons8.com/color/48/null/leaf.png" alt="å¹¿åœº">
      <div>æ ‘æ´å¹¿åœº</div>
    </div>
    <div class="nav-item" onclick="location.href='/topic.html'">
      <img src="https://img.icons8.com/color/48/null/speech-bubble.png" alt="è¯é¢˜">
      <div>è¯é¢˜è®¨è®º</div>
    </div>
    <div class="nav-item" onclick="location.href='/capsule.html'">
      <img src="https://img.icons8.com/color/48/null/hourglass.png" alt="èƒ¶å›Š">
      <div>æ—¶é—´èƒ¶å›Š</div>
    </div>
  </div>

  <script>
    if (!localStorage.getItem('token')) {
      window.location.href = '/login.html';
    }

    const nickname = localStorage.getItem('nickname') || 'è®¿å®¢';
    document.getElementById('nickname').textContent = nickname;
    document.getElementById('currentId').textContent = nickname;

    function logout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºæˆ–åˆ‡æ¢è´¦æˆ·å—ï¼Ÿ')) {
        localStorage.removeItem('token');
        localStorage.removeItem('nickname');
        window.location.href = '/login.html';
      }
    }

    async function loadPosts() {
      try {
        const res = await fetch('/api/posts');
        const posts = await res.json();
        const list = document.getElementById('posts-list');
        const empty = document.getElementById('empty-state');

        if (posts.length === 0) {
          empty.style.display = 'block';
          list.innerHTML = '';
          return;
        }

        empty.style.display = 'none';
        list.innerHTML = posts.map(p => `
          <div class="post-card" onclick="toggleComments('${p._id}')">
            <p>${p.content.replace(/\n/g,'<br>')}</p>
            <div>
              <span class="author">â€” ${p.author}</span>
              <span class="time">${new Date(p.createdAt).toLocaleString()}</span>
            </div>
            <div class="actions">
              <span class="like" onclick="event.stopPropagation(); likePost('${p._id}')">â¤ï¸ ç‚¹èµ (<span class="like-count" id="like-${p._id}">0</span>)</span>
              <span class="comment" onclick="event.stopPropagation(); toggleComments('${p._id}')">ğŸ’¬ è¯„è®º (<span class="comment-count" id="comment-${p._id}">0</span>)</span>
            </div>
            <div class="comments" id="comments-${p._id}">
              <div class="comment-input">
                <textarea id="comment-input-${p._id}" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." onclick="event.stopPropagation();" onfocus="event.stopPropagation();"></textarea>
                <button onclick="event.stopPropagation(); sendComment('${p._id}')">å‘é€</button>
              </div>
              <div id="comment-list-${p._id}">åŠ è½½ä¸­...</div>
            </div>
          </div>
        `).join('');

        // åŠ è½½æ¯æ¡æ ‘æ´çš„ç‚¹èµæ•°å’Œè¯„è®ºæ•°
        posts.forEach(p => loadLikeAndCommentCount(p._id));
      } catch (err) {
        console.log('åŠ è½½å¤±è´¥', err);
      }
    }

    // åŠ è½½ç‚¹èµæ•°å’Œè¯„è®ºæ•°
    async function loadLikeAndCommentCount(postId) {
      try {
        const likeRes = await fetch(`/api/likes/post/${postId}`);
        const likeData = await likeRes.json();
        const commentRes = await fetch(`/api/comments/post/${postId}`);
        const comments = await commentRes.json();

        document.getElementById('like-' + postId).textContent = likeData.count || 0;
        document.getElementById('comment-' + postId).textContent = comments.length;

        const list = document.getElementById('comment-list-' + postId);
        if (comments.length === 0) {
          list.innerHTML = '<p style="color:#999;padding:10px;">æš‚æ— è¯„è®ºï¼Œæ¥æŠ¢æ²™å‘ï½</p>';
        } else {
          list.innerHTML = comments.map(c => `
            <div class="comment-item">
              <strong>${c.author}</strong>: ${c.content}
              <small style="color:#ccc;float:right;">${new Date(c.createdAt).toLocaleString()}</small>
            </div>
          `).join('');
        }
      } catch (err) {
        console.log('åŠ è½½æ•°é‡å¤±è´¥', err);
      }
    }

    // ç‚¹èµ
    async function likePost(postId) {
      await fetch('/api/likes', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ postId, userNickname: nickname })
      });

      loadLikeAndCommentCount(postId);
    }

    // å‘é€è¯„è®º
    async function sendComment(postId) {
      const input = document.getElementById('comment-input-' + postId);
      const content = input.value.trim();
      if (!content) return alert('å†™ç‚¹è¯„è®ºå†å‘å“¦ï½');

      await fetch('/api/comments/post', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ postId, content, author: nickname })
      });

      input.value = '';
      loadLikeAndCommentCount(postId);
    }

    function toggleComments(postId) {
      const comments = document.getElementById('comments-' + postId);
      comments.classList.toggle('show');
    }

    async function send() {
      const content = document.getElementById('content').value.trim();
      if (!content) return alert('å†™ç‚¹ä¸œè¥¿å†å‘å“¦ï½');

      await fetch('/api/posts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ content, author: nickname, isAnonymous: false })
      });

      document.getElementById('content').value = '';
      alert('å·²å‘é€ï¼Œè€å¸ˆå®¡æ ¸åå°±ä¼šæ˜¾ç¤ºï½');
      loadPosts();
    }

    loadPosts();
    setInterval(loadPosts, 10000);
  </script>
</body>
</html>