<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ‘æ´å¹¿åœº</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* æ ‡é¢˜æ ·å¼ */
    .title {
      text-align: center;
      font-size: 32px;
      color: #2d3748;
      margin: 25px 0 10px;
      font-weight: 700;
      letter-spacing: -1px;
    }
    
    .subtitle {
      text-align: center;
      color: #718096;
      margin-bottom: 35px;
      font-size: 16px;
      font-weight: 500;
    }

    /* å‘å¸ƒæ¡†æ ·å¼ - ç®€çº¦é£æ ¼ */
    .post-box {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      margin-bottom: 24px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 15px;
      position: relative;
      z-index: 100;
      transition: all 0.3s ease;
    }
    
    .post-box:hover {
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    .post-box .id {
      color: #718096;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      margin-bottom: 5px;
    }
    
    .post-box textarea {
      width: 100%;
      border: none;
      outline: none;
      font-size: 16px;
      resize: none;
      min-height: 80px;
      padding: 12px 16px;
      background: #f9fafb;
      border-radius: 12px;
      color: #2d3748;
      font-family: inherit;
      transition: all 0.3s ease;
    }
    
    .post-box textarea:focus {
      background: white;
      box-shadow: 0 0 0 3px rgba(0, 176, 155, 0.1);
    }
    
    .post-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 5px;
      border-top: 1px solid rgba(0,0,0,0.05);
      padding-top: 10px;
      width: 100%;
    }
    
    .post-tools {
      display: flex;
      gap: 15px;
      position: relative;
    }
    
    .tool-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      color: #999;
      padding: 5px;
      border-radius: 5px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .tool-btn:hover {
      background: #f5f5f5;
      color: #00b09b;
    }
    
    .send-btn {
      background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 28px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 176, 155, 0.3);
    }
    
    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 176, 155, 0.4);
      background: linear-gradient(135deg, #009c87 0%, #85b535 100%);
    }

    /* å¸–å­å¡ç‰‡æ ·å¼ - Windows 7/è‹¹æœOS26é£æ ¼åŠé€æ˜æ•ˆæœ */
    .post-card { 
      background: rgba(255, 255, 255, 0.7); 
      backdrop-filter: blur(15px); 
      -webkit-backdrop-filter: blur(15px); 
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.12); 
      margin-bottom: 25px;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      position: relative;
      /* overflow: hidden;  ç§»é™¤æ­¤å±æ€§ä»¥å…è®¸è¡¨æƒ…æ¡†æº¢å‡ºæ˜¾ç¤º */
    }
    
    .post-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #00b09b, #96c93d);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s ease;
    }
    
    .post-card:hover {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 15px 50px rgba(0,0,0,0.15);
      transform: translateY(-3px);
    }
    
    .post-card:hover::before {
      transform: scaleX(1);
    }
    
    .post-card p {
      margin: 0 0 15px;
      color: #4a5568;
      font-size: 16px;
      line-height: 1.7;
      word-wrap: break-word;
    }
    
    .post-card .post-author-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    .post-card .author {
      color: #2d3748; /* ä¸»æ–‡æœ¬é¢œè‰² */
      font-size: 14px;
      font-weight: 600;
    }
    
    .post-card .time {
      color: #a0aec0; /* è¾…åŠ©æ–‡æœ¬é¢œè‰² */
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap; /* é˜²æ­¢æ—¶é—´æ¢è¡Œ */
      margin-left: 10px; /* æœ€å°é—´è· */
    }
    
    /* å¾®ä¿¡é£æ ¼çš„ç‚¹èµè¯„è®ºæ ·å¼ */
    .post-card .actions {
      margin-top: 18px;
      padding-top: 15px;
      border-top: 2px solid #f7fafc;
      display: flex;
      justify-content: flex-start;
      gap: 25px;
      font-size: 14px;
      color: #718096;
    }
    
    .post-card .action-btn {
      cursor: pointer;
      padding: 10px 16px;
      border-radius: 20px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }
    
    .post-card .action-btn:hover {
      background: #f7fafc;
      color: #4a5568;
      transform: translateY(-1px);
    }
    
    .post-card .like.liked {
      color: #e53e3e;
    }
    
    .post-card .action-btn.like .like-count {
      font-size: 13px;
      font-weight: 600;
    }
    
    /* ç‚¹èµåŠ¨ç”»æ•ˆæœ */
    @keyframes likeAnimation {
      0% { transform: scale(1); }
      50% { transform: scale(1.5); }
      100% { transform: scale(1); }
    }
    
    .post-card .action-btn.like.liked [id^="like-icon"] {
      animation: likeAnimation 0.5s ease;
    }
    
    /* ç§»åŠ¨ç«¯é€‚é…ä¼˜åŒ– */
    @media (max-width: 768px) {
      /* è°ƒæ•´å…¨å±€é—´è· */
      body {
        font-size: 14px;
      }
      
      .title {
        font-size: 26px;
        margin: 20px 0 8px;
      }
      
      .subtitle {
        font-size: 14px;
        margin-bottom: 25px;
      }
      
      /* å‘å¸ƒæ¡†é€‚é… */
      .post-box {
        padding: 20px;
        margin-bottom: 25px;
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      .post-box .id {
        align-self: flex-start;
      }
      
      .post-box textarea {
        height: 60px;
        font-size: 15px;
        padding: 10px 14px;
      }
      
      .post-box button {
        padding: 12px 24px;
        font-size: 15px;
      }
      
      /* å¸–å­å¡ç‰‡é€‚é… */
      .post-card {
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .post-card p {
        font-size: 15px;
        line-height: 1.6;
      }
      
      /* æ“ä½œæŒ‰é’®é€‚é… */
      .post-card .actions {
        gap: 15px;
        font-size: 13px;
      }
      
      .post-card .action-btn {
        padding: 8px 12px;
        gap: 6px;
      }
      
      /* åˆ†é¡µé€‚é… */
      #pagination {
        gap: 8px;
      }
      
      #pagination span {
        padding: 8px 12px;
        font-size: 13px;
      }
    }
    
    /* å°å±å¹•æ‰‹æœºé€‚é… */
    @media (max-width: 480px) {
      /* è¿›ä¸€æ­¥è°ƒæ•´é—´è· */
      .content {
        padding: 12px;
      }
      
      .title {
        font-size: 22px;
      }
      
      .post-box,
      .post-card {
        padding: 18px;
      }
      
      /* è°ƒæ•´æ“ä½œæŒ‰é’®å¸ƒå±€ */
      .post-card .actions {
        gap: 12px;
      }
      
      .post-card .action-btn {
        padding: 6px 10px;
        font-size: 12px;
      }
    }

    /* è¯„è®ºåŒºæ ·å¼ */
    .post-card .comments {
      margin-top: 20px;
      padding: 15px;
      border-top: 2px solid #f7fafc;
      display: none;
      background: rgba(247, 250, 252, 0.8);
      border-radius: 15px;
    }
    
    .post-card .comments.show {
      display: block;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* è¡¨æƒ…é€‰æ‹©å™¨ */
    /* æ—§æ ·å¼å·²åˆ é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨ä¸‹æ–¹çš„ä¼˜åŒ–æ ·å¼ */

    /* è¯„è®ºè¾“å…¥æ ·å¼ */
    .post-card .comment-input {
      display: flex;
      margin-top: 15px;
      gap: 12px;
    }
    
    .post-card .comment-input textarea {
      flex: 1;
      border: 2px solid #e2e8f0;
      border-radius: 25px;
      padding: 12px 16px;
      resize: none;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.8);
    }
    
    .post-card .comment-input textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: white;
    }
    
    .post-card .comment-input button {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    .post-card .comment-input button:hover {
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
    }
    
    /* è¯„è®ºé¡¹æ ·å¼ */
    .post-card .comment-item {
      padding: 12px 0;
      border-bottom: 1px solid #edf2f7;
      font-size: 14px;
      color: #4a5568;
      line-height: 1.6;
    }
    
    .post-card .comment-item:last-child {
      border-bottom: none;
    }
    
    .post-card .comment-item strong {
      color: #2d3748;
      font-weight: 600;
      margin-right: 8px;
    }

    /* ç©ºçŠ¶æ€æ ·å¼ */
    .empty {
      text-align: center;
      color: #a0aec0;
      margin: 60px 0;
      padding: 40px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 2px dashed #e2e8f0;
    }
    
    .empty img {
      width: 100px;
      margin-bottom: 25px;
      opacity: 0.7;
    }
    
    .empty p {
      font-size: 18px;
      font-weight: 500;
      margin: 0;
    }

    /* åº•éƒ¨å¯¼èˆª */
    /* æ ·å¼å·²ç§»è‡³ style.css */
    
    /* åˆ†é¡µæ§ä»¶ */
    /* æ ·å¼å·²ç§»è‡³ style.css */
    
    /* å¯¼èˆªé¡¹æ ·å¼ */
    /* æ ·å¼å·²ç§»è‡³ style.css */
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .content {
        padding: 20px 15px;
      }
      
      .post-box {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }
      
      .post-box .id {
        text-align: center;
      }
      
      .title {
        font-size: 26px;
      }
      
      .post-card {
        padding: 20px;
      }
      
      .post-card .actions {
        gap: 15px;
      }
      
      .post-card .action-btn {
        padding: 8px 12px;
        font-size: 13px;
      }
    }
    /* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
    .upload-area {
      margin-bottom: 15px;
    }
    .preview-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .preview-item {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #ddd;
    }
    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .preview-item .remove-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .upload-btn-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .upload-btn-wrapper input[type="file"] {
      display: none;
    }
    .icon-btn {
      background: #f0f2f5;
      color: #666;
      border: 1px solid #ddd;
      padding: 8px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }
    .icon-btn:hover {
      background: #e4e6eb;
    }
    .upload-tip {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }
    /* å›¾ç‰‡å±•ç¤ºç½‘æ ¼ */
    .post-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .post-image {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid #eee;
    }

    /* è¯„è®ºåŒºæ ·å¼ä¼˜åŒ– */
    .comment-input {
      display: flex;
      align-items: flex-end; /* åº•éƒ¨å¯¹é½ */
      gap: 8px;
      background: #f0f2f5;
      padding: 8px 12px;
      border-radius: 20px;
      margin-bottom: 10px;
    }

    .comment-input textarea {
      flex: 1;
      background: transparent;
      border: none;
      resize: none;
      height: 24px; /* é»˜è®¤ä¸€è¡Œé«˜åº¦ */
      max-height: 100px;
      line-height: 24px;
      padding: 0;
      outline: none;
      font-size: 14px;
      font-family: inherit;
    }

    /* ç®€çº¦æŒ‰é’® */
    .comment-action-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      color: #65676b;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }

    .comment-action-btn:hover {
      background: rgba(0,0,0,0.05);
      color: var(--primary-color);
    }
    
    .comment-action-btn img {
      width: 20px;
      height: 20px;
    }

    /* ä¿®å¤é€‰æ‹©å™¨ä¼˜å…ˆçº§é—®é¢˜ï¼Œç§»é™¤é”™è¯¯çš„ .comment-input ä¸­é—´å±‚ */
    .post-card .comment-send-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%); /* é²œè‰³çš„ç¿ ç»¿è‰²æ¸å˜ */
      color: white !important; /* å¼ºåˆ¶ç™½è‰²æ–‡å­— */
      border: none;
      font-weight: 600;
      cursor: pointer;
      padding: 8px 20px; /* å¢åŠ å†…è¾¹è· */
      border-radius: 20px; /* ç¨å¾®å‡å°åœ†è§’ï¼Œæ›´åƒæŒ‰é’® */
      font-size: 13px;
      height: 34px; /* å›ºå®šé«˜åº¦ */
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); /* ç»¿è‰²é˜´å½± */
      letter-spacing: 0.5px;
    }

    .post-card .comment-send-btn:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%); /* æ‚¬åœåŠ æ·± */
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
    }
    
    .post-card .comment-send-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }

    /* è¡¨æƒ…é€‰æ‹©å™¨ä¼˜åŒ– - ä¿®å¤è¢«é®æŒ¡é—®é¢˜ */
    .emoji-picker, .emoji-picker-popover {
      position: absolute;
      /* åŠ¨æ€è®¡ç®—ä½ç½®ï¼Œé»˜è®¤ä¸ºä¸Šæ–¹å¼¹å‡º */
      bottom: 100%; 
      left: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0;
      display: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2); /* åŠ æ·±é˜´å½± */
      z-index: 99999 !important; /* ç¡®ä¿æœ€é«˜å±‚çº§ */
      width: 320px;
      height: 280px;
      flex-direction: column;
      overflow: hidden;
      margin-bottom: 10px; /* ä¸è§¦å‘æŒ‰é’®çš„é—´è· */
    }

    /* è¯„è®ºåŒºä¸­çš„è¡¨æƒ…é€‰æ‹©å™¨éœ€è¦å‘å·¦å¯¹é½ï¼Œé˜²æ­¢å³ä¾§æº¢å‡º */
    .comment-input .emoji-picker {
      left: auto;
      right: 0;
    }

    /* ç§»åŠ¨ç«¯é€‚é…ï¼šå¦‚æœå±å¹•å¤ªå°ï¼Œå°è¯•å±…ä¸­æ˜¾ç¤º */
    @media (max-width: 480px) {
      .emoji-picker, .emoji-picker-popover {
        width: 300px; /* ç¨å¾®ç¼©å°å®½åº¦ */
        left: 50%;
        transform: translateX(-50%);
      }
    }

    .emoji-picker.show, .emoji-picker-popover.show {
      display: flex; /* è¦†ç›–é»˜è®¤çš„block */
    }

    /* é¡¶éƒ¨å¯¼èˆªæ  */
    .emoji-nav {
      display: flex;
      overflow-x: auto;
      background: #f8f9fa;
      padding: 8px 8px 0;
      border-bottom: 1px solid #eee;
      flex-shrink: 0;
      scrollbar-width: none; /* Firefox */
    }
    .emoji-nav::-webkit-scrollbar {
      display: none; /* Chrome/Safari */
    }

    .emoji-nav-item {
      padding: 6px 12px;
      margin-right: 4px;
      border-radius: 6px 6px 0 0;
      font-size: 13px;
      color: #666;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      border: 1px solid transparent;
      border-bottom: none;
    }

    .emoji-nav-item:hover {
      background: #e9ecef;
    }

    .emoji-nav-item.active {
      background: white;
      color: #00b09b;
      font-weight: 600;
      border-color: #eee;
      position: relative;
      top: 1px; /* ç›–ä½åº•è¾¹æ¡† */
    }

    /* å†…å®¹åŒºåŸŸ */
    .emoji-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      background: white;
    }

    .emoji-category-group {
      display: none;
    }

    /* Grid è°ƒæ•´ */
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
    }
    
    .emoji-item {
      cursor: pointer;
      font-size: 22px;
      padding: 6px;
      text-align: center;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .emoji-item:hover {
      background-color: #f0f2f5;
      transform: scale(1.2);
    }
    


    /* è¯„è®ºåŒºæ ·å¼å•†ä¸šåŒ–ä¼˜åŒ– */
    .comment-box {
      background: #f7f8fa;
      padding: 12px;
      border-radius: 16px;
      margin-bottom: 15px;
      border: 1px solid #eee;
    }
    
    .comment-box .id {
      font-size: 12px;
      color: #999;
      margin-bottom: 8px;
      display: block;
    }

    .comment-input-area {
      position: relative;
      background: white;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }

    .comment-input-area:focus-within {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(128, 203, 196, 0.1);
    }

    .comment-textarea {
      width: 100%;
      border: none;
      resize: none;
      min-height: 60px;
      padding: 12px;
      font-size: 14px;
      background: transparent;
      outline: none;
      font-family: inherit;
      box-sizing: border-box;
      display: block;
    }

    .comment-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 4px;
    }

    .comment-tools {
      display: flex;
      gap: 10px;
      position: relative;
    }

    .comment-tool-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      color: #999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .comment-tool-btn:hover {
      background: #f0f2f5;
      color: var(--primary-color);
    }
    
    .comment-tool-btn svg {
      width: 20px;
      height: 20px;
    }

    .comment-send-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .comment-send-btn:hover {
      background: var(--secondary-color);
      transform: translateY(-1px);
    }

    /* è¯„è®ºå›¾ç‰‡é¢„è§ˆ */
    .comment-preview-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 0 12px 12px;
    }
    
    .comment-preview-item {
      position: relative;
      width: 60px;
      height: 60px;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #eee;
    }
    
    .comment-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .comment-preview-item .remove-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    /* è¡¨æƒ…é€‰æ‹©å™¨å±‚çº§ä¿®å¤ */
    .emoji-picker, .emoji-picker-popover {
      z-index: 9999 !important;
    }
  </style>
</head>
<body>
  <div class="top">
   <div class="top-left">
  <button style="background:none;border:none;font-size:28px;cursor:pointer;margin-right:10px;" onclick="history.back()">â†</button>
  <span>æ ‘æ´å¹¿åœº</span>
</div>
    <div class="top-right">
      <div style="display: flex; align-items: center; gap: 8px; margin-right: 15px;">
        <img id="navAvatar" src="" alt="Avatar" class="user-avatar" style="display: none;">
        <span id="nickname" style="font-weight: 500; color: #555;">åŠ è½½ä¸­...</span>
      </div>
      <button class="check-in-mini-btn" onclick="quickCheckIn()" title="æ¯æ—¥ç­¾åˆ°" style="background: linear-gradient(135deg, #87ceeb 0%, #5f9ea0 100%); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; margin: 0 10px; transition: all 0.3s ease;">ğŸ“… ç­¾åˆ°</button>
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
      <button class="switch-btn" onclick="logout()">åˆ‡æ¢è´¦æˆ·</button>
    </div>
  </div>

  <div class="content">
    <h1 class="title">æ ‘æ´å¹¿åœº</h1>
    <p class="subtitle">åœ¨å¤§æ ‘ä¸‹ï¼Œè‡ªç”±åœ°å‘¼å¸ï¼Œè‡ªç”±åœ°è¡¨è¾¾ã€‚</p>

    <div class="post-box">
      <span class="id">å½“å‰èº«ä»½ï¼š<span id="currentId">åŠ è½½ä¸­...</span><span id="currentLevel" style="display:none"></span></span>
      <textarea id="content" placeholder="ä»Šå¤©æœ‰ä»€ä¹ˆæƒ³å¯¹æ ‘æ´è¯´çš„å—ï¼Ÿ..."></textarea>
      
      <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
      <div class="preview-list" id="previewList"></div>
      
      <div class="post-footer">
        <div class="post-tools">
          <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
          <input type="file" id="imageInput" accept="image/*" multiple onchange="handleImageSelect(event)" style="display:none">
          
          <!-- å›¾ç‰‡æŒ‰é’® -->
          <button class="tool-btn" onclick="document.getElementById('imageInput').click()" title="æ·»åŠ å›¾ç‰‡">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
          </button>

          <!-- è¡¨æƒ…æŒ‰é’® -->
          <div style="position: relative;">
            <button class="tool-btn" onclick="togglePostEmoji(event)" title="æ·»åŠ è¡¨æƒ…">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
            </button>
            <!-- ä¸»è¡¨æƒ…é€‰æ‹©å™¨å®¹å™¨ -->
            <div id="post-emoji-picker" class="emoji-picker-popover" style="top: 40px; left: 0;"></div>
          </div>
        </div>

        <button class="send-btn" onclick="send()">å‘é€</button>
      </div>
      
      <div class="upload-tip" style="font-size: 12px; color: #ccc; margin-top: 5px; text-align: right;">æœ€å¤š4å¼ ï¼Œæ”¯æŒè‡ªåŠ¨å‹ç¼©</div>
    </div>

    <div id="posts-list"></div>

    <div class="empty" id="empty-state">
      <img src="https://img.icons8.com/color/96/null/leaf.png" alt="ç©º">
      <p>é£å¹è¿‡æ ‘æ¢¢ï¼Œå¹¿åœºä¸Šé™æ‚„æ‚„çš„...</p>
    </div>

    <!-- åˆ†é¡µæ§ä»¶å®¹å™¨ -->
    <div id="pagination">
      <!-- åˆ†é¡µæ§ä»¶å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <!-- åº•éƒ¨å ä½ç¬¦ï¼Œç¡®ä¿æœ€åçš„å†…å®¹ä¸è¢«é®æŒ¡ -->
    <div style="height: 50px; width: 100%;"></div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="location.href='/'">
      <img src="https://img.icons8.com/color/48/null/leaf.png" alt="å¹¿åœº">
      <div>æ ‘æ´å¹¿åœº</div>
    </div>
    <div class="nav-item" onclick="location.href='/topic.html'">
      <img src="https://img.icons8.com/color/48/null/speech-bubble.png" alt="è¯é¢˜">
      <div>è¯é¢˜è®¨è®º</div>
    </div>
    <div class="nav-item" onclick="location.href='/tools.html'">
      <img src="https://img.icons8.com/color/48/null/wrench.png" alt="å·¥å…·">
      <div>å®ç”¨å·¥å…·</div>
    </div>
    <div class="nav-item" onclick="location.href='/capsule.html'">
      <img src="https://img.icons8.com/color/48/null/hourglass.png" alt="èƒ¶å›Š">
      <div>æ—¶é—´èƒ¶å›Š</div>
    </div>
    <div class="nav-item" onclick="location.href='/profile.html'">
      <img src="https://img.icons8.com/color/48/null/user.png" alt="æˆ‘çš„">
      <div>æˆ‘çš„</div>
    </div>
  </div>

  <script>
    if (!localStorage.getItem('token')) {
      window.location.href = '/login.html';
    }

    const nickname = localStorage.getItem('nickname') || 'è®¿å®¢';
    if (document.getElementById('nickname')) {
      document.getElementById('nickname').textContent = nickname;
    }
    if (document.getElementById('currentId')) {
      document.getElementById('currentId').textContent = nickname;
    }

    // ä»æœ¬åœ°ç¼“å­˜åŠ è½½ç­‰çº§
    const savedLevel = localStorage.getItem('level');
    if (savedLevel) {
      updateLevelDisplay(savedLevel);
    }

    // åˆå§‹åŒ–å¤´åƒæ˜¾ç¤º
    function initAvatar() {
      const avatarImg = document.getElementById('navAvatar');
      if (!avatarImg) return;
      
      const savedAvatar = localStorage.getItem('avatar');
      if (savedAvatar) {
        avatarImg.src = savedAvatar;
        avatarImg.style.display = 'block';
      } else {
        // é»˜è®¤å¤´åƒ
        avatarImg.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${nickname}`;
        avatarImg.style.display = 'block';
      }

      // è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
      fetch('/api/auth/me', {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      })
      .then(res => res.json())
      .then(data => {
        if (data.avatar) {
          avatarImg.src = data.avatar;
          localStorage.setItem('avatar', data.avatar);
        }
        if (data.nickname) {
          localStorage.setItem('nickname', data.nickname);
          document.getElementById('nickname').textContent = data.nickname;
          if (document.getElementById('currentId')) {
            document.getElementById('currentId').textContent = data.nickname;
          }
        }
        // æ›´æ–°ç­‰çº§
        if (data.level) {
          localStorage.setItem('level', data.level);
          updateLevelDisplay(data.level);
        }
      })
      .catch(err => console.error('Failed to fetch user info', err));
    }
    
    // æ›´æ–°ç­‰çº§æ˜¾ç¤º
    function updateLevelDisplay(level) {
      const levelEl = document.getElementById('currentLevel');
      if (levelEl) {
        levelEl.className = `level-tag ${getLevelClass(level)}`;
        levelEl.innerHTML = `<span>ğŸ…</span>Lv.${level}`;
        levelEl.style.display = 'inline-flex';
        levelEl.title = 'ç‚¹å‡»æŸ¥çœ‹ç­‰çº§è¯¦æƒ…';
        levelEl.onclick = () => showLevelDetails(level);
      }
    }

    function showLevelDetails(level) {
      alert(`ã€æˆ‘çš„ç­‰çº§ã€‘\nå½“å‰ç­‰çº§ï¼šLv.${level}\n\nå¤šå‘å¸–ã€å¤šäº’åŠ¨ã€æ¯æ—¥ç­¾åˆ°å¯ä»¥è·å–ç»éªŒå€¼å‡çº§å“¦ï¼`);
    }

    initAvatar();

    function logout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºæˆ–åˆ‡æ¢è´¦æˆ·å—ï¼Ÿ')) {
        localStorage.removeItem('token');
        localStorage.removeItem('nickname');
        localStorage.removeItem('avatar');
        window.location.href = '/login.html';
      }
    }

    // å¿«é€Ÿç­¾åˆ°åŠŸèƒ½
    async function quickCheckIn() {
      const btn = document.querySelector('.check-in-mini-btn');
      const originalText = btn.innerHTML;
      
      try {
        btn.disabled = true;
        btn.innerHTML = 'ğŸ“… ç­¾åˆ°ä¸­...';
        
        const token = localStorage.getItem('token');
        if (!token) {
          alert('è¯·å…ˆç™»å½•');
          window.location.href = '/login.html';
          return;
        }

        const res = await fetch('/api/auth/checkin', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await res.json();
        
        if (res.ok) {
          alert(data.message);
          btn.innerHTML = 'âœ… å·²ç­¾åˆ°';
          btn.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
          // 3ç§’åæ¢å¤åŸçŠ¶
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = 'linear-gradient(135deg, #87ceeb 0%, #5f9ea0 100%)';
          }, 3000);
        } else {
          if (res.status === 401 || res.status === 403) {
            alert('ç™»å½•å·²è¿‡æœŸæˆ–æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
            logout();
            return;
          }
          alert('ç­¾åˆ°å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      } catch (err) {
        console.error('ç­¾åˆ°è¯·æ±‚å¼‚å¸¸:', err);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•');
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // è·å–ç­‰çº§æ ·å¼ç±»
    function getLevelClass(level) {
      if (!level) return 'lv-1';
      if (level >= 10) return 'lv-10';
      if (level >= 7) return 'lv-7';
      if (level >= 4) return 'lv-4';
      return 'lv-1';
    }

    // å®Œæ•´çš„è¡¨æƒ…åˆ—è¡¨
    const emojiList = {
      'é»˜è®¤': ['ğŸ˜Š','ğŸ˜‚','ğŸ˜','ğŸ¤”','ğŸ‘','â¤ï¸','ğŸ‰','ğŸ˜¢','ğŸ˜†','ğŸ˜˜','ğŸ˜','ğŸ˜‰','ğŸ˜','ğŸ˜´','ğŸ˜­','ğŸ¤£','ğŸ˜…','ğŸ˜‡','ğŸ™‚','ğŸ™ƒ','ğŸ˜‹','ğŸ˜›','ğŸ¤‘','ğŸ¤—','ğŸ¤”','ğŸ¤','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤§','ğŸ˜µ','ğŸ¤ ','ğŸ˜','ğŸ¤“','ğŸ˜•','ğŸ˜Ÿ','â˜¹ï¸','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ‘¾','ğŸ¤–','ğŸ˜º','ğŸ˜¸','ğŸ˜¹','ğŸ˜»','ğŸ˜¼','ğŸ˜½','ğŸ™€','ğŸ˜¿','ğŸ˜¾'],
      'åŠ¨ç‰©': ['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ½','ğŸ¸','ğŸµ','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ’','ğŸ”','ğŸ§','ğŸ¦','ğŸ¤','ğŸ£','ğŸ¥','ğŸ¦†','ğŸ¦…','ğŸ¦‰','ğŸ¦‡','ğŸº','ğŸ—','ğŸ´','ğŸ¦„','ğŸ','ğŸ›','ğŸ¦‹','ğŸŒ','ğŸš','ğŸ','ğŸœ','ğŸ•·','ğŸ•¸','ğŸ¢','ğŸ','ğŸ¦','ğŸ¦‚','ğŸ¦€','ğŸ¦‘','ğŸ™','ğŸ¦','ğŸ ','ğŸŸ','ğŸ¡','ğŸ¬','ğŸ¦ˆ','ğŸ³','ğŸ‹','ğŸŠ','ğŸ†','ğŸ…','ğŸƒ','ğŸ‚','cow','ğŸ¦Œ','dromedary_camel','camel','elephant','rhinoceros','gorilla','horse','pig','goat','ram','sheep','dog','poodle','cat','rooster','turkey','dove','rabbit','mouse','rat','chipmunk','paws','dragon','dragon_face','cactus','christmas_tree','evergreen_tree','deciduous_tree','palm_tree','seedling','herb','shamrock','four_leaf_clover','bamboo','tanabata_tree','leaves','fallen_leaf','maple_leaf','mushroom','ğŸŒ¾','ğŸ’','ğŸŒ·','ğŸŒ¹','ğŸ¥€','ğŸŒ»','ğŸŒ¼','ğŸŒ¸','ğŸŒº','ğŸŒ','ğŸŒ','ğŸŒ','ğŸŒ•','ğŸŒ–','ğŸŒ—','ğŸŒ˜','ğŸŒ‘','ğŸŒ’','ğŸŒ“','ğŸŒ”','ğŸŒš','ğŸŒ','ğŸŒ','ğŸŒ›','ğŸŒœ','ğŸŒ™','ğŸ’«','â­ï¸','ğŸŒŸ','âœ¨','âš¡ï¸','ğŸ”¥','ğŸ’¥','â˜„ï¸','â˜€ï¸','ğŸŒ¤','â›…ï¸','ğŸŒ¥','â˜ï¸','ğŸŒ¦','ğŸŒ§','â›ˆ','ğŸŒ©','ğŸŒ¨','â„ï¸','â˜ƒï¸','â›„ï¸','ğŸŒ¬','ğŸ’¨','ğŸŒª','ğŸŒ«','ğŸŒŠ','ğŸ’§','ğŸ’¦','â˜”ï¸'],
      'ç‰©å“': ['ğŸ','ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸˆ','ğŸ’','ğŸ‘','ğŸ','ğŸ¥','ğŸ¥‘','ğŸ…','ğŸ†','ğŸ¥’','ğŸ¥•','ğŸŒ½','ğŸŒ¶','ğŸ¥”','ğŸ ','ğŸŒ°','ğŸ¥œ','ğŸ¯','ğŸ¥','ğŸ','ğŸ¥–','ğŸ§€','ğŸ¥š','ğŸ³','ğŸ¥“','ğŸ¥','ğŸ¤','ğŸ—','ğŸ–','ğŸ•','ğŸŒ­','ğŸ”','ğŸŸ','ğŸ¥™','ğŸŒ®','ğŸŒ¯','ğŸ¥—','ğŸ¥˜','ğŸ','ğŸœ','ğŸ²','ğŸ¥','ğŸ£','ğŸ±','ğŸ›','ğŸš','ğŸ™','ğŸ˜','ğŸ¢','ğŸ¡','ğŸ§','ğŸ¨','ğŸ¦','ğŸ°','ğŸ‚','ğŸ®','ğŸ­','ğŸ¬','ğŸ«','ğŸ¿','ğŸ©','ğŸª','ğŸ¥›','ğŸ¼','â˜•ï¸','ğŸµ','ğŸ¶','ğŸº','ğŸ»','ğŸ¥‚','ğŸ·','ğŸ¥ƒ','ğŸ¸','ğŸ¹','ğŸ¾','ğŸ¥„','ğŸ´','ğŸ½','âš½ï¸','ğŸ€','ğŸˆ','âš¾ï¸','ğŸ¾','ğŸ','ğŸ‰','ğŸ±','ğŸ“','ğŸ¸','ğŸ¥…','ğŸ’','ğŸ‘','ğŸ','â›³ï¸','ğŸ¹','ğŸ£','ğŸ¥Š','ğŸ¥‹','â›¸','ğŸ¿','â›·','ğŸ‚','ğŸ‹ï¸','ğŸ¤º','ğŸ¤¼','ğŸ¤¸','â›¹ï¸','ğŸ¤¾','ğŸŒï¸','ğŸ„','ğŸŠ','ğŸ¤½','ğŸš£','ğŸ‡','ğŸš´','ğŸšµ','ğŸ','ğŸ','ğŸ¤¸','ğŸ¤¹','ğŸª','ğŸ­','ğŸ¨','ğŸ°','ğŸš‚','ğŸšƒ','ğŸš„','ğŸš…','ğŸš†','ğŸš‡','ğŸšˆ','ğŸš‰','ğŸšŠ','ğŸš','ğŸš','ğŸš‹','ğŸšŒ','ğŸš','ğŸš','ğŸš','ğŸš‘','ğŸš’','ğŸš“','ğŸš”','ğŸš•','ğŸš–','ğŸš—','ğŸš˜','ğŸš™','ğŸšš','ğŸš›','ğŸšœ','ğŸš²','ğŸ›´','ğŸ›µ','ğŸš','ğŸ›£','ğŸ›¤','â›½ï¸','ğŸš¨','ğŸš¥','ğŸš¦','ğŸš§','ğŸ›‘','âš“ï¸','â›µï¸','ğŸ›¶','ğŸš¤','ğŸ›³','â›´','ğŸ›¥','ğŸš¢','âœˆï¸','ğŸ›©','ğŸ›«','ğŸ›¬','ğŸ’º','ğŸš','ğŸšŸ','ğŸš ','ğŸš¡','ğŸš€','ğŸ›°','ğŸ›','ğŸšª','ğŸ›Œ','ğŸ›','ğŸ›‹','ğŸš½','ğŸš¿','ğŸ›','âŒ›ï¸','â³','âŒšï¸','â°','â±','â²','ğŸ•°','ğŸ•›','ğŸ•§','ğŸ•','ğŸ•œ','ğŸ•‘','ğŸ•','ğŸ•’','ğŸ•','ğŸ•“','ğŸ•Ÿ','ğŸ•”','ğŸ• ','ğŸ••','ğŸ•¡','ğŸ•–','ğŸ•¢','ğŸ•—','ğŸ•£','ğŸ•˜','ğŸ•¤','ğŸ•™','ğŸ•¥','ğŸ•š','ğŸ•¦','ğŸŒ‘','ğŸŒ’','ğŸŒ“','ğŸŒ”','ğŸŒ•','ğŸŒ–','ğŸŒ—','ğŸŒ˜','ğŸŒ™','ğŸŒš','ğŸŒ›','ğŸŒœ','ğŸŒ¡','â˜€ï¸','ğŸŒ','ğŸŒ','â­','ğŸŒŸ','ğŸŒ ','â˜ï¸','â›…','â›ˆ','ğŸŒ¤','ğŸŒ¥','ğŸŒ¦','ğŸŒ§','ğŸŒ¨','ğŸŒ©','ğŸŒª','ğŸŒ«','ğŸŒ¬','ğŸŒ€','ğŸŒˆ','ğŸŒ‚','â˜”','âš¡','â„ï¸','â˜ƒï¸','â›„','â˜„ï¸','ğŸ”¥','ğŸ’§','ğŸŒŠ']
    };

    // åˆ‡æ¢è¡¨æƒ…åˆ†ç±»
    function switchEmojiCategory(pickerId, categoryName) {
      const picker = document.getElementById(pickerId);
      if (!picker) return;

      // æ›´æ–°å¯¼èˆªçŠ¶æ€
      picker.querySelectorAll('.emoji-nav-item').forEach(item => {
        if (item.dataset.category === categoryName) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });

      // æ›´æ–°å†…å®¹æ˜¾ç¤º
      picker.querySelectorAll('.emoji-category-group').forEach(group => {
        if (group.dataset.category === categoryName) {
          group.style.display = 'block';
        } else {
          group.style.display = 'none';
        }
      });
    }

    // æ¸²æŸ“è¡¨æƒ…é€‰æ‹©å™¨HTML
    function renderEmojiPicker(elementId, postId = null) {
      const picker = document.getElementById(elementId);
      if (!picker || picker.innerHTML !== '') return;

      let navHtml = '<div class="emoji-nav">';
      let contentHtml = '<div class="emoji-content">';
      
      Object.keys(emojiList).forEach((category, index) => {
        const isActive = index === 0;
        const activeClass = isActive ? 'active' : '';
        const displayStyle = isActive ? 'block' : 'none';
        
        navHtml += `<div class="emoji-nav-item ${activeClass}" data-category="${category}" onclick="event.stopPropagation(); switchEmojiCategory('${elementId}', '${category}')">${category}</div>`;
        
        contentHtml += `<div class="emoji-category-group" data-category="${category}" style="display: ${displayStyle}">`;
        contentHtml += '<div class="emoji-grid">';
        emojiList[category].forEach(emoji => {
           const onclick = postId 
              ? `insertEmoji('${postId}', '${emoji}')`
              : `insertPostEmoji('${emoji}')`;
           contentHtml += `<div class="emoji-item" onclick="event.stopPropagation(); ${onclick}">${emoji}</div>`;
        });
        contentHtml += '</div></div>';
      });
      
      navHtml += '</div>';
      contentHtml += '</div>';
      
      picker.innerHTML = navHtml + contentHtml;
    }

    // åˆ‡æ¢å‘å¸ƒæ¡†è¡¨æƒ…é€‰æ‹©å™¨
    function togglePostEmoji(e) {
      e.stopPropagation();
      const pickerId = 'post-emoji-picker';
      const picker = document.getElementById(pickerId);
      
      // å…³é—­å…¶ä»–å¯èƒ½æ‰“å¼€çš„è¡¨æƒ…é€‰æ‹©å™¨
      document.querySelectorAll('.emoji-picker-popover, .emoji-picker').forEach(el => {
        if (el !== picker) el.classList.remove('show');
      });
      
      renderEmojiPicker(pickerId);
      
      picker.classList.toggle('show');
    }

    // æ’å…¥è¡¨æƒ…åˆ°å‘å¸ƒæ¡†
    function insertPostEmoji(emoji) {
      const input = document.getElementById('content');
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;
      input.value = text.substring(0, start) + emoji + text.substring(end);
      input.focus();
      input.setSelectionRange(start + emoji.length, start + emoji.length);
      // document.getElementById('post-emoji-picker').classList.remove('show'); // ä¿æŒå¼€å¯æ–¹ä¾¿è¿ç»­è¾“å…¥
    }

    // å…¨å±€ç‚¹å‡»å…³é—­è¡¨æƒ…é€‰æ‹©å™¨
    document.addEventListener('click', function(e) {
      document.querySelectorAll('.emoji-picker-popover, .emoji-picker').forEach(el => {
        // å¦‚æœç‚¹å‡»çš„æ˜¯è¡¨æƒ…æŒ‰é’®æœ¬èº«ï¼Œä¸å¤„ç†ï¼ˆå·²åœ¨toggleä¸­å¤„ç†ï¼‰
        if (e.target.closest('.tool-btn') || e.target.closest('.emoji-btn') || e.target.closest('.comment-action-btn')) return;
        
        el.classList.remove('show');
        const card = el.closest('.post-card');
        if (card) card.style.zIndex = '';
      });
    });

    function generateEmojiPickerHTML(postId) {
      // è¿”å›å®¹å™¨ divï¼Œå†…å®¹ç”± renderEmojiPicker åŠ¨æ€å¡«å……
      return `<div class="emoji-picker" id="emoji-picker-${postId}" onclick="event.stopPropagation()"></div>`; 
    }
    
    // åˆ‡æ¢è¡¨æƒ…é€‰æ‹©å™¨æ˜¾ç¤º
    function toggleEmojiPicker(postId) {
      const pickerId = 'emoji-picker-' + postId;
      const picker = document.getElementById(pickerId);
      const postCard = picker.closest('.post-card');
      
      // å…³é—­å…¶ä»–
      document.querySelectorAll('.emoji-picker-popover, .emoji-picker').forEach(el => {
        if (el !== picker) {
          el.classList.remove('show');
          const card = el.closest('.post-card');
          if (card) card.style.zIndex = '';
        }
      });

      renderEmojiPicker(pickerId, postId);
      
      picker.classList.toggle('show');
      
      // å…³é”®ä¿®å¤ï¼šå½“è¡¨æƒ…æ¡†æ˜¾ç¤ºæ—¶ï¼Œå¼ºåˆ¶æå‡å½“å‰å¸–å­å¡ç‰‡çš„å±‚çº§ï¼Œé˜²æ­¢è¢«ä¸‹æ–¹å¸–å­é®æŒ¡
      if (postCard) {
        if (picker.classList.contains('show')) {
          postCard.style.zIndex = '10000';
          postCard.style.position = 'relative'; // ç¡®ä¿z-indexç”Ÿæ•ˆ
        } else {
          // å»¶è¿Ÿæ¢å¤ z-indexï¼Œé¿å…åŠ¨ç”»è¿‡ç¨‹ä¸­çš„é—ªçƒ
          setTimeout(() => {
            if (!picker.classList.contains('show')) {
              postCard.style.zIndex = '';
            }
          }, 300);
        }
      }
    }



    let currentPage = 1;
    let totalPages = 1;

    async function loadPosts(page = 1) {
      try {
        // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜ï¼Œç¡®ä¿å‘å¸–åç«‹å³å¯è§
        const res = await fetch(`/api/posts?page=${page}&limit=10&_t=${new Date().getTime()}`);
        const response = await res.json();
        const posts = response.posts;
        const list = document.getElementById('posts-list');
        const empty = document.getElementById('empty-state');
        const pagination = document.getElementById('pagination');

        if (posts.length === 0) {
          empty.style.display = 'block';
          list.innerHTML = '';
          pagination.style.display = 'none';
          return;
        }

        empty.style.display = 'none';
        list.innerHTML = posts.map(p => {
          let levelTag = '';
          if (p.authorLevel) {
            levelTag = `<span class="level-tag ${getLevelClass(p.authorLevel)}" onclick="event.stopPropagation(); showLevelDetails(${p.authorLevel})" title="ç‚¹å‡»æŸ¥çœ‹ç­‰çº§è¯¦æƒ…"><span>ğŸ…</span>Lv.${p.authorLevel}</span>`;
          }
          
          // å›¾ç‰‡åŒºåŸŸHTML
          let imagesHtml = '';
          if (p.images && p.images.length > 0) {
            imagesHtml = `
              <div class="post-images" onclick="event.stopPropagation()">
                ${p.images.map(img => `<img src="${img}" class="post-image" loading="lazy">`).join('')}
              </div>
            `;
          }

          return `
          <div class="post-card" onclick="toggleComments('${p._id}')">
            <p>${p.content.replace(/\n/g,'<br>')}</p>
            ${imagesHtml}
            <div class="post-author-row">
              <div class="author-info">
                <img class="user-avatar" src="${p.isAnonymous ? 'https://api.dicebear.com/7.x/avataaars/svg?seed=Anonymous' : (p.authorAvatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${p.author}`)}" alt="avatar" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=fallback'" style="width:24px;height:24px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-right:8px;">
                <span class="author">${p.author}</span>
                ${levelTag}
              </div>
              <span class="time">${new Date(p.createdAt).toLocaleString()}</span>
            </div>
            <div class="actions">
              <span class="action-btn like" id="like-btn-${p._id}" onclick="event.stopPropagation(); toggleLike('${p._id}')">
                <span id="like-icon-${p._id}">ğŸ¤</span> ç‚¹èµ (<span class="like-count" id="like-${p._id}">${p.likeCount || 0}</span>)
              </span>
              <span class="action-btn comment" onclick="event.stopPropagation(); toggleComments('${p._id}')">
                ğŸ’¬ è¯„è®º (<span class="comment-count" id="comment-${p._id}">${p.commentCount || 0}</span>)
              </span>
            </div>
            <div class="comments" id="comments-${p._id}"></div>
          </div>
        `}).join('');
        
        // ä¿å­˜å¸–å­æ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œä¾¿äºåç»­åŠ¨æ€æ¸²æŸ“è¯„è®ºåŒºåŸŸ
        window.postsData = window.postsData || {};
        const postIds = posts.map(p => p._id);
        
        // åˆå§‹åŒ–countsCacheï¼Œç¡®ä¿ç‚¹èµæ•°å’Œè¯„è®ºæ•°ä»æœåŠ¡å™¨æ•°æ®å¼€å§‹
        posts.forEach(p => {
          window.postsData[p._id] = p;
          countsCache.set(p._id, {
            likeCount: p.likeCount || 0,
            commentCount: p.commentCount || 0
          });
        });
        
        // æ‰¹é‡åŠ è½½ç‚¹èµçŠ¶æ€ï¼Œå‡å°‘APIè¯·æ±‚æ¬¡æ•°
        loadLikeStatusBatch(postIds);

        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        currentPage = response.currentPage;
        totalPages = response.totalPages;
        
        // æ¸²æŸ“åˆ†é¡µæ§ä»¶
        renderPagination();

      } catch (err) {
        console.log('åŠ è½½å¤±è´¥', err);
      }
    }

    // æ¸²æŸ“åˆ†é¡µæ§ä»¶
    function renderPagination() {
      const pagination = document.getElementById('pagination');
      if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
      }

      let html = '';
      
      // ä¸Šä¸€é¡µæŒ‰é’®
      html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="loadPosts(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
      
      // é¡µç æŒ‰é’® - åªæ˜¾ç¤ºå½“å‰é¡µé™„è¿‘çš„é¡µç 
      const visiblePages = 5; // å¯è§é¡µç æ•°é‡
      const halfVisible = Math.floor(visiblePages / 2);
      let startPage = Math.max(1, currentPage - halfVisible);
      let endPage = Math.min(totalPages, startPage + visiblePages - 1);
      
      // è°ƒæ•´å¼€å§‹é¡µç ï¼Œç¡®ä¿æ˜¾ç¤ºè¶³å¤Ÿçš„é¡µç 
      if (endPage - startPage + 1 < visiblePages) {
        startPage = Math.max(1, endPage - visiblePages + 1);
      }
      
      // é¦–é¡µæŒ‰é’®
      if (startPage > 1) {
        html += `<button onclick="loadPosts(1)">1</button>`;
        if (startPage > 2) {
          html += `<span class="pagination-ellipsis">...</span>`;
        }
      }
      
      // ä¸­é—´é¡µç æŒ‰é’®
      for (let i = startPage; i <= endPage; i++) {
        html += `<button ${i === currentPage ? 'class="active"' : ''} onclick="loadPosts(${i})">${i}</button>`;
      }
      
      // æœ«é¡µæŒ‰é’®
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          html += `<span class="pagination-ellipsis">...</span>`;
        }
        html += `<button onclick="loadPosts(${totalPages})">${totalPages}</button>`;
      }
      
      // ä¸‹ä¸€é¡µæŒ‰é’®
      html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="loadPosts(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
      
      pagination.innerHTML = html;
      pagination.style.display = 'flex';
    }

    // æ‰¹é‡åŠ è½½ç‚¹èµçŠ¶æ€ï¼Œå‡å°‘APIè¯·æ±‚æ¬¡æ•°
    async function loadLikeStatusBatch(postIds) {
      try {
        if (postIds.length === 0) return;
        
        // ä½¿ç”¨æ‰¹é‡APIè·å–æ‰€æœ‰å¸–å­çš„ç‚¹èµçŠ¶æ€
        const res = await fetch('/api/likes/check-multiple', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            postIds,
            userNickname: nickname
          })
        });
        
        const data = await res.json();
        const postLikes = data.postLikes || {};
        
        // æ›´æ–°æ‰€æœ‰å¸–å­çš„ç‚¹èµçŠ¶æ€
        postIds.forEach(postId => {
          const isLiked = !!postLikes[postId];
          const likeBtn = document.getElementById('like-btn-' + postId);
          const likeIcon = document.getElementById('like-icon-' + postId);
          
          if (likeBtn && likeIcon) {
            if (isLiked) {
              likeBtn.classList.add('liked');
              likeIcon.textContent = 'â¤ï¸';
            } else {
              likeBtn.classList.remove('liked');
              likeIcon.textContent = 'ğŸ¤';
            }
          }
        });
      } catch (err) {
        console.log('æ‰¹é‡åŠ è½½ç‚¹èµçŠ¶æ€å¤±è´¥', err);
      }
    }
    
    // å•ç¯‡å¸–å­ç‚¹èµçŠ¶æ€åŠ è½½ï¼ˆç”¨äºå•ä¸ªæ“ä½œåæ›´æ–°ï¼‰
    async function loadLikeStatus(postId) {
      try {
        // æ£€æŸ¥å½“å‰ç”¨æˆ·çš„ç‚¹èµçŠ¶æ€
        const checkRes = await fetch(`/api/likes/check?postId=${postId}&userNickname=${nickname}`);
        const checkData = await checkRes.json();
        const likeBtn = document.getElementById('like-btn-' + postId);
        const likeIcon = document.getElementById('like-icon-' + postId);
        
        if (checkData.isLiked) {
          likeBtn.classList.add('liked');
          likeIcon.textContent = 'â¤ï¸';
        } else {
          likeBtn.classList.remove('liked');
          likeIcon.textContent = 'ğŸ¤';
        }
      } catch (err) {
        console.log('åŠ è½½ç‚¹èµçŠ¶æ€å¤±è´¥', err);
      }
    }

    // ç¼“å­˜å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨ç‚¹èµæ•°å’Œè¯„è®ºæ•°
    const countsCache = new Map();
    
    // æ‰¹é‡åŠ è½½ç‚¹èµæ•°å’Œè¯„è®ºæ•°
    async function loadLikeAndCommentCountBatch(postIds) {
      try {
        if (postIds.length === 0) return;
        
        // è¿‡æ»¤æ‰å·²ç¼“å­˜çš„æ•°æ®
        const uncachedIds = postIds.filter(id => !countsCache.has(id));
        
        if (uncachedIds.length > 0) {
          const res = await fetch(`/api/posts/counts?postIds=${uncachedIds.join(',')}`);
          const data = await res.json();
          
          // æ›´æ–°ç¼“å­˜å¹¶åº”ç”¨åˆ°DOM
          Object.entries(data).forEach(([postId, counts]) => {
            countsCache.set(postId, counts);
            updateCountsInDOM(postId, counts);
          });
        } else {
          // ä»ç¼“å­˜æ›´æ–°DOM
          postIds.forEach(postId => {
            const counts = countsCache.get(postId);
            if (counts) {
              updateCountsInDOM(postId, counts);
            }
          });
        }
      } catch (err) {
        console.log('æ‰¹é‡åŠ è½½æ•°é‡å¤±è´¥', err);
      }
    }
    
    // æ›´æ–°DOMä¸­çš„ç‚¹èµæ•°å’Œè¯„è®ºæ•°
    function updateCountsInDOM(postId, counts) {
      const likeElement = document.getElementById('like-' + postId);
      const commentElement = document.getElementById('comment-' + postId);
      
      if (likeElement) {
        likeElement.textContent = counts.likeCount || 0;
      }
      
      if (commentElement) {
        commentElement.textContent = counts.commentCount || 0;
      }
    }
    
    // åŠ è½½ç‚¹èµæ•°å’Œè¯„è®ºæ•°ï¼ˆå…¼å®¹å•æ¡è°ƒç”¨ï¼‰
    async function loadLikeAndCommentCount(postId) {
      await loadLikeAndCommentCountBatch([postId]);
    }

    // åŠ è½½è¯„è®ºåˆ—è¡¨
    async function loadComments(postId) {
      try {
        const commentRes = await fetch(`/api/comments/post/${postId}`);
        const comments = await commentRes.json();

        const list = document.getElementById('comment-list-' + postId);
        if (comments.length === 0) {
          list.innerHTML = '<p style="color:#999;padding:10px;">æš‚æ— è¯„è®ºï¼Œæ¥æŠ¢æ²™å‘ï½</p>';
        } else {
          list.innerHTML = comments.map(c => {
            let levelTag = '';
            if (c.authorLevel) {
              levelTag = `<span class="level-tag ${getLevelClass(c.authorLevel)}" onclick="event.stopPropagation(); showLevelDetails(${c.authorLevel})" title="ç‚¹å‡»æŸ¥çœ‹ç­‰çº§è¯¦æƒ…"><span>ğŸ…</span>Lv.${c.authorLevel}</span>`;
            }
            let imagesHtml = '';
          if (c.images && c.images.length > 0) {
            imagesHtml = `
              <div class="post-images" style="margin-top:8px;">
                ${c.images.map(img => `<img src="${img}" class="post-image" style="width:80px;height:80px;" onerror="this.onerror=null;this.src='https://placehold.co/200x200?text=Error';">`).join('')}
              </div>
            `;
          }
            return `
            <div class="comment-item">
              <div class="author-area">
                <img class="user-avatar" src="${c.authorAvatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${c.author}`}" alt="avatar" style="width:20px;height:20px;margin-right:5px;border-radius:50%;object-fit:cover;vertical-align:middle;">
                <strong>${c.author}</strong>
                ${levelTag}: ${c.content}
              </div>
              ${imagesHtml}
              <small style="color:#ccc;float:right;">${new Date(c.createdAt).toLocaleString()}</small>
            </div>
          `}).join('');
        }
      } catch (err) {
        console.log('åŠ è½½è¯„è®ºå¤±è´¥', err);
      }
    }



    // æ’å…¥è¡¨æƒ…åˆ°è¯„è®ºæ¡†
    function insertEmoji(postId, emoji) {
      const input = document.getElementById('comment-input-' + postId);
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;
      input.value = text.substring(0, start) + emoji + text.substring(end);
      input.focus();
      input.setSelectionRange(start + emoji.length, start + emoji.length);
      
      // å…³é—­è¡¨æƒ…é€‰æ‹©å™¨
      toggleEmojiPicker(postId);
    }

    // ç‚¹èµ/å–æ¶ˆç‚¹èµåˆ‡æ¢
    async function toggleLike(postId) {
      const btn = document.getElementById('like-btn-' + postId);
      const icon = document.getElementById('like-icon-' + postId);
      const likeCountElement = document.getElementById('like-' + postId);
      
      try {
        // æ£€æŸ¥å½“å‰ç‚¹èµçŠ¶æ€
        const isCurrentlyLiked = btn.classList.contains('liked');
        
        // é¦–å…ˆä»DOMè·å–å½“å‰ç‚¹èµæ•°ï¼Œç¡®ä¿æ€»æ˜¯åŸºäºæœ€æ–°æ˜¾ç¤ºçš„å€¼
        const domLikeCount = parseInt(likeCountElement?.textContent || '0');
        const domCommentCount = parseInt(document.getElementById('comment-' + postId)?.textContent || '0');
        
        // æ›´æ–°ç¼“å­˜ï¼Œä½¿ç”¨DOMä¸­çš„æœ€æ–°å€¼
        let currentCounts = { likeCount: domLikeCount, commentCount: domCommentCount };
        countsCache.set(postId, currentCounts);
        
        if (isCurrentlyLiked) {
          // å–æ¶ˆç‚¹èµ
          await fetch('/api/likes', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ postId, userNickname: nickname })
          });
          btn.classList.remove('liked');
          icon.textContent = 'ğŸ¤';
          
          // æ›´æ–°æœ¬åœ°ç¼“å­˜å’ŒDOMä¸­çš„ç‚¹èµæ•°
          currentCounts.likeCount = Math.max(0, currentCounts.likeCount - 1);
          countsCache.set(postId, currentCounts);
          if (likeCountElement) {
            likeCountElement.textContent = currentCounts.likeCount;
          }
        } else {
          // æ·»åŠ ç‚¹èµ
          await fetch('/api/likes', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ postId, userNickname: nickname })
          });
          btn.classList.add('liked');
          icon.textContent = 'â¤ï¸';
          
          // æ›´æ–°æœ¬åœ°ç¼“å­˜å’ŒDOMä¸­çš„ç‚¹èµæ•°
          currentCounts.likeCount += 1;
          countsCache.set(postId, currentCounts);
          if (likeCountElement) {
            likeCountElement.textContent = currentCounts.likeCount;
          }
        }
        
        // ä¸å†éœ€è¦è°ƒç”¨loadLikeAndCommentCountï¼Œç›´æ¥æ›´æ–°äº†ç¼“å­˜å’ŒDOM
      } catch (err) {
        console.log('ç‚¹èµæ“ä½œå¤±è´¥', err);
        // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œé‡æ–°åŠ è½½æœ€æ–°æ•°æ®
        loadLikeAndCommentCount(postId);
      }
    }

    // è¯„è®ºå›¾ç‰‡ç®¡ç†
    const commentPendingImages = new Map(); // Map<postId, string[]>

    async function handleCommentImageSelect(event, postId) {
      const files = event.target.files;
      if (!files.length) return;

      let currentImages = commentPendingImages.get(postId) || [];
      if (currentImages.length + files.length > 4) {
        alert('æœ€å¤šåªèƒ½ä¸Šä¼  4 å¼ å›¾ç‰‡');
        event.target.value = '';
        return;
      }

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (!file.type.startsWith('image/')) continue;
        try {
          const compressedBase64 = await compressImage(file);
          currentImages.push(compressedBase64);
        } catch (err) {
          console.error('å›¾ç‰‡å‹ç¼©å¤±è´¥:', err);
        }
      }
      
      commentPendingImages.set(postId, currentImages);
      updateCommentPreview(postId);
      event.target.value = '';
    }

    function updateCommentPreview(postId) {
      const list = document.getElementById('comment-preview-' + postId);
      const images = commentPendingImages.get(postId) || [];
      
      if (images.length === 0) {
        list.style.display = 'none';
        list.innerHTML = '';
        return;
      }
      
      list.style.display = 'flex';
      list.innerHTML = images.map((img, index) => `
        <div class="comment-preview-item">
          <img src="${img}">
          <button class="remove-btn" onclick="removeCommentImage('${postId}', ${index})">Ã—</button>
        </div>
      `).join('');
    }

    function removeCommentImage(postId, index) {
      let images = commentPendingImages.get(postId) || [];
      images.splice(index, 1);
      commentPendingImages.set(postId, images);
      updateCommentPreview(postId);
    }

    // å‘é€è¯„è®º
    async function sendComment(postId) {
      const input = document.getElementById('comment-input-' + postId);
      const content = input.value.trim();
      const images = commentPendingImages.get(postId) || [];
      
      if (!content && images.length === 0) return alert('å†™ç‚¹è¯„è®ºæˆ–å‘å¼ å›¾å†å‘å“¦ï½');

      // åˆ›å»ºè¯„è®ºå¯¹è±¡ (ä»…ç”¨äºä¹è§‚UIæ›´æ–°ï¼Œå®é™…æ•°æ®ä»¥æœåŠ¡å™¨è¿”å›ä¸ºå‡†)
      const newComment = {
        author: nickname,
        content: content || 'åˆ†äº«äº†ä¸€å¼ å›¾ç‰‡',
        images: images,
        createdAt: new Date()
      };

      try {
        // å‘é€è¯„è®ºåˆ°æœåŠ¡å™¨
        const res = await fetch('/api/comments/post', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}` // æ·»åŠ  Token
          },
          body: JSON.stringify({ postId, content: newComment.content, author: nickname, images })
        });
        
        const data = await res.json();

        if (!res.ok) {
          if (res.status === 401) {
             alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
             logout();
             return;
          }
          throw new Error(data.message || 'å‘é€å¤±è´¥');
        }

        // æ¸…ç©ºè¾“å…¥æ¡†å’Œå›¾ç‰‡
        input.value = '';
        commentPendingImages.set(postId, []);
        updateCommentPreview(postId);
        
        // æ›´æ–°æœ¬åœ°ç¼“å­˜å’ŒDOMä¸­çš„è¯„è®ºæ•°
        const currentCounts = countsCache.get(postId) || { likeCount: 0, commentCount: 0 };
        currentCounts.commentCount += 1;
        countsCache.set(postId, currentCounts);
        const commentCountElement = document.getElementById('comment-' + postId);
        if (commentCountElement) {
          commentCountElement.textContent = currentCounts.commentCount;
        }
        
        // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨ä»¥æ˜¾ç¤ºæœ€æ–°æ•°æ® (åŒ…å«å¤´åƒç­‰å®Œæ•´ä¿¡æ¯)
        loadComments(postId);

      } catch (err) {
        alert('è¯„è®ºå‘é€å¤±è´¥: ' + err.message);
        console.error(err);
      }
    }

    function toggleComments(postId) {
      const comments = document.getElementById('comments-' + postId);
      comments.classList.toggle('show');
      
      // å¦‚æœè¯„è®ºåŒºåŸŸç°åœ¨æ˜¯æ˜¾ç¤ºçŠ¶æ€
      if (comments.classList.contains('show')) {
        // å¦‚æœè¯„è®ºåŒºåŸŸæ˜¯ç©ºçš„ï¼ŒåŠ¨æ€æ¸²æŸ“è¯„è®ºè¾“å…¥æ¡†å’Œè¯„è®ºåˆ—è¡¨
        if (comments.innerHTML.trim() === '') {
          comments.innerHTML = `
            <div class="comment-box">
              <span class="id">è¯„è®ºå›å¤</span>
              <div class="comment-input-area">
                <textarea class="comment-textarea" id="comment-input-${postId}" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." onclick="event.stopPropagation();" onfocus="event.stopPropagation();"></textarea>
                <div class="comment-preview-list" id="comment-preview-${postId}"></div>
              </div>
              
              <div class="comment-footer">
                <div class="comment-tools">
                   <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
                  <input type="file" id="comment-image-${postId}" accept="image/*" multiple onchange="handleCommentImageSelect(event, '${postId}')" style="display:none">
                  
                  <button class="comment-tool-btn" onclick="document.getElementById('comment-image-${postId}').click()" title="æ·»åŠ å›¾ç‰‡">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                  </button>
                  
                  <button class="comment-tool-btn" onclick="event.stopPropagation(); toggleEmojiPicker('${postId}')" title="è¡¨æƒ…">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                  </button>
                  
                  ${generateEmojiPickerHTML(postId)}
                </div>
                
                <button class="comment-send-btn" onclick="event.stopPropagation(); sendComment('${postId}')">å‘é€</button>
              </div>
            </div>
            <div id="comment-list-${postId}">åŠ è½½ä¸­...</div>
          `;
          
          // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
          /* ç§»é™¤æ—§çš„ auto-resize é€»è¾‘ï¼Œå› ä¸ºç°åœ¨æœ‰æœ€å°é«˜åº¦
          const textarea = document.getElementById(`comment-input-${postId}`);
          textarea.addEventListener('input', function() {
            this.style.height = '24px';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
          });
          */
        }
        
        // åŠ è½½è¯„è®ºåˆ—è¡¨
        loadComments(postId);
      }
    }

    async function refreshGuestToken() {
      try {
        const res = await fetch('/api/auth/guest', { method: 'POST' });
        const data = await res.json();
        if (data.token) {
          localStorage.setItem('token', data.token);
          return true;
        }
      } catch (e) {
        console.error('Failed to refresh guest token', e);
      }
      return false;
    }

    // å…¨å±€å˜é‡
    let pendingImages = []; // å¾…ä¸Šä¼ çš„å›¾ç‰‡(Base64)

    // å¤„ç†å›¾ç‰‡é€‰æ‹©
    async function handleImageSelect(event) {
      const files = event.target.files;
      if (!files.length) return;

      if (pendingImages.length + files.length > 4) {
        alert('æœ€å¤šåªèƒ½ä¸Šä¼  4 å¼ å›¾ç‰‡');
        event.target.value = ''; // æ¸…ç©ºé€‰æ‹©
        return;
      }

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (!file.type.startsWith('image/')) continue;

        try {
          const compressedBase64 = await compressImage(file);
          pendingImages.push(compressedBase64);
        } catch (err) {
          console.error('å›¾ç‰‡å‹ç¼©å¤±è´¥:', err);
          alert('æŸå¼ å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œå·²è·³è¿‡');
        }
      }

      updatePreview();
      event.target.value = ''; // æ¸…ç©ºé€‰æ‹©ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€å¼ 
    }

    // å›¾ç‰‡å‹ç¼©å‡½æ•° (ä½¿ç”¨ Canvas)
    function compressImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            // è®¾ç½®æœ€å¤§å°ºå¯¸
            const maxWidth = 1024;
            const maxHeight = 1024;
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > maxWidth) {
                height = Math.round((height * maxWidth) / width);
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = Math.round((width * maxHeight) / height);
                height = maxHeight;
              }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // å‹ç¼©è´¨é‡ 0.7
            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
            resolve(dataUrl);
          };
          img.onerror = reject;
        };
        reader.onerror = reject;
      });
    }

    // æ›´æ–°é¢„è§ˆåŒºåŸŸ
    function updatePreview() {
      const list = document.getElementById('previewList');
      list.innerHTML = pendingImages.map((img, index) => `
        <div class="preview-item">
          <img src="${img}" class="preview-image">
          <button class="remove-btn" onclick="removeImage(${index})">Ã—</button>
        </div>
      `).join('');
    }

    // ç§»é™¤å¾…ä¸Šä¼ å›¾ç‰‡
    function removeImage(index) {
      pendingImages.splice(index, 1);
      updatePreview();
    }

    async function send(retryCount = 0) {
      const content = document.getElementById('content').value.trim();
      if (!content && pendingImages.length === 0) return alert('å†™ç‚¹ä¸œè¥¿æˆ–å‘å¼ å›¾å§ï½');

      if (retryCount > 1) {
        alert('ç½‘ç»œä¸ç¨³å®šï¼Œå‘é€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
        const sendBtn = document.querySelector('.post-box .send-btn');
        if (sendBtn) {
           sendBtn.disabled = false;
           sendBtn.innerHTML = 'å‘é€';
        }
        return;
      }
      
      const sendBtn = document.querySelector('.post-box .send-btn');
      const originalText = 'å‘é€'; // ç¡¬ç¼–ç åŸå§‹æ–‡æœ¬ï¼Œé˜²æ­¢è¢«è¦†ç›–

      try {
        sendBtn.disabled = true;
        sendBtn.innerHTML = 'â³ å‘é€ä¸­...';

        const res = await fetch('/api/posts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': localStorage.getItem('token') ? `Bearer ${localStorage.getItem('token')}` : ''
          },
          body: JSON.stringify({ 
            content: content || 'åˆ†äº«äº†ä¸€å¼ å›¾ç‰‡', 
            author: nickname, 
            isAnonymous: false,
            images: pendingImages 
          })
        });

        const data = await res.json();

        if (!res.ok) {
          if (res.status === 401) {
            if (nickname === 'è®¿å®¢' || nickname.startsWith('è®¿å®¢') || localStorage.getItem('nickname')?.startsWith('è®¿å®¢')) {
              console.log('è®¿å®¢Tokenæ— æ•ˆï¼Œå°è¯•åˆ·æ–°...');
              const refreshed = await refreshGuestToken();
              if (refreshed) {
                return send(retryCount + 1);
              }
            } else {
              alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
              logout();
              return;
            }
          }
          throw new Error(data.message || 'å‘é€å¤±è´¥');
        }

        document.getElementById('content').value = '';
        pendingImages = []; 
        updatePreview(); 
        
        sendBtn.innerHTML = 'âœ… å‘é€æˆåŠŸ';
        
        // ç«‹å³åˆ·æ–°åˆ—è¡¨
        loadPosts(1);
        
        setTimeout(() => {
          sendBtn.disabled = false;
          sendBtn.innerHTML = originalText;
        }, 1500);

      } catch (err) {
        console.error('å‘é€å¤±è´¥:', err);
        alert('å‘é€å¤±è´¥: ' + err.message);
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
      }
    }

    // åˆå§‹åŠ è½½
    loadPosts();
    
    // ç›‘å¬æ–°å¸–å­ï¼Œä½†ä¸è‡ªåŠ¨åˆ·æ–°æ•´ä¸ªé¡µé¢
    let lastPostCount = 0;
    async function checkForNewPosts() {
      try {
        // ä½¿ç”¨æ–°çš„/totalç«¯ç‚¹åªè·å–å¸–å­æ€»æ•°ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“
        const res = await fetch('/api/posts/total');
        const data = await res.json();
        if (data.total > lastPostCount && lastPostCount !== 0) {
          // åªåœ¨æœ‰æ–°å¸–å­æ—¶é€šçŸ¥ç”¨æˆ·ï¼Œè€Œä¸æ˜¯è‡ªåŠ¨åˆ·æ–°
          const newPosts = data.total - lastPostCount;
          const notice = document.createElement('div');
          notice.style.cssText = 'position:fixed;top:20px;right:20px;background:#80cbc4;color:white;padding:15px;border-radius:10px;cursor:pointer;z-index:1000;';
          notice.innerHTML = `æœ‰ ${newPosts} æ¡æ–°å¸–å­ï¼Œ<span style="text-decoration:underline;">ç‚¹å‡»åˆ·æ–°</span>`;
          notice.onclick = () => {
            loadPosts();
            document.body.removeChild(notice);
          };
          document.body.appendChild(notice);
          // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
          setTimeout(() => {
            if (document.body.contains(notice)) {
              document.body.removeChild(notice);
            }
          }, 3000);
        }
        lastPostCount = data.total;
      } catch (err) {
        console.log('æ£€æŸ¥æ–°å¸–å­å¤±è´¥', err);
      }
    }
    
    // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ–°å¸–å­
    setInterval(checkForNewPosts, 30000);

    // æ³¨å†Œ Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('Service Worker Registered'))
          .catch(err => console.log('Service Worker Error', err));
      });
    }
  </script>
  <script src="image-viewer.js"></script>
</body>
</html>