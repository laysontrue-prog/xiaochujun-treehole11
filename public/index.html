<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°æ¥šå›çš„æ ‘æ´ - å¹¿åœº</title>
  <style>
    /* å…¨å±€æ ·å¼é‡ç½®ä¸åŸºç¡€è®¾ç½® */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #2d3748;
    }
    
    /* é¡¶éƒ¨å¯¼èˆª */
    .top {
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 20px rgba(0,0,0,0.08);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .top-left {
      display: flex;
      align-items: center;
    }
    
    .top-left img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      margin-right: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .top-left span {
      font-weight: 700;
      color: #2d3748;
      font-size: 18px;
      letter-spacing: -0.5px;
    }
    
    .top-right {
      color: #718096;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .top-right button {
      padding: 10px 18px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .logout-btn {
      background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
      color: #c53030;
    }
    
    .logout-btn:hover {
      background: linear-gradient(135deg, #feb2b2 0%, #fc8181 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
    }
    
    .switch-btn {
      background: rgba(255, 255, 255, 0.9);
      color: #4299e1;
      border: 2px solid rgba(66, 153, 225, 0.3);
    }
    
    .switch-btn:hover {
      background: rgba(66, 153, 225, 0.1);
      border-color: rgba(66, 153, 225, 0.6);
      transform: translateY(-2px);
    }

    /* ä¸»å†…å®¹åŒº */
    .content { 
      flex: 1; 
      padding: 25px; 
      overflow-y: auto; 
      padding-bottom: 90px; /* ç•™å‡ºåº•éƒ¨å¯¼èˆªç©ºé—´ */
      max-width: 1000px;
      margin: 0 auto;
      width: 100%;
    }
    
    /* æ ‡é¢˜æ ·å¼ */
    .title {
      text-align: center;
      font-size: 32px;
      color: #2d3748;
      margin: 25px 0 10px;
      font-weight: 700;
      letter-spacing: -1px;
    }
    
    .subtitle {
      text-align: center;
      color: #718096;
      margin-bottom: 35px;
      font-size: 16px;
      font-weight: 500;
    }

    /* å‘å¸ƒæ¡†æ ·å¼ - Windows 7/è‹¹æœOS26é£æ ¼åŠé€æ˜æ•ˆæœ */
    .post-box {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      padding: 25px;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 35px;
      display: flex;
      align-items: center;
      gap: 15px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }
    
    .post-box:hover {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }
    
    .post-box .id {
      color: #718096;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .post-box textarea {
      flex: 1;
      border: none;
      outline: none;
      font-size: 16px;
      resize: none;
      height: 70px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 16px;
      color: #2d3748;
      font-family: inherit;
      transition: all 0.3s ease;
    }
    
    .post-box textarea:focus {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 0 3px rgba(0, 176, 155, 0.1);
    }
    
    .post-box button {
      background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 28px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 176, 155, 0.3);
    }
    
    .post-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 176, 155, 0.4);
      background: linear-gradient(135deg, #009c87 0%, #85b535 100%);
    }

    /* å¸–å­å¡ç‰‡æ ·å¼ - Windows 7/è‹¹æœOS26é£æ ¼åŠé€æ˜æ•ˆæœ */
    .post-card { 
      background: rgba(255, 255, 255, 0.7); 
      backdrop-filter: blur(15px); 
      -webkit-backdrop-filter: blur(15px); 
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.12); 
      margin-bottom: 25px;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .post-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #00b09b, #96c93d);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s ease;
    }
    
    .post-card:hover {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 15px 50px rgba(0,0,0,0.15);
      transform: translateY(-3px);
    }
    
    .post-card:hover::before {
      transform: scaleX(1);
    }
    
    .post-card p {
      margin: 0 0 15px;
      color: #4a5568;
      font-size: 16px;
      line-height: 1.7;
      word-wrap: break-word;
    }
    
    .post-card .author {
      color: #718096;
      font-size: 14px;
      font-weight: 500;
    }
    
    .post-card .time {
      float: right;
      color: #a0aec0;
      font-size: 12px;
      font-weight: 500;
    }
    
    /* å¾®ä¿¡é£æ ¼çš„ç‚¹èµè¯„è®ºæ ·å¼ */
    .post-card .actions {
      margin-top: 18px;
      padding-top: 15px;
      border-top: 2px solid #f7fafc;
      display: flex;
      justify-content: flex-start;
      gap: 25px;
      font-size: 14px;
      color: #718096;
    }
    
    .post-card .action-btn {
      cursor: pointer;
      padding: 10px 16px;
      border-radius: 20px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }
    
    .post-card .action-btn:hover {
      background: #f7fafc;
      color: #4a5568;
      transform: translateY(-1px);
    }
    
    .post-card .like.liked {
      color: #e53e3e;
    }
    
    .post-card .action-btn.like .like-count {
      font-size: 13px;
      font-weight: 600;
    }
    
    /* ç‚¹èµåŠ¨ç”»æ•ˆæœ */
    @keyframes likeAnimation {
      0% { transform: scale(1); }
      50% { transform: scale(1.5); }
      100% { transform: scale(1); }
    }
    
    .post-card .action-btn.like.liked [id^="like-icon"] {
      animation: likeAnimation 0.5s ease;
    }
    
    /* ç§»åŠ¨ç«¯é€‚é…ä¼˜åŒ– */
    @media (max-width: 768px) {
      /* è°ƒæ•´å…¨å±€é—´è· */
      body {
        font-size: 14px;
      }
      
      /* é¡¶éƒ¨å¯¼èˆªé€‚é… */
      .top {
        padding: 12px 15px;
      }
      
      .top-left img {
        width: 38px;
        height: 38px;
        margin-right: 10px;
      }
      
      .top-left span {
        font-size: 16px;
      }
      
      .top-right {
        gap: 10px;
      }
      
      .top-right button {
        padding: 8px 14px;
        font-size: 12px;
      }
      
      /* å†…å®¹åŒºåŸŸé€‚é… */
      .content {
        padding: 15px;
        padding-bottom: 80px;
      }
      
      .title {
        font-size: 26px;
        margin: 20px 0 8px;
      }
      
      .subtitle {
        font-size: 14px;
        margin-bottom: 25px;
      }
      
      /* å‘å¸ƒæ¡†é€‚é… */
      .post-box {
        padding: 20px;
        margin-bottom: 25px;
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      .post-box .id {
        align-self: flex-start;
      }
      
      .post-box textarea {
        height: 60px;
        font-size: 15px;
        padding: 10px 14px;
      }
      
      .post-box button {
        padding: 12px 24px;
        font-size: 15px;
      }
      
      /* å¸–å­å¡ç‰‡é€‚é… */
      .post-card {
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .post-card p {
        font-size: 15px;
        line-height: 1.6;
      }
      
      /* æ“ä½œæŒ‰é’®é€‚é… */
      .post-card .actions {
        gap: 15px;
        font-size: 13px;
      }
      
      .post-card .action-btn {
        padding: 8px 12px;
        gap: 6px;
      }
      
      /* åˆ†é¡µé€‚é… */
      #pagination {
        gap: 8px;
      }
      
      #pagination span {
        padding: 8px 12px;
        font-size: 13px;
      }
    }
    
    /* å°å±å¹•æ‰‹æœºé€‚é… */
    @media (max-width: 480px) {
      /* è¿›ä¸€æ­¥è°ƒæ•´é—´è· */
      .content {
        padding: 12px;
      }
      
      .title {
        font-size: 22px;
      }
      
      .post-box,
      .post-card {
        padding: 18px;
      }
      
      /* è°ƒæ•´æ“ä½œæŒ‰é’®å¸ƒå±€ */
      .post-card .actions {
        gap: 12px;
      }
      
      .post-card .action-btn {
        padding: 6px 10px;
        font-size: 12px;
      }
    }

    /* è¯„è®ºåŒºæ ·å¼ */
    .post-card .comments {
      margin-top: 20px;
      padding: 15px;
      border-top: 2px solid #f7fafc;
      display: none;
      background: rgba(247, 250, 252, 0.8);
      border-radius: 15px;
    }
    
    .post-card .comments.show {
      display: block;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* è¡¨æƒ…é€‰æ‹©å™¨ */
    .emoji-picker {
      position: absolute;
      bottom: 70px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 15px;
      padding: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 12px;
      z-index: 100;
      display: none;
    }
    
    .emoji-picker.show {
      display: grid;
    }
    
    .emoji-item {
      font-size: 22px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      text-align: center;
      transition: all 0.2s ease;
    }
    
    .emoji-item:hover {
      background: #f0f4f8;
      transform: scale(1.2);
    }
    
    /* è¯„è®ºè¾“å…¥æ ·å¼ */
    .post-card .comment-input {
      display: flex;
      margin-top: 15px;
      gap: 12px;
    }
    
    .post-card .comment-input textarea {
      flex: 1;
      border: 2px solid #e2e8f0;
      border-radius: 25px;
      padding: 12px 16px;
      resize: none;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.8);
    }
    
    .post-card .comment-input textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: white;
    }
    
    .post-card .comment-input button {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    .post-card .comment-input button:hover {
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
    }
    
    /* è¯„è®ºé¡¹æ ·å¼ */
    .post-card .comment-item {
      padding: 12px 0;
      border-bottom: 1px solid #edf2f7;
      font-size: 14px;
      color: #4a5568;
      line-height: 1.6;
    }
    
    .post-card .comment-item:last-child {
      border-bottom: none;
    }
    
    .post-card .comment-item strong {
      color: #2d3748;
      font-weight: 600;
      margin-right: 8px;
    }

    /* ç©ºçŠ¶æ€æ ·å¼ */
    .empty {
      text-align: center;
      color: #a0aec0;
      margin: 60px 0;
      padding: 40px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 2px dashed #e2e8f0;
    }
    
    .empty img {
      width: 100px;
      margin-bottom: 25px;
      opacity: 0.7;
    }
    
    .empty p {
      font-size: 18px;
      font-weight: 500;
      margin: 0;
    }

    /* åº•éƒ¨å¯¼èˆª */
    .bottom-nav {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-around;
      padding: 18px 0;
      box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
      position: fixed;
      bottom: 0;
      width: 100%;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* åˆ†é¡µæ§ä»¶ */
    #pagination {
      display: flex;
      justify-content: center;
      gap: 12px;
      padding: 25px 0;
      flex-wrap: wrap;
    }
    
    #pagination button {
      padding: 10px 18px;
      border: 2px solid #e2e8f0;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #718096;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    #pagination button:hover:not(:disabled) {
      border-color: #00b09b;
      color: #00b09b;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 176, 155, 0.2);
    }
    
    #pagination button.active {
      background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
      color: white;
      border-color: #00b09b;
    }
    
    #pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* åˆ†é¡µçœç•¥å·æ ·å¼ */
    #pagination .pagination-ellipsis {
      padding: 10px 8px;
      font-size: 14px;
      font-weight: 600;
      color: #718096;
    }
    
    /* å¯¼èˆªé¡¹æ ·å¼ */
    .nav-item {
      text-align: center;
      color: #a0aec0;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 5px 10px;
      border-radius: 15px;
    }
    
    .nav-item.active {
      color: #00b09b;
      background: rgba(0, 176, 155, 0.1);
    }
    
    .nav-item:hover {
      color: #00b09b;
      transform: translateY(-2px);
    }
    
    .nav-item img {
      width: 28px;
      height: 28px;
      margin-bottom: 6px;
      transition: all 0.3s ease;
    }
    
    .nav-item:hover img {
      transform: scale(1.2);
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .content {
        padding: 20px 15px;
      }
      
      .post-box {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }
      
      .post-box .id {
        text-align: center;
      }
      
      .title {
        font-size: 26px;
      }
      
      .post-card {
        padding: 20px;
      }
      
      .post-card .actions {
        gap: 15px;
      }
      
      .post-card .action-btn {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      .nav-item img {
        width: 26px;
        height: 26px;
      }
    }
  </style>
</head>
<body>
  <div class="top">
   <div class="top-left">
  <button style="background:none;border:none;font-size:28px;cursor:pointer;margin-right:10px;" onclick="history.back()">â†</button>
  <img src="logo.png" alt="Logo">
  <span>å°æ¥šå›çš„æ ‘æ´</span>
</div>
    <div class="top-right">
      æ¬¢è¿ï¼Œ<span id="nickname">åŠ è½½ä¸­...</span>
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
      <button class="switch-btn" onclick="logout()">åˆ‡æ¢è´¦æˆ·</button>
    </div>
  </div>

  <div class="content">
    <h1 class="title">æ ‘æ´å¹¿åœº</h1>
    <p class="subtitle">åœ¨å¤§æ ‘ä¸‹ï¼Œè‡ªç”±åœ°å‘¼å¸ï¼Œè‡ªç”±åœ°è¡¨è¾¾ã€‚</p>

    <div class="post-box">
      <span class="id">å½“å‰èº«ä»½ï¼š<span id="currentId">åŠ è½½ä¸­...</span></span>
      <textarea id="content" placeholder="ä»Šå¤©æœ‰ä»€ä¹ˆæƒ³å¯¹æ ‘æ´è¯´çš„å—ï¼Ÿ..."></textarea>
      <button onclick="send()">å‘é€</button>
    </div>

    <div id="posts-list"></div>

    <div class="empty" id="empty-state">
      <img src="https://img.icons8.com/color/96/null/leaf.png" alt="ç©º">
      <p>é£å¹è¿‡æ ‘æ¢¢ï¼Œå¹¿åœºä¸Šé™æ‚„æ‚„çš„...</p>
    </div>

    <!-- åˆ†é¡µæ§ä»¶å®¹å™¨ -->
    <div id="pagination" style="display:flex;justify-content:center;gap:10px;padding:20px 0;">
      <!-- åˆ†é¡µæ§ä»¶å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="location.href='/'">
      <img src="https://img.icons8.com/color/48/null/leaf.png" alt="å¹¿åœº">
      <div>æ ‘æ´å¹¿åœº</div>
    </div>
    <div class="nav-item" onclick="location.href='/topic.html'">
      <img src="https://img.icons8.com/color/48/null/speech-bubble.png" alt="è¯é¢˜">
      <div>è¯é¢˜è®¨è®º</div>
    </div>
    <div class="nav-item" onclick="location.href='/capsule.html'">
      <img src="https://img.icons8.com/color/48/null/hourglass.png" alt="èƒ¶å›Š">
      <div>æ—¶é—´èƒ¶å›Š</div>
    </div>
    <div class="nav-item" onclick="location.href='/profile.html'">
      <img src="https://img.icons8.com/color/48/null/user.png" alt="æˆ‘çš„">
      <div>æˆ‘çš„</div>
    </div>
  </div>

  <script>
    if (!localStorage.getItem('token')) {
      window.location.href = '/login.html';
    }

    const nickname = localStorage.getItem('nickname') || 'è®¿å®¢';
    document.getElementById('nickname').textContent = nickname;
    document.getElementById('currentId').textContent = nickname;

    function logout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºæˆ–åˆ‡æ¢è´¦æˆ·å—ï¼Ÿ')) {
        localStorage.removeItem('token');
        localStorage.removeItem('nickname');
        window.location.href = '/login.html';
      }
    }

    let currentPage = 1;
    let totalPages = 1;

    async function loadPosts(page = 1) {
      try {
        const res = await fetch(`/api/posts?page=${page}&limit=10`);
        const response = await res.json();
        const posts = response.posts;
        const list = document.getElementById('posts-list');
        const empty = document.getElementById('empty-state');
        const pagination = document.getElementById('pagination');

        if (posts.length === 0) {
          empty.style.display = 'block';
          list.innerHTML = '';
          pagination.style.display = 'none';
          return;
        }

        empty.style.display = 'none';
        list.innerHTML = posts.map(p => `
          <div class="post-card" onclick="toggleComments('${p._id}')">
            <p>${p.content.replace(/\n/g,'<br>')}</p>
            <div>
              <span class="author">â€” ${p.author}</span>
              <span class="time">${new Date(p.createdAt).toLocaleString()}</span>
            </div>
            <div class="actions">
              <span class="action-btn like" id="like-btn-${p._id}" onclick="event.stopPropagation(); toggleLike('${p._id}')">
                <span id="like-icon-${p._id}">ğŸ¤</span> ç‚¹èµ (<span class="like-count" id="like-${p._id}">${p.likeCount || 0}</span>)
              </span>
              <span class="action-btn comment" onclick="event.stopPropagation(); toggleComments('${p._id}')">
                ğŸ’¬ è¯„è®º (<span class="comment-count" id="comment-${p._id}">${p.commentCount || 0}</span>)
              </span>
            </div>
            <div class="comments" id="comments-${p._id}"></div>
          </div>
        `).join('');
        
        // ä¿å­˜å¸–å­æ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œä¾¿äºåç»­åŠ¨æ€æ¸²æŸ“è¯„è®ºåŒºåŸŸ
        window.postsData = window.postsData || {};
        const postIds = posts.map(p => p._id);
        
        // åˆå§‹åŒ–countsCacheï¼Œç¡®ä¿ç‚¹èµæ•°å’Œè¯„è®ºæ•°ä»æœåŠ¡å™¨æ•°æ®å¼€å§‹
        posts.forEach(p => {
          window.postsData[p._id] = p;
          countsCache.set(p._id, {
            likeCount: p.likeCount || 0,
            commentCount: p.commentCount || 0
          });
        });
        
        // æ‰¹é‡åŠ è½½ç‚¹èµçŠ¶æ€ï¼Œå‡å°‘APIè¯·æ±‚æ¬¡æ•°
        loadLikeStatusBatch(postIds);

        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        currentPage = response.currentPage;
        totalPages = response.totalPages;
        
        // æ¸²æŸ“åˆ†é¡µæ§ä»¶
        renderPagination();

      } catch (err) {
        console.log('åŠ è½½å¤±è´¥', err);
      }
    }

    // æ¸²æŸ“åˆ†é¡µæ§ä»¶
    function renderPagination() {
      const pagination = document.getElementById('pagination');
      if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
      }

      let html = '';
      
      // ä¸Šä¸€é¡µæŒ‰é’®
      html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="loadPosts(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
      
      // é¡µç æŒ‰é’® - åªæ˜¾ç¤ºå½“å‰é¡µé™„è¿‘çš„é¡µç 
      const visiblePages = 5; // å¯è§é¡µç æ•°é‡
      const halfVisible = Math.floor(visiblePages / 2);
      let startPage = Math.max(1, currentPage - halfVisible);
      let endPage = Math.min(totalPages, startPage + visiblePages - 1);
      
      // è°ƒæ•´å¼€å§‹é¡µç ï¼Œç¡®ä¿æ˜¾ç¤ºè¶³å¤Ÿçš„é¡µç 
      if (endPage - startPage + 1 < visiblePages) {
        startPage = Math.max(1, endPage - visiblePages + 1);
      }
      
      // é¦–é¡µæŒ‰é’®
      if (startPage > 1) {
        html += `<button onclick="loadPosts(1)">1</button>`;
        if (startPage > 2) {
          html += `<span class="pagination-ellipsis">...</span>`;
        }
      }
      
      // ä¸­é—´é¡µç æŒ‰é’®
      for (let i = startPage; i <= endPage; i++) {
        html += `<button ${i === currentPage ? 'class="active"' : ''} onclick="loadPosts(${i})">${i}</button>`;
      }
      
      // æœ«é¡µæŒ‰é’®
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          html += `<span class="pagination-ellipsis">...</span>`;
        }
        html += `<button onclick="loadPosts(${totalPages})">${totalPages}</button>`;
      }
      
      // ä¸‹ä¸€é¡µæŒ‰é’®
      html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="loadPosts(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
      
      pagination.innerHTML = html;
      pagination.style.display = 'flex';
    }

    // æ‰¹é‡åŠ è½½ç‚¹èµçŠ¶æ€ï¼Œå‡å°‘APIè¯·æ±‚æ¬¡æ•°
    async function loadLikeStatusBatch(postIds) {
      try {
        if (postIds.length === 0) return;
        
        // ä½¿ç”¨æ‰¹é‡APIè·å–æ‰€æœ‰å¸–å­çš„ç‚¹èµçŠ¶æ€
        const res = await fetch('/api/likes/check-multiple', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            postIds,
            userNickname: nickname
          })
        });
        
        const data = await res.json();
        const postLikes = data.postLikes || {};
        
        // æ›´æ–°æ‰€æœ‰å¸–å­çš„ç‚¹èµçŠ¶æ€
        postIds.forEach(postId => {
          const isLiked = !!postLikes[postId];
          const likeBtn = document.getElementById('like-btn-' + postId);
          const likeIcon = document.getElementById('like-icon-' + postId);
          
          if (likeBtn && likeIcon) {
            if (isLiked) {
              likeBtn.classList.add('liked');
              likeIcon.textContent = 'â¤ï¸';
            } else {
              likeBtn.classList.remove('liked');
              likeIcon.textContent = 'ğŸ¤';
            }
          }
        });
      } catch (err) {
        console.log('æ‰¹é‡åŠ è½½ç‚¹èµçŠ¶æ€å¤±è´¥', err);
      }
    }
    
    // å•ç¯‡å¸–å­ç‚¹èµçŠ¶æ€åŠ è½½ï¼ˆç”¨äºå•ä¸ªæ“ä½œåæ›´æ–°ï¼‰
    async function loadLikeStatus(postId) {
      try {
        // æ£€æŸ¥å½“å‰ç”¨æˆ·çš„ç‚¹èµçŠ¶æ€
        const checkRes = await fetch(`/api/likes/check?postId=${postId}&userNickname=${nickname}`);
        const checkData = await checkRes.json();
        const likeBtn = document.getElementById('like-btn-' + postId);
        const likeIcon = document.getElementById('like-icon-' + postId);
        
        if (checkData.isLiked) {
          likeBtn.classList.add('liked');
          likeIcon.textContent = 'â¤ï¸';
        } else {
          likeBtn.classList.remove('liked');
          likeIcon.textContent = 'ğŸ¤';
        }
      } catch (err) {
        console.log('åŠ è½½ç‚¹èµçŠ¶æ€å¤±è´¥', err);
      }
    }

    // ç¼“å­˜å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨ç‚¹èµæ•°å’Œè¯„è®ºæ•°
    const countsCache = new Map();
    
    // æ‰¹é‡åŠ è½½ç‚¹èµæ•°å’Œè¯„è®ºæ•°
    async function loadLikeAndCommentCountBatch(postIds) {
      try {
        if (postIds.length === 0) return;
        
        // è¿‡æ»¤æ‰å·²ç¼“å­˜çš„æ•°æ®
        const uncachedIds = postIds.filter(id => !countsCache.has(id));
        
        if (uncachedIds.length > 0) {
          const res = await fetch(`/api/posts/counts?postIds=${uncachedIds.join(',')}`);
          const data = await res.json();
          
          // æ›´æ–°ç¼“å­˜å¹¶åº”ç”¨åˆ°DOM
          Object.entries(data).forEach(([postId, counts]) => {
            countsCache.set(postId, counts);
            updateCountsInDOM(postId, counts);
          });
        } else {
          // ä»ç¼“å­˜æ›´æ–°DOM
          postIds.forEach(postId => {
            const counts = countsCache.get(postId);
            if (counts) {
              updateCountsInDOM(postId, counts);
            }
          });
        }
      } catch (err) {
        console.log('æ‰¹é‡åŠ è½½æ•°é‡å¤±è´¥', err);
      }
    }
    
    // æ›´æ–°DOMä¸­çš„ç‚¹èµæ•°å’Œè¯„è®ºæ•°
    function updateCountsInDOM(postId, counts) {
      const likeElement = document.getElementById('like-' + postId);
      const commentElement = document.getElementById('comment-' + postId);
      
      if (likeElement) {
        likeElement.textContent = counts.likeCount || 0;
      }
      
      if (commentElement) {
        commentElement.textContent = counts.commentCount || 0;
      }
    }
    
    // åŠ è½½ç‚¹èµæ•°å’Œè¯„è®ºæ•°ï¼ˆå…¼å®¹å•æ¡è°ƒç”¨ï¼‰
    async function loadLikeAndCommentCount(postId) {
      await loadLikeAndCommentCountBatch([postId]);
    }

    // åŠ è½½è¯„è®ºåˆ—è¡¨
    async function loadComments(postId) {
      try {
        const commentRes = await fetch(`/api/comments/post/${postId}`);
        const comments = await commentRes.json();

        const list = document.getElementById('comment-list-' + postId);
        if (comments.length === 0) {
          list.innerHTML = '<p style="color:#999;padding:10px;">æš‚æ— è¯„è®ºï¼Œæ¥æŠ¢æ²™å‘ï½</p>';
        } else {
          list.innerHTML = comments.map(c => `
            <div class="comment-item">
              <strong>${c.author}</strong>: ${c.content}
              <small style="color:#ccc;float:right;">${new Date(c.createdAt).toLocaleString()}</small>
            </div>
          `).join('');
        }
      } catch (err) {
        console.log('åŠ è½½è¯„è®ºå¤±è´¥', err);
      }
    }

    // åˆ‡æ¢è¡¨æƒ…é€‰æ‹©å™¨
    function toggleEmojiPicker(postId) {
      const picker = document.getElementById('emoji-picker-' + postId);
      picker.classList.toggle('show');
    }

    // æ’å…¥è¡¨æƒ…åˆ°è¯„è®ºæ¡†
    function insertEmoji(postId, emoji) {
      const input = document.getElementById('comment-input-' + postId);
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;
      input.value = text.substring(0, start) + emoji + text.substring(end);
      input.focus();
      input.setSelectionRange(start + emoji.length, start + emoji.length);
      
      // å…³é—­è¡¨æƒ…é€‰æ‹©å™¨
      toggleEmojiPicker(postId);
    }

    // ç‚¹èµ/å–æ¶ˆç‚¹èµåˆ‡æ¢
    async function toggleLike(postId) {
      const btn = document.getElementById('like-btn-' + postId);
      const icon = document.getElementById('like-icon-' + postId);
      const likeCountElement = document.getElementById('like-' + postId);
      
      try {
        // æ£€æŸ¥å½“å‰ç‚¹èµçŠ¶æ€
        const isCurrentlyLiked = btn.classList.contains('liked');
        
        // é¦–å…ˆä»DOMè·å–å½“å‰ç‚¹èµæ•°ï¼Œç¡®ä¿æ€»æ˜¯åŸºäºæœ€æ–°æ˜¾ç¤ºçš„å€¼
        const domLikeCount = parseInt(likeCountElement?.textContent || '0');
        const domCommentCount = parseInt(document.getElementById('comment-' + postId)?.textContent || '0');
        
        // æ›´æ–°ç¼“å­˜ï¼Œä½¿ç”¨DOMä¸­çš„æœ€æ–°å€¼
        let currentCounts = { likeCount: domLikeCount, commentCount: domCommentCount };
        countsCache.set(postId, currentCounts);
        
        if (isCurrentlyLiked) {
          // å–æ¶ˆç‚¹èµ
          await fetch('/api/likes', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ postId, userNickname: nickname })
          });
          btn.classList.remove('liked');
          icon.textContent = 'ğŸ¤';
          
          // æ›´æ–°æœ¬åœ°ç¼“å­˜å’ŒDOMä¸­çš„ç‚¹èµæ•°
          currentCounts.likeCount = Math.max(0, currentCounts.likeCount - 1);
          countsCache.set(postId, currentCounts);
          if (likeCountElement) {
            likeCountElement.textContent = currentCounts.likeCount;
          }
        } else {
          // æ·»åŠ ç‚¹èµ
          await fetch('/api/likes', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ postId, userNickname: nickname })
          });
          btn.classList.add('liked');
          icon.textContent = 'â¤ï¸';
          
          // æ›´æ–°æœ¬åœ°ç¼“å­˜å’ŒDOMä¸­çš„ç‚¹èµæ•°
          currentCounts.likeCount += 1;
          countsCache.set(postId, currentCounts);
          if (likeCountElement) {
            likeCountElement.textContent = currentCounts.likeCount;
          }
        }
        
        // ä¸å†éœ€è¦è°ƒç”¨loadLikeAndCommentCountï¼Œç›´æ¥æ›´æ–°äº†ç¼“å­˜å’ŒDOM
      } catch (err) {
        console.log('ç‚¹èµæ“ä½œå¤±è´¥', err);
        // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œé‡æ–°åŠ è½½æœ€æ–°æ•°æ®
        loadLikeAndCommentCount(postId);
      }
    }

    // å‘é€è¯„è®º
    async function sendComment(postId) {
      const input = document.getElementById('comment-input-' + postId);
      const content = input.value.trim();
      if (!content) return alert('å†™ç‚¹è¯„è®ºå†å‘å“¦ï½');

      // åˆ›å»ºè¯„è®ºå¯¹è±¡
      const newComment = {
        author: nickname,
        content: content,
        createdAt: new Date()
      };

      // å‘é€è¯„è®ºåˆ°æœåŠ¡å™¨
      await fetch('/api/comments/post', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ postId, content, author: nickname })
      });

      // æ¸…ç©ºè¾“å…¥æ¡†
      input.value = '';
      
      // æ›´æ–°æœ¬åœ°ç¼“å­˜å’ŒDOMä¸­çš„è¯„è®ºæ•°
      const currentCounts = countsCache.get(postId) || { likeCount: 0, commentCount: 0 };
      currentCounts.commentCount += 1;
      countsCache.set(postId, currentCounts);
      const commentCountElement = document.getElementById('comment-' + postId);
      if (commentCountElement) {
        commentCountElement.textContent = currentCounts.commentCount;
      }
      
      // ç«‹å³å°†æ–°è¯„è®ºæ·»åŠ åˆ°DOMä¸­ï¼Œè€Œä¸æ˜¯é‡æ–°åŠ è½½æ•´ä¸ªè¯„è®ºåˆ—è¡¨
      const commentListElement = document.getElementById('comment-list-' + postId);
      if (commentListElement) {
        // å¦‚æœå½“å‰æ²¡æœ‰è¯„è®ºï¼Œå…ˆæ¸…ç©ºå ä½ç¬¦
        if (commentListElement.innerHTML.includes('æš‚æ— è¯„è®º')) {
          commentListElement.innerHTML = '';
        }
        
        // åˆ›å»ºæ–°è¯„è®ºçš„HTML
        const newCommentHTML = `
          <div class="comment-item">
            <strong>${newComment.author}</strong>: ${newComment.content}
            <small style="color:#ccc;float:right;">${newComment.createdAt.toLocaleString()}</small>
          </div>
        `;
        
        // æ·»åŠ åˆ°è¯„è®ºåˆ—è¡¨çš„å¼€å¤´
        commentListElement.insertAdjacentHTML('afterbegin', newCommentHTML);
      }
    }

    function toggleComments(postId) {
      const comments = document.getElementById('comments-' + postId);
      comments.classList.toggle('show');
      
      // å¦‚æœè¯„è®ºåŒºåŸŸç°åœ¨æ˜¯æ˜¾ç¤ºçŠ¶æ€
      if (comments.classList.contains('show')) {
        // å¦‚æœè¯„è®ºåŒºåŸŸæ˜¯ç©ºçš„ï¼ŒåŠ¨æ€æ¸²æŸ“è¯„è®ºè¾“å…¥æ¡†å’Œè¯„è®ºåˆ—è¡¨
        if (comments.innerHTML.trim() === '') {
          comments.innerHTML = `
            <div class="comment-input">
              <textarea id="comment-input-${postId}" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." onclick="event.stopPropagation();" onfocus="event.stopPropagation();"></textarea>
              <div style="position: relative; display: inline-block;">
                <button class="emoji-btn" onclick="event.stopPropagation(); toggleEmojiPicker('${postId}')">ğŸ˜Š</button>
                <div class="emoji-picker" id="emoji-picker-${postId}">
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ˜Š')">ğŸ˜Š</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ˜‚')">ğŸ˜‚</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ˜')">ğŸ˜</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ¤”')">ğŸ¤”</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ‘')">ğŸ‘</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'â¤ï¸')">â¤ï¸</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ‰')">ğŸ‰</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ˜¢')">ğŸ˜¢</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ˜†')">ğŸ˜†</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ˜˜')">ğŸ˜˜</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ˜')">ğŸ˜</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ˜‰')">ğŸ˜‰</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ˜')">ğŸ˜</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ˜´')">ğŸ˜´</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ˜­')">ğŸ˜­</div>
                  <div class="emoji-item" onclick="event.stopPropagation(); insertEmoji('${postId}', 'ğŸ¤£')">ğŸ¤£</div>
                </div>
              </div>
              <button onclick="event.stopPropagation(); sendComment('${postId}')">å‘é€</button>
            </div>
            <div id="comment-list-${postId}">åŠ è½½ä¸­...</div>
          `;
        }
        
        // åŠ è½½è¯„è®ºåˆ—è¡¨
        loadComments(postId);
      }
    }

    async function send() {
      const content = document.getElementById('content').value.trim();
      if (!content) return alert('å†™ç‚¹ä¸œè¥¿å†å‘å“¦ï½');

      await fetch('/api/posts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ content, author: nickname, isAnonymous: false })
      });

      document.getElementById('content').value = '';
      alert('å·²å‘é€ï¼Œè€å¸ˆå®¡æ ¸åå°±ä¼šæ˜¾ç¤ºï½');
      loadPosts();
    }

    // åˆå§‹åŠ è½½
    loadPosts();
    
    // ç›‘å¬æ–°å¸–å­ï¼Œä½†ä¸è‡ªåŠ¨åˆ·æ–°æ•´ä¸ªé¡µé¢
    let lastPostCount = 0;
    async function checkForNewPosts() {
      try {
        // ä½¿ç”¨æ–°çš„/totalç«¯ç‚¹åªè·å–å¸–å­æ€»æ•°ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“
        const res = await fetch('/api/posts/total');
        const data = await res.json();
        if (data.total > lastPostCount && lastPostCount !== 0) {
          // åªåœ¨æœ‰æ–°å¸–å­æ—¶é€šçŸ¥ç”¨æˆ·ï¼Œè€Œä¸æ˜¯è‡ªåŠ¨åˆ·æ–°
          const newPosts = data.total - lastPostCount;
          const notice = document.createElement('div');
          notice.style.cssText = 'position:fixed;top:20px;right:20px;background:#80cbc4;color:white;padding:15px;border-radius:10px;cursor:pointer;z-index:1000;';
          notice.innerHTML = `æœ‰ ${newPosts} æ¡æ–°å¸–å­ï¼Œ<span style="text-decoration:underline;">ç‚¹å‡»åˆ·æ–°</span>`;
          notice.onclick = () => {
            loadPosts();
            document.body.removeChild(notice);
          };
          document.body.appendChild(notice);
          // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
          setTimeout(() => {
            if (document.body.contains(notice)) {
              document.body.removeChild(notice);
            }
          }, 3000);
        }
        lastPostCount = data.total;
      } catch (err) {
        console.log('æ£€æŸ¥æ–°å¸–å­å¤±è´¥', err);
      }
    }
    
    // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ–°å¸–å­
    setInterval(checkForNewPosts, 30000);
  </script>
</body>
</html>